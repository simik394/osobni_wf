version: "3.8"

services:
  chromium:
    build: ./browser
    ports:
      - "5902:5900"  # VNC (changed from 5900 to avoid conflict with local x11vnc)
      - "3005:3000"
      - "9225:9223" # CDP port (changed from 9223 to avoid conflict with angrav-browser)
    ipc: host
    volumes:
      - ${HOME}/.config/rsrch/user-data:/app/user-data
    environment:
      - USER_DATA_DIR=/app/user-data
    restart: unless-stopped

  perplexity-server:
    build:
      context: ..
      dockerfile: rsrch/Dockerfile
    image: perplexity-researcher:latest
    container_name: perplexity-server
    ports:
      - "${PORT:-3001}:${PORT:-3001}"
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ${HOME}/.config/rsrch:/app/config
    environment:
      - PORT=${PORT:-3001}
      - WINDMILL_TOKEN=${WINDMILL_TOKEN}
      - BROWSER_CDP_ENDPOINT=http://chromium:9223
      - PERPLEXITY_USER_DATA_DIR=/app/config/user-data
      - AUTH_FILE=/app/config/auth.json
      - FALKORDB_HOST=falkordb
    depends_on:
      - chromium
      - falkordb
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: npm run serve
    restart: unless-stopped

  falkordb:
    image: falkordb/falkordb:latest
    container_name: falkordb
    ports:
      - "6379:6379"
    volumes:
      - ./data/falkordb:/data
    restart: unless-stopped
