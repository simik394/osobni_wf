version: '3.8'

services:
  chromium:
    build: ./browser
    ports:
      - "5900:5900"
      - "3002:3000"
      - "9223:9223"  # CDP port (socat proxy)
    ipc: host
    volumes:
      - ${HOME}/.config/rsrch/user-data:/app/user-data
    environment:
      - USER_DATA_DIR=/app/user-data
    restart: unless-stopped

  perplexity-server:
    build: .
    image: perplexity-researcher:latest
    container_name: perplexity-server
    ports:
      - "${PORT:-3001}:${PORT:-3001}"
    volumes:
      - ./data:/app/data
      - ./src:/app/src
      - ${HOME}/.config/rsrch:/app/config
    environment:
      - PORT=${PORT:-3001}
      - BROWSER_CDP_ENDPOINT=http://chromium:9223
      - PERPLEXITY_USER_DATA_DIR=/app/config/user-data
      - AUTH_FILE=/app/config/auth.json
    command: npm run serve
    depends_on:
      - chromium
    restart: unless-stopped


