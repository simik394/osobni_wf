---
title: "Detailed Test & Implementation Report"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    theme: cosmo
    page-layout: full
---

Generated on: 2026-01-24T17:18:41.099Z

## ğŸ“Š Test Results Summary

> **Last Run:** 1/24/2026, 6:06:57 PM

| Status | Count |
|--------|-------|
| âœ… Passed | 93 |
| âŒ Failed | 2 |
| â­ï¸ Skipped | 17 |
| **Total** | **112** |

## ğŸ“ˆ Source Component Coverage
| Component | LOC | Test File | Scenarios | Assertions | Status |
|---|---|---|---|---|---|
| `gemini-client.ts` | 2869 | `gemini-client.test.ts` | 21 | 36 | ğŸŸ¢ Strong |
| `graph-store.ts` | 1355 | `graph-store.test.ts` | 0 | 17 | ğŸŸ¢ Strong |
| `commands/gemini.ts` | 1005 | `e2e/gemini.test.ts` | 2 | 6 | ğŸŸ¡ Basic |
| `selectors.ts` | 328 | `selectors.test.ts` | 5 | 15 | ğŸŸ¢ Strong |
| `commands/graph.ts` | 266 | `graph.test.ts` | 1 | 1 | ğŸŸ¡ Basic |
| `artifact-registry.ts` | 237 | `artifact-registry.test.ts` | 7 | 24 | ğŸŸ¢ Strong |
| `types/graph-store.ts` | 97 | `graph-store.test.ts` | 0 | 17 | ğŸŸ¢ Strong |
| `clients/windmill.ts` | 76 | `windmill.test.ts` | 4 | 11 | ğŸŸ¢ Strong |

## ğŸ§ª Detailed Test Scenarios

### ğŸ“ `gemini-client.test.ts` <small>(Unit/Mapped)</small>

#### ğŸ§ª "should be defined"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.43ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;GeminiClient#41;.toBeDefined#40;#41;;"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-be-defined` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=109 end-line=115}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should be defined" --reporter=verbose
```

:::

#### ğŸ§ª "should navigate to the base URL if no session ID is provided"

::: {.callout-tip appearance="simple"}
**âœ… Passed (14.69ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await client.init#40;#41;;"]
    V1["Verify:<br/>expect#40;mockPage.goto#41;.toHaveBeenCalledWith#40;'https:/..."]
    A0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-navigate-to-the-base-url-if-no-session-id-i` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=119 end-line=125}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should navigate to the base URL if no session ID is provided" --reporter=verbose
```

:::

#### ğŸ§ª "should navigate to the specific session URL if an ID is provided"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.71ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await client.init#40;'test-session-id'#41;;"]
    V1["Verify:<br/>expect#40;mockPage.goto#41;.toHaveBeenCalledWith#40;'https:/..."]
    A0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-navigate-to-the-specific-session-url-if-an-` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=127 end-line=134}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should navigate to the specific session URL if an ID is provided" --reporter=verbose
```

:::

#### ğŸ§ª "should handle and click cookie consent button"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.30ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockCookieButton = createMockLocator#40;true#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'Accept all'#41;#41; {"]
    S2["Setup:<br/>return mockCookieButton;"]
    A3["Act:<br/>}<br/>return createMockLocator#40;false#41;; // Hide other buttons<br/>}#41;;<br/>await client.init#40;#41;;"]
    V4["Verify:<br/>expect#40;mockCookieButton.click#41;.toHaveBeenCalled#40;#41"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-and-click-cookie-consent-button` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=136 end-line=151}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should handle and click cookie consent button" --reporter=verbose
```

:::

#### ğŸ§ª "should handle and click dismiss buttons for popups"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.14ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockDismissButton = createMockLocator#40;true#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'No thanks'#41;#41; {"]
    S2["Setup:<br/>return mockDismissButton;"]
    A3["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;<br/>await client.init#40;#41;;"]
    V4["Verify:<br/>expect#40;mockDismissButton.click#41;.toHaveBeenCalled#40;#4"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-and-click-dismiss-buttons-for-popups` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=153 end-line=168}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should handle and click dismiss buttons for popups" --reporter=verbose
```

:::

#### ğŸ§ª "should throw an error if a sign-in button is detected"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.04ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'Sign in'#41;#41; {<br/>return createMockLocator#40;true#41;;<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;<br/>await expect#40;client.init#40;#41;#41;.rejects.toThrow#40;'..."]
    V2["Verify:<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'gemi..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-throw-an-error-if-a-sign-in-button-is-detec` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=170 end-line=185}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should throw an error if a sign-in button is detected" --reporter=verbose
```

:::

#### ğŸ§ª "should wait for the chat interface to be ready"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.53ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await client.init#40;#41;;"]
    V1["Verify:<br/>expect#40;mockPage.waitForSelector#41;.toHaveBeenCalledWith#"]
    A2["Act:<br/>'chat-app, .input-area, textarea, div#91;contenteditable='tr...<br/>{ timeout: 15000 }<br/>#41;;"]
    A0 --> V1
    V1 --> A2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-wait-for-the-chat-interface-to-be-ready` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=187 end-line=197}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should wait for the chat interface to be ready" --reporter=verbose
```

:::

#### ğŸ§ª "should throw an error if chat interface is not found"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.83ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.waitForSelector.mockRejectedValue#40;new Error#40;'...<br/>mockPage.locator.mockImplementation#40;#40;#41; =#62; create..."]
    A1["Act:<br/>await expect#40;client.init#40;#41;#41;.rejects.toThrow#40;'"]
    V2["Verify:<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'gemi..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-throw-an-error-if-chat-interface-is-not-fou` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=199 end-line=210}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should throw an error if chat interface is not found" --reporter=verbose
```

:::

#### ğŸ§ª "should fill the input, press Enter, and wait for a response"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.78ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const message = 'Hello, Gemini!';<br/>const mockInput = createMockLocator#40;true#41;;<br/>const mockResponse = createMockLocator#40;true, 'Response te...<br/>mockResponse.last = vi.fn#40;#41;.mockReturnThis#40;#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'div#91;contenteditable='true'#9"]
    S2["Setup:<br/>return mockInput;"]
    A3["Act:<br/>}<br/>if #40;selector.includes#40;'model-response'#41;#41; {"]
    S4["Setup:<br/>return mockResponse;"]
    A5["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;"]
    S6["Setup:<br/>const response = await client.sendMessage#40;message#41;;"]
    V7["Verify:<br/>expect#40;mockInput.fill#41;.toHaveBeenCalledWith#40;message<br/>expect#40;mockInput.press#41;.toHaveBeenCalledWith#40;'Enter<br/>expect#40;response#41;.toBe#40;'Response text'#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-fill-the-input-press-enter-and-wait-for-a-r` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=215 end-line=239}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should fill the input, press Enter, and wait for a response" --reporter=verbose
```

:::

#### ğŸ§ª "should return null if waitForResponse is false"

::: {.callout-important appearance="simple"}
**âŒ Failed (19.52ms)**

```
AssertionError: expected 'This is a response.' to be null
    at /home/sim/Obsi/Prods/01-pwf/agents/rsrch/tests/gemini-client.test.ts:208:30
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at file:///home/sim/.npm/_npx/69c381f8ad94b576/node_modules/@vitest/runner/dist/
```
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const message = 'Fire and forget';<br/>const response = await client.sendMessage#40;message, false#"]
    V1["Verify:<br/>expect#40;response#41;.toBeNull#40;#41;;<br/>expect#40;mockPage.waitForTimeout#41;.toHaveBeenCalledTimes#"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-return-null-if-waitforresponse-is-false` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=241 end-line=251}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should return null if waitForResponse is false" --reporter=verbose
```

:::

#### ğŸ§ª "should return null and log an error if sending fails"

::: {.callout-tip appearance="simple"}
**âœ… Passed (8.35ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const message = 'This will fail';<br/>const mockInput = createMockLocator#40;true#41;;<br/>mockInput.press.mockRejectedValue#40;new Error#40;'Send fail...<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'div#91;contenteditable='true'#9"]
    S2["Setup:<br/>return mockInput;"]
    A3["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;"]
    S4["Setup:<br/>const response = await client.sendMessage#40;message#41;;"]
    V5["Verify:<br/>expect#40;response#41;.toBeNull#40;#41;;<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'send..."]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-return-null-and-log-an-error-if-sending-fai` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=253 end-line=273}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should return null and log an error if sending fails" --reporter=verbose
```

:::

#### ğŸ§ª "should handle response stabilization"

::: {.callout-important appearance="simple"}
**âŒ Failed (4.38ms)**

```
Error: Gemini requires authentication.
    at GeminiClient.checkAuth (/home/sim/Obsi/Prods/01-pwf/agents/rsrch/src/gemini-client.ts:239:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at GeminiClient.sendMessage (/home/sim/Obsi/Prods/01-pwf/agents/rsrch/src/gemini-
```
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockInput = createMockLocator#40;true#41;;<br/>const mockResponse = createMockLocator#40;true, 'Initial res...<br/>mockResponse.last = vi.fn#40;#41;.mockReturnThis#40;#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62<br/>if #40;selector.includes#40;'div#91;contenteditable='true'#9...<br/>if #40;selector.includes#40;'model-response'#41;#41; return ..."]
    A1["Act:<br/>return createMockLocator#40;true#41;;<br/>}#41;;"]
    S2["Setup:<br/>mockResponse.innerText<br/>.mockResolvedValueOnce#40;'Initial response'#41;<br/>.mockResolvedValueOnce#40;'Initial response, more text'#41;<br/>.mockResolvedValueOnce#40;'Initial response, more text'#41; ...<br/>.mockResolvedValueOnce#40;'Initial response, more text'#41;;..."]
    A3["Act:<br/>await client.sendMessage#40;'test'#41;;"]
    V4["Verify:<br/>expect#40;mockPage.waitForTimeout#41;.toHaveBeenCalled#40;#4"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-response-stabilization` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=275 end-line=302}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should handle response stabilization" --reporter=verbose
```

:::

#### ğŸ§ª "getResponses should return an array of all response texts"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.57ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockResponses = {<br/>count: vi.fn#40;#41;.mockResolvedValue#40;3#41;,"]
    A1["Act:<br/>nth: vi.fn#40;#40;i#41; =#62; {<br/>if #40;i === 0#41; return createMockLocator#40;true, 'Respon<br/>if #40;i === 1#41; return createMockLocator#40;true, 'Respon<br/>if #40;i === 2#41; return createMockLocator#40;true, 'Respon<br/>return createMockLocator#40;false#41;;<br/>}#41;,<br/>};"]
    S2["Setup:<br/>mockPage.locator.mockReturnValue#40;mockResponses#41;;<br/>const responses = await client.getResponses#40;#41;;"]
    V3["Verify:<br/>expect#40;responses#41;.toEqual#40;#91;'Response 1', 'Respon...<br/>expect#40;mockResponses.nth#41;.toHaveBeenCalledTimes#40;3#4"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:getresponses-should-return-an-array-of-all-respons` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=307 end-line=325}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getResponses should return an array of all response texts" --reporter=verbose
```

:::

#### ğŸ§ª "getLatestResponse should return the text of the last response"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.00ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockResponses = {<br/>count: vi.fn#40;#41;.mockResolvedValue#40;2#41;,<br/>nth: vi.fn#40;#41;.mockReturnThis#40;#41;,<br/>innerText: vi.fn#40;#41;.mockResolvedValue#40;'This is the l..."]
    A1["Act:<br/>};"]
    S2["Setup:<br/>mockPage.locator.mockImplementation#40;selector =#62; {"]
    A3["Act:<br/>if #40;selector.includes#40;'model-response'#41;#41; {"]
    S4["Setup:<br/>return mockResponses;"]
    A5["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;"]
    S6["Setup:<br/>const latest = await client.getLatestResponse#40;#41;;"]
    V7["Verify:<br/>expect#40;latest#41;.toBe#40;'This is the last one'#41;;<br/>expect#40;mockResponses.nth#41;.toHaveBeenCalledWith#40;1#41"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:getlatestresponse-should-return-the-text-of-the-la` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=327 end-line=348}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getLatestResponse should return the text of the last response" --reporter=verbose
```

:::

#### ğŸ§ª "getLatestResponse should return null if no responses are found"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.64ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockReturnValue#40;createMockLocator#40;fal<br/>const latest = await client.getLatestResponse#40;#41;;"]
    V1["Verify:<br/>expect#40;latest#41;.toBeNull#40;#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:getlatestresponse-should-return-null-if-no-respons` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=350 end-line=359}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getLatestResponse should return null if no responses are found" --reporter=verbose
```

:::

#### ğŸ§ª "getResponse should retrieve responses by positive and negative index"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3.56ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockResponses = {<br/>count: vi.fn#40;#41;.mockResolvedValue#40;3#41;,"]
    A1["Act:<br/>nth: vi.fn#40;#40;i#41; =#62; {<br/>if #40;i === 0#41; return createMockLocator#40;true, 'First'<br/>if #40;i === 1#41; return createMockLocator#40;true, 'Second<br/>if #40;i === 2#41; return createMockLocator#40;true, 'Third'<br/>return createMockLocator#40;false#41;;<br/>}#41;,<br/>};"]
    S2["Setup:<br/>mockPage.locator.mockReturnValue#40;mockResponses#41;;"]
    V3["Verify:<br/>expect#40;await client.getResponse#40;1#41;#41;.toBe#40;'Fir<br/>expect#40;await client.getResponse#40;3#41;#41;.toBe#40;'Thi<br/>expect#40;await client.getResponse#40;-1#41;#41;.toBe#40;'Th<br/>expect#40;await client.getResponse#40;-3#41;#41;.toBe#40;'Fi<br/>expect#40;await client.getResponse#40;4#41;#41;.toBeNull#40;<br/>expect#40;await client.getResponse#40;-4#41;#41;.toBeNull#40"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:getresponse-should-retrieve-responses-by-positive-` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=361 end-line=388}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getResponse should retrieve responses by positive and negative index" --reporter=verbose
```

:::

#### ğŸ§ª "listSessions should return an empty array on failure"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3.12ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;#41; =#62; {"]
    A1["Act:<br/>throw new Error#40;'Failed to find session list'#41;;<br/>}#41;;"]
    S2["Setup:<br/>const sessions = await client.listSessions#40;#41;;"]
    V3["Verify:<br/>expect#40;sessions#41;.toEqual#40;#91;#93;#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:listsessions-should-return-an-empty-array-on-failu` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=393 end-line=402}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "listSessions should return an empty array on failure" --reporter=verbose
```

:::

#### ğŸ§ª "getLatestResponse should return null on failure"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.20ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;#41; =#62; {<br/>const locator = createMockLocator#40;true#41;;<br/>locator.innerText.mockRejectedValue#40;new Error#40;'Cannot ..."]
    A1["Act:<br/>return locator;<br/>}#41;;"]
    S2["Setup:<br/>const response = await client.getLatestResponse#40;#41;;"]
    V3["Verify:<br/>expect#40;response#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:getlatestresponse-should-return-null-on-failure` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=404 end-line=416}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getLatestResponse should return null on failure" --reporter=verbose
```

:::

#### ğŸ§ª "exportToGoogleDocs should return null values on failure"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3.26ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'Export menu'#41; #124;#124; sel...<br/>return createMockLocator#40;false#41;;<br/>}<br/>return createMockLocator#40;true#41;;<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.exportCurrentToGoogleDocs#40;#41"]
    V3["Verify:<br/>expect#40;result#41;.toEqual#40;{ docId: null, docUrl: null,...<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'expo..."]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:exporttogoogledocs-should-return-null-values-on-fa` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=418 end-line=434}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "exportToGoogleDocs should return null values on failure" --reporter=verbose
```

:::

#### ğŸ§ª "listSessions should scroll to load more sessions if initial count is less than target"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3.27ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>let callCount = 0;<br/>const mockSessionLocator = {"]
    A1["Act:<br/>...createMockLocator#40;true, 'Session'#41;,<br/>count: vi.fn#40;#40;#41; =#62; {<br/>callCount++;<br/>return Promise.resolve#40;callCount === 1 ? 10 : 20#41;;<br/>}#41;,"]
    S2["Setup:<br/>last: vi.fn#40;#41;.mockReturnThis#40;#41;,<br/>scrollIntoViewIfNeeded: vi.fn#40;#41;.mockResolvedValue#40;u..."]
    A3["Act:<br/>};"]
    S4["Setup:<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A5["Act:<br/>if #40;selector.includes#40;'div.conversation'#41;#41; {"]
    S6["Setup:<br/>return mockSessionLocator;"]
    A7["Act:<br/>}<br/>if #40;selector.includes#40;'Show more'#41;#41; {<br/>return createMockLocator#40;false#41;;<br/>}<br/>return createMockLocator#40;true#41;;<br/>}#41;;<br/>await client.listSessions#40;20, 0#41;;"]
    V8["Verify:<br/>expect#40;mockSessionLocator.scrollIntoViewIfNeeded#41;.toHa...<br/>expect#40;mockSessionLocator.count#41;.toHaveBeenCalledTimes"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> A7
    A7 --> V8

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:listsessions-should-scroll-to-load-more-sessions-i` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=439 end-line=468}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "listSessions should scroll to load more sessions if initial count is less than target" --reporter=verbose
```

:::

#### ğŸ§ª "listSessions should click "Show more" button if visible"

::: {.callout-tip appearance="simple"}
**âœ… Passed (6.23ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockSessionLocator = createMockLocator#40;true, 'Sessi...<br/>mockSessionLocator.count.mockResolvedValue#40;5#41;;<br/>const mockShowMoreButton = createMockLocator#40;true#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'div.conversation'#41;#41; {"]
    S2["Setup:<br/>return mockSessionLocator;"]
    A3["Act:<br/>}<br/>if #40;selector.includes#40;'Show more'#41; #124;#124; selec..."]
    S4["Setup:<br/>return mockShowMoreButton;"]
    A5["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;<br/>await client.listSessions#40;10, 0#41;;"]
    V6["Verify:<br/>expect#40;mockShowMoreButton.click#41;.toHaveBeenCalled#40;#"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> V6

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:listsessions-should-click-show-more-button-if-visi` in [`tests/gemini-client.test.ts`](tests/gemini-client.test.ts)

```{.typescript include="tests/gemini-client.test.ts" start-line=470 end-line=492}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "listSessions should click \"Show more\" button if visible" --reporter=verbose
```

:::

---

### ğŸ“ `e2e/gemini.test.ts` <small>(Unit/Mapped)</small>

#### ğŸ§ª "should navigate to Gemini and verify login status"

::: {.callout-warning appearance="simple"}
**â­ï¸ skipped**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await page.goto#40;'https://gemini.google.com/app', { waitUn...<br/>await page.waitForTimeout#40;2000#41;;"]
    S1["Setup:<br/>const url = page.url#40;#41;;<br/>const isLoginPage = url.includes#40;'accounts.google.com'#41"]
    A2["Act:<br/>await page.screenshot#40;{ path: path.join#40;SNAPSHOT_DIR, ...<br/>if #40;isLoginPage#41; {<br/>console.warn#40;'Browser is not logged in. Skipping function...<br/>}"]
    V3["Verify:<br/>expect#40;isLoginPage, 'Should be logged in to Gemini'#41;.t..."]
    A0 --> S1
    S1 --> A2
    A2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-navigate-to-gemini-and-verify-login-status` in [`tests/e2e/gemini.test.ts`](tests/e2e/gemini.test.ts)

```{.typescript include="tests/e2e/gemini.test.ts" start-line=45 end-line=64}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/e2e/gemini.test.ts -t "should navigate to Gemini and verify login status" --reporter=verbose
```

:::

#### ğŸ§ª "should parse an existing research session"

::: {.callout-warning appearance="simple"}
**â­ï¸ skipped**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>if #40;page.url#40;#41;.includes#40;'accounts.google.com'#41"]
    S1["Setup:<br/>const targetSessionId = process.env.TEST_SESSION_ID;"]
    A2["Act:<br/>if #40;targetSessionId#41; {<br/>console.log#40;'Navigating to target session: ${targetSessio..."]
    S3["Setup:<br/>const parsed = await gemini.parseResearch#40;targetSessionId"]
    V4["Verify:<br/>expect#40;parsed#41;.toBeDefined#40;#41;;<br/>expect#40;parsed?.title#41;.toBeTruthy#40;#41;;<br/>expect#40;parsed?.content.length#41;.toBeGreaterThan#40;0#41"]
    A5["Act:<br/>} else {<br/>console.log#40;'Searching for a research session in sidebar...."]
    S6["Setup:<br/>const menuBtn = page.locator#40;'button#91;aria-label*='Hlav..."]
    A7["Act:<br/>if #40;await menuBtn.count#40;#41; #62; 0 #38;#38; await men...<br/>await menuBtn.click#40;#41;;<br/>await page.waitForTimeout#40;1000#41;;<br/>}"]
    S8["Setup:<br/>const chatItems = page.locator#40;'a#91;href*='/app/'#93;, ....<br/>const count = await chatItems.count#40;#41;;<br/>let researchSessionFound = false;<br/>for #40;let i = 0; i #60; Math.min#40;count, 10#41;; i++#41;<br/>const item = chatItems.nth#40;i#41;;<br/>const text = await item.textContent#40;#41;;"]
    A9["Act:<br/>if #40;text #38;#38; #40;text.includes#40;'Deep'#41; #124;#1...<br/>console.log#40;'Found candidate session: ${text}'#41;;<br/>await item.click#40;#41;;<br/>await page.waitForTimeout#40;3000#41;;"]
    S10["Setup:<br/>const parsed = await gemini.parseResearch#40;#41;;"]
    A11["Act:<br/>if #40;parsed#41; {<br/>researchSessionFound = true;"]
    V12["Verify:<br/>expect#40;parsed.title#41;.toBeTruthy#40;#41;;<br/>expect#40;parsed.headings.length#41;.toBeGreaterThanOrEqual#"]
    A13["Act:<br/>break;<br/>}<br/>}<br/>}<br/>if #40;!researchSessionFound#41; {<br/>console.warn#40;'No specific research session found in top 1..."]
    S14["Setup:<br/>const parsed = await gemini.parseResearch#40;#41;;"]
    A15["Act:<br/>}<br/>}"]
    A0 --> S1
    S1 --> A2
    A2 --> S3
    S3 --> V4
    V4 --> A5
    A5 --> S6
    S6 --> A7
    A7 --> S8
    S8 --> A9
    A9 --> S10
    S10 --> A11
    A11 --> V12
    V12 --> A13
    A13 --> S14
    S14 --> A15

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-parse-an-existing-research-session` in [`tests/e2e/gemini.test.ts`](tests/e2e/gemini.test.ts)

```{.typescript include="tests/e2e/gemini.test.ts" start-line=66 end-line=128}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/e2e/gemini.test.ts -t "should parse an existing research session" --reporter=verbose
```

:::

---

### ğŸ“ `selectors.test.ts` <small>(Unit/Mapped)</small>

#### ğŸ§ª "should return default selectors when selectors.yaml does not exist"

::: {.callout-tip appearance="simple"}
**âœ… Passed (5.12ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;false#41;;<br/>const result = reloadSelectors#40;#41;;"]
    V1["Verify:<br/>expect#40;result.home.createNewButton#41;.toBe#40;'.create-n...<br/>expect#40;result.notebook.titleInput#41;.toBe#40;'input.titl...<br/>expect#40;fs.existsSync#41;.toHaveBeenCalled#40;#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-return-default-selectors-when-selectors-yam` in [`tests/selectors.test.ts`](tests/selectors.test.ts)

```{.typescript include="tests/selectors.test.ts" start-line=34 end-line=49}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should return default selectors when selectors.yaml does not exist" --reporter=verbose
```

:::

#### ğŸ§ª "should load and merge selectors from selectors.yaml when it exists"

::: {.callout-tip appearance="simple"}
**âœ… Passed (11.59ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;true#41;;<br/>const mockYamlContent = '"]
    A1["Act:<br/>home:<br/>createNewButton: '.custom-new-button'<br/>projectButton: 'custom-project-button'<br/>projectButtonTitle: '.custom-title'<br/>projectCard: 'custom-card'<br/>primaryActionButton: '.custom-action'<br/>notebook:<br/>titleInput: '.custom-title-input'<br/>urlPattern: '**/custom/**'<br/>';"]
    S2["Setup:<br/>vi.mocked#40;fs.readFileSync#41;.mockReturnValue#40;mockYaml<br/>const result = reloadSelectors#40;#41;;"]
    V3["Verify:<br/>expect#40;result.home.createNewButton#41;.toBe#40;'.custom-n...<br/>expect#40;result.notebook.titleInput#41;.toBe#40;'.custom-ti...<br/>expect#40;result.sources.tab#41;.toBe#40;'div#91;role='tab'#"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-load-and-merge-selectors-from-selectors-yam` in [`tests/selectors.test.ts`](tests/selectors.test.ts)

```{.typescript include="tests/selectors.test.ts" start-line=51 end-line=80}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should load and merge selectors from selectors.yaml when it exists" --reporter=verbose
```

:::

#### ğŸ§ª "should fall back to defaults when loading fails (e.g. read error)"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.40ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;true#41;;<br/>vi.mocked#40;fs.readFileSync#41;.mockImplementation#40;#40;#"]
    A1["Act:<br/>throw new Error#40;'Read failed'#41;;<br/>}#41;;"]
    S2["Setup:<br/>const consoleSpy = vi.spyOn#40;console, 'error'#41;.mockImpl...<br/>const result = reloadSelectors#40;#41;;"]
    V3["Verify:<br/>expect#40;result.home.createNewButton#41;.toBe#40;'.create-n...<br/>expect#40;consoleSpy#41;.toHaveBeenCalled#40;#41;;"]
    S4["Setup:<br/>consoleSpy.mockRestore#40;#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> S4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-fall-back-to-defaults-when-loading-fails-e-` in [`tests/selectors.test.ts`](tests/selectors.test.ts)

```{.typescript include="tests/selectors.test.ts" start-line=82 end-line=103}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should fall back to defaults when loading fails (e.g. read error)" --reporter=verbose
```

:::

#### ğŸ§ª "should force reload of selectors and invalidate cache"

::: {.callout-tip appearance="simple"}
**âœ… Passed (6.72ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;true#41;;<br/>let callCount = 0;<br/>vi.mocked#40;fs.readFileSync#41;.mockImplementation#40;#40;#"]
    A1["Act:<br/>callCount++;<br/>return '<br/>home:<br/>createNewButton: '.button-${callCount}'<br/>projectButton: 'b'<br/>projectButtonTitle: 'c'<br/>projectCard: 'd'<br/>primaryActionButton: 'e'<br/>';<br/>}#41;;"]
    S2["Setup:<br/>const first = reloadSelectors#40;#41;;"]
    V3["Verify:<br/>expect#40;first.home.createNewButton#41;.toBe#40;'.button-1'<br/>expect#40;callCount#41;.toBe#40;1#41;;"]
    S4["Setup:<br/>const second = loadSelectors#40;#41;;"]
    V5["Verify:<br/>expect#40;second.home.createNewButton#41;.toBe#40;'.button-1<br/>expect#40;callCount#41;.toBe#40;1#41;;"]
    S6["Setup:<br/>const third = reloadSelectors#40;#41;;"]
    V7["Verify:<br/>expect#40;third.home.createNewButton#41;.toBe#40;'.button-2'<br/>expect#40;callCount#41;.toBe#40;2#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> S4
    S4 --> V5
    V5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-force-reload-of-selectors-and-invalidate-ca` in [`tests/selectors.test.ts`](tests/selectors.test.ts)

```{.typescript include="tests/selectors.test.ts" start-line=108 end-line=142}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should force reload of selectors and invalidate cache" --reporter=verbose
```

:::

#### ğŸ§ª "should trigger loadSelectors when accessing a property"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.79ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const homeSelectors = selectors.home;"]
    V1["Verify:<br/>expect#40;homeSelectors.createNewButton#41;.toBe#40;'.create..."]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-trigger-loadselectors-when-accessing-a-prop` in [`tests/selectors.test.ts`](tests/selectors.test.ts)

```{.typescript include="tests/selectors.test.ts" start-line=147 end-line=157}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should trigger loadSelectors when accessing a property" --reporter=verbose
```

:::

---

### ğŸ“ `graph.test.ts` <small>(Unit/Mapped)</small>

#### ğŸ§ª "should be tested in graph-store.test.ts"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.83ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;true#41;.toBe#40;true#41;;"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-be-tested-in-graph-store-test-ts` in [`tests/graph.test.ts`](tests/graph.test.ts)

```{.typescript include="tests/graph.test.ts" start-line=38 end-line=45}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/graph.test.ts -t "should be tested in graph-store.test.ts" --reporter=verbose
```

:::

---

### ğŸ“ `artifact-registry.test.ts` <small>(Unit/Mapped)</small>

#### ğŸ§ª "should generate unique 3-character base IDs"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.88ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const ids = new Set#60;string#62;#40;#41;;<br/>for #40;let i = 0; i #60; 100; i++#41; {"]
    A1["Act:<br/>ids.add#40;registry.generateBaseId#40;#41;#41;;<br/>}"]
    V2["Verify:<br/>expect#40;ids.size#41;.toBe#40;100#41;;<br/>expect#40;#91;...ids#93;#91;0#93;.length#41;.toBe#40;3#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-generate-unique-3-character-base-ids` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=31 end-line=42}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should generate unique 3-character base IDs" --reporter=verbose
```

:::

#### ğŸ§ª "should register and retrieve a session"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.41ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'gemini-sessio..."]
    V1["Verify:<br/>expect#40;sessionId.length#41;.toBe#40;3#41;;"]
    S2["Setup:<br/>const session = registry.get#40;sessionId#41;;"]
    V3["Verify:<br/>expect#40;session#41;.toBeDefined#40;#41;;<br/>expect#40;session?.type#41;.toBe#40;'session'#41;;<br/>expect#40;session?.query#41;.toBe#40;'History of Espresso'#4"]
    S0 --> V1
    V1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-register-and-retrieve-a-session` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=44 end-line=56}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should register and retrieve a session" --reporter=verbose
```

:::

#### ğŸ§ª "should register and retrieve a document"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.86ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Q1'#41;<br/>const docId = registry.registerDocument#40;sessionId, 'gdoc-..."]
    V1["Verify:<br/>expect#40;docId#41;.toMatch#40;/^#91;A-Z0-9#93;{3}-\d{2}$/#4<br/>expect#40;docId.startsWith#40;sessionId#41;#41;.toBe#40;true"]
    S2["Setup:<br/>const doc = registry.get#40;docId#41;;"]
    V3["Verify:<br/>expect#40;doc#41;.toBeDefined#40;#41;;<br/>expect#40;doc?.type#41;.toBe#40;'document'#41;;<br/>expect#40;doc?.parentId#41;.toBe#40;sessionId#41;;"]
    S0 --> V1
    V1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-register-and-retrieve-a-document` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=58 end-line=73}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should register and retrieve a document" --reporter=verbose
```

:::

#### ğŸ§ª "should register and retrieve audio with incrementing suffixes"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.88ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Q1'#41;<br/>const docId = registry.registerDocument#40;sessionId, 'd1', ...<br/>const audioId1 = registry.registerAudio#40;docId, 'Notebook'...<br/>const audioId2 = registry.registerAudio#40;docId, 'Notebook'..."]
    V1["Verify:<br/>expect#40;audioId1#41;.toMatch#40;/^#91;A-Z0-9#93;{3}-\d{2}-<br/>expect#40;audioId2#41;.toMatch#40;/^#91;A-Z0-9#93;{3}-\d{2}-"]
    S2["Setup:<br/>const audio = registry.get#40;audioId1#41;;"]
    V3["Verify:<br/>expect#40;audio#41;.toBeDefined#40;#41;;<br/>expect#40;audio?.type#41;.toBe#40;'audio'#41;;"]
    S0 --> V1
    V1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-register-and-retrieve-audio-with-incrementi` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=75 end-line=92}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should register and retrieve audio with incrementing suffixes" --reporter=verbose
```

:::

#### ğŸ§ª "should track lineage correctly"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.92ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Q1'#41;<br/>const docId = registry.registerDocument#40;sessionId, 'd1', ...<br/>const audioId = registry.registerAudio#40;docId, 'N1', 'A1'#<br/>const lineage = registry.getLineage#40;audioId#41;;"]
    V1["Verify:<br/>expect#40;lineage.length#41;.toBe#40;3#41;;<br/>expect#40;lineage#91;0#93;.type#41;.toBe#40;'audio'#41;;<br/>expect#40;lineage#91;1#93;.type#41;.toBe#40;'document'#41;;<br/>expect#40;lineage#91;2#93;.type#41;.toBe#40;'session'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-track-lineage-correctly` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=94 end-line=108}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should track lineage correctly" --reporter=verbose
```

:::

#### ğŸ§ª "should persist data to disk"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.53ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Persist...<br/>const registry2 = new ArtifactRegistry#40;TEST_DIR#41;;"]
    A1["Act:<br/>registry2.load#40;#41;;"]
    S2["Setup:<br/>const session = registry2.get#40;sessionId#41;;"]
    V3["Verify:<br/>expect#40;session#41;.toBeDefined#40;#41;;<br/>expect#40;session?.query#41;.toBe#40;'Persist Test'#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-persist-data-to-disk` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=110 end-line=123}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should persist data to disk" --reporter=verbose
```

:::

#### ğŸ§ª "should list artifacts by type"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.61ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const s1 = registry.registerSession#40;'s1', 'Q1'#41;;"]
    A1["Act:<br/>registry.registerDocument#40;s1, 'd1', 'D1'#41;;<br/>registry.registerAudio#40;'s1-01', 'N1', 'A1'#41;;"]
    V2["Verify:<br/>expect#40;registry.listByType#40;'session'#41;.length#41;.to<br/>expect#40;registry.listByType#40;'document'#41;.length#41;.t<br/>expect#40;registry.listByType#40;'audio'#41;.length#41;.toBe"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-list-artifacts-by-type` in [`tests/artifact-registry.test.ts`](tests/artifact-registry.test.ts)

```{.typescript include="tests/artifact-registry.test.ts" start-line=125 end-line=137}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should list artifacts by type" --reporter=verbose
```

:::

---

### ğŸ“ `windmill.test.ts` <small>(Unit/Mapped)</small>

#### ğŸ§ª "should trigger audio generation and update graph state"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>server.use#40;<br/>http.post#40;'${RSRCH_URL}/graph/execute', async #40;{ reque..."]
    S1["Setup:<br/>const body = await request.json#40;#41;;"]
    A2["Act:<br/>if #40;body.query.includes#40;'CREATE #40;pa:PendingAudio'#4<br/>return HttpResponse.json#40;{ notebookId: 'notebook-123' }#4<br/>}<br/>return HttpResponse.json#40;{}#41;;<br/>}#41;,<br/>http.post#40;'${RSRCH_URL}/notebooklm/generate-audio', #40;#<br/>return HttpResponse.json#40;{ success: true }#41;;<br/>}#41;,<br/>http.post#40;'${NTFY_URL}/${NTFY_TOPIC}', #40;#41; =#62; {<br/>return new HttpResponse#40;null, { status: 200 }#41;;<br/>}#41;<br/>#41;;"]
    S3["Setup:<br/>const result = await clickGenerateAudio#40;{"]
    A4["Act:<br/>notebook_title: 'My Notebook',<br/>source_title: 'My Source',<br/>}#41;;"]
    V5["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.notebook_id#41;.toBe#40;'notebook-123'#41;;<br/>expect#40;result.source_title#41;.toBe#40;'My Source'#41;;<br/>expect#40;result.pending_audio_id#41;.toMatch#40;/^pending_a"]
    A0 --> S1
    S1 --> A2
    A2 --> S3
    S3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-trigger-audio-generation-and-update-graph-s` in [`tests/windmill.test.ts`](tests/windmill.test.ts)

```{.typescript include="tests/windmill.test.ts" start-line=26 end-line=56}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should trigger audio generation and update graph state" --reporter=verbose
```

:::

#### ğŸ§ª "should match a completed audio file and update the graph"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const pendingAudio = {"]
    A1["Act:<br/>id: 'pending-123',<br/>notebookId: 'notebook-123',<br/>sourceTitle: 'A very long source title that will be truncate...<br/>startedAt: Date.now#40;#41; - 10000,<br/>};"]
    S2["Setup:<br/>const completedAudio = {"]
    A3["Act:<br/>id: 'audio-456',<br/>title: 'Audio for 'A very long source title...'',<br/>sourceCount: 1,<br/>correlationId: pendingAudio.id,<br/>};<br/>server.use#40;<br/>http.post#40;'${RSRCH_URL}/graph/execute', async #40;{ reque..."]
    S4["Setup:<br/>const body = await request.json#40;#41;;"]
    A5["Act:<br/>if #40;body.query.includes#40;'MATCH #40;pa:PendingAudio'#41<br/>return HttpResponse.json#40;#91;<br/>#91;pendingAudio.id, pendingAudio.notebookId, pendingAudio.s...<br/>#93;#41;;<br/>}<br/>if #40;body.query.includes#40;'DETACH DELETE pa'#41;#41; {<br/>return HttpResponse.json#40;{ success: true }#41;;<br/>}<br/>return HttpResponse.json#40;{}#41;;<br/>}#41;,<br/>http.post#40;'${RSRCH_URL}/notebook/list', #40;#41; =#62; {<br/>return HttpResponse.json#40;{<br/>success: true,<br/>data: #91;{<br/>id: 'notebook-123',<br/>audioOverviews: #91;completedAudio#93;,<br/>}#93;,<br/>}#41;;<br/>}#41;,<br/>http.post#40;'${NTFY_URL}/${NTFY_TOPIC}', #40;#41; =#62; new...<br/>#41;;"]
    S6["Setup:<br/>const result = await watchAudioCompletion#40;#41;;"]
    V7["Verify:<br/>expect#40;result.processed#41;.toBe#40;1#41;;<br/>expect#40;result.completed#41;.toBe#40;1#41;;<br/>expect#40;result.failed#41;.toBe#40;0#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-match-a-completed-audio-file-and-update-the` in [`tests/windmill.test.ts`](tests/windmill.test.ts)

```{.typescript include="tests/windmill.test.ts" start-line=61 end-line=113}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should match a completed audio file and update the graph" --reporter=verbose
```

:::

#### ğŸ§ª "should query the rsrch server and return sources"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>server.use#40;<br/>http.post#40;'${RSRCH_URL}/notebooklm/sources-without-audio'...<br/>return HttpResponse.json#40;{<br/>sources: #91;'Source A', 'Source B'#93;,<br/>}#41;;<br/>}#41;<br/>#41;;"]
    S1["Setup:<br/>const result = await getSourcesWithoutAudio#40;{ notebook_ti..."]
    V2["Verify:<br/>expect#40;result.total_count#41;.toBe#40;2#41;;<br/>expect#40;result.sources_without_audio#41;.toEqual#40;#91;'S..."]
    A0 --> S1
    S1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-query-the-rsrch-server-and-return-sources` in [`tests/windmill.test.ts`](tests/windmill.test.ts)

```{.typescript include="tests/windmill.test.ts" start-line=119 end-line=135}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should query the rsrch server and return sources" --reporter=verbose
```

:::

#### ğŸ§ª "should send a success notification to ntfy"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>let requestBody = '';"]
    A1["Act:<br/>server.use#40;<br/>http.post#40;'${NTFY_URL}/${NTFY_TOPIC}', async #40;{ reques...<br/>requestBody = await request.text#40;#41;;<br/>return new HttpResponse#40;null, { status: 200 }#41;;<br/>}#41;<br/>#41;;"]
    S2["Setup:<br/>const result = await notifyAudioComplete#40;{"]
    A3["Act:<br/>source_title: 'My Test Source',<br/>notebook_title: 'My Test Notebook',<br/>start_time: Date.now#40;#41; - 5000,<br/>success: true,<br/>artifact_title: 'Audio for My Test Source',<br/>}#41;;"]
    V4["Verify:<br/>expect#40;result.notification_sent#41;.toBe#40;true#41;;<br/>expect#40;requestBody#41;.toContain#40;'Audio generated in 0"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-send-a-success-notification-to-ntfy` in [`tests/windmill.test.ts`](tests/windmill.test.ts)

```{.typescript include="tests/windmill.test.ts" start-line=140 end-line=162}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should send a success notification to ntfy" --reporter=verbose
```

:::

---

### ğŸ“ `adversarial.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should handle empty messages array gracefully"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;#93; // Empty array - no messages!<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S3["Setup:<br/>const data = await response.json#40;#41;;"]
    V4["Verify:<br/>expect#40;data.error#41;.toBeDefined#40;#41;;"]
    S0 --> A1
    A1 --> V2
    V2 --> S3
    S3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-empty-messages-array-gracefully` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=130 end-line=147}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle empty messages array gracefully" --reporter=verbose
```

:::

#### ğŸ§ª "should reject messages with empty content"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'user', content: '' },<br/>{ role: 'assistant', content: '' },<br/>{ role: 'user', content: 'Hello' }<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-messages-with-empty-content` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=155 end-line=174}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject messages with empty content" --reporter=verbose
```

:::

#### ğŸ§ª "should handle only system message"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'system', content: 'You are a helpful assistant' }<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-only-system-message` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=181 end-line=198}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle only system message" --reporter=verbose
```

:::

#### ğŸ§ª "should handle pollIntervalMs = 0 edge case"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;true#41;.toBe#40;true#41;; // Placeholder - need i"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-pollintervalms-0-edge-case` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=236 end-line=247}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle pollIntervalMs = 0 edge case" --reporter=verbose
```

:::

#### ğŸ§ª "should handle timeoutMs = 0 edge case"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;true#41;.toBe#40;true#41;;"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-timeoutms-0-edge-case` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=253 end-line=262}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle timeoutMs = 0 edge case" --reporter=verbose
```

:::

#### ğŸ§ª "should handle OPTIONS preflight correctly"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'OPTIONS',<br/>headers: {<br/>'Origin': 'http://evil.com',<br/>'Access-Control-Request-Method': 'POST',<br/>'Access-Control-Request-Headers': 'Content-Type'<br/>}<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;204#41;; // No Content<br/>expect#40;response.headers.get#40;'Access-Control-Allow-Orig...<br/>expect#40;response.headers.get#40;'Access-Control-Allow-Meth..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-options-preflight-correctly` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=272 end-line=288}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle OPTIONS preflight correctly" --reporter=verbose
```

:::

#### ğŸ§ª "should allow Authorization header via CORS"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'OPTIONS',<br/>headers: {<br/>'Origin': 'http://localhost:8080',<br/>'Access-Control-Request-Method': 'POST',<br/>'Access-Control-Request-Headers': 'Content-Type, Authorizati...<br/>}<br/>}#41;;"]
    S2["Setup:<br/>const allowedHeaders = response.headers.get#40;'Access-Contr..."]
    V3["Verify:<br/>expect#40;allowedHeaders#41;.toContain#40;'Authorization'#41"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-allow-authorization-header-via-cors` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=294 end-line=309}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should allow Authorization header via CORS" --reporter=verbose
```

:::

#### ğŸ§ª "should reject non-string message content"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'user', content: { text: 'Hello' } } // Object inste...<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-non-string-message-content` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=318 end-line=334}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject non-string message content" --reporter=verbose
```

:::

#### ğŸ§ª "should reject invalid message role"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'hacker', content: 'DROP TABLE users;' }<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-invalid-message-role` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=340 end-line=356}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject invalid message role" --reporter=verbose
```

:::

#### ğŸ§ª "should reject messages missing required fields"

::: {.callout-note appearance="simple"}
**â“ Unknown**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ content: 'Hello' } // Missing role<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-messages-missing-required-fields` in [`tests/adversarial.test.ts`](tests/adversarial.test.ts)

```{.typescript include="tests/adversarial.test.ts" start-line=362 end-line=378}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject messages missing required fields" --reporter=verbose
```

:::

---

### ğŸ“ `auth-sanity.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should be able to get a response from Gemini (confirms Google Auth)"

::: {.callout-warning appearance="simple"}
**â­ï¸ skipped**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;{ role: 'user', content: 'Reply only with 'PON...<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;200#41;;"]
    S3["Setup:<br/>const data = await response.json#40;#41;;"]
    V4["Verify:<br/>expect#40;data.choices#91;0#93;.message.content.toUpperCase#..."]
    S0 --> A1
    A1 --> V2
    V2 --> S3
    S3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-be-able-to-get-a-response-from-gemini-confi` in [`tests/auth-sanity.test.ts`](tests/auth-sanity.test.ts)

```{.typescript include="tests/auth-sanity.test.ts" start-line=17 end-line=34}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/auth-sanity.test.ts -t "should be able to get a response from Gemini (confirms Google Auth)" --reporter=verbose
```

:::

#### ğŸ§ª "should be able to get a response from Perplexity (confirms Perplexity Auth)"

::: {.callout-warning appearance="simple"}
**â­ï¸ skipped**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'perplexity',<br/>messages: #91;{ role: 'user', content: 'Reply only with 'PON...<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;200#41;;"]
    S3["Setup:<br/>const data = await response.json#40;#41;;"]
    V4["Verify:<br/>expect#40;data.choices#91;0#93;.message.content.toUpperCase#..."]
    S0 --> A1
    A1 --> V2
    V2 --> S3
    S3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-be-able-to-get-a-response-from-perplexity-c` in [`tests/auth-sanity.test.ts`](tests/auth-sanity.test.ts)

```{.typescript include="tests/auth-sanity.test.ts" start-line=36 end-line=53}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/auth-sanity.test.ts -t "should be able to get a response from Perplexity (confirms Perplexity Auth)" --reporter=verbose
```

:::

---

### ğŸ“ `export.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should correctly extract research data from DOM elements"

::: {.callout-tip appearance="simple"}
**âœ… Passed (7.15ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = await client.parseResearch#40;#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toBeNull#40;#41;;"]
    A2["Act:<br/>if #40;!result#41; return;"]
    V3["Verify:<br/>expect#40;result.query#41;.toBe#40;'Tell me about quantum co...<br/>expect#40;result.headings#41;.toContain#40;'Research Title'#<br/>expect#40;result.headings#41;.toContain#40;'Section 1'#41;;<br/>expect#40;result.contentHtml#41;.toContain#40;'#60;h1#62;Res...<br/>expect#40;result.contentHtml#41;.toContain#40;'href='https:/...<br/>expect#40;result.citations#41;.toHaveLength#40;1#41;;<br/>expect#40;result.citations#91;0#93;#41;.toEqual#40;{"]
    A4["Act:<br/>id: 1,<br/>text: 'quantum mechanics',<br/>url: 'https://example.com/qc',<br/>domain: 'example.com',<br/>usedInSections: #91;#93;<br/>}#41;;"]
    V5["Verify:<br/>expect#40;result.reasoningSteps.length#41;.toBeGreaterThan#4<br/>expect#40;result.reasoningSteps#91;0#93;.action#41;.toContai..."]
    S0 --> V1
    V1 --> A2
    A2 --> V3
    V3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-correctly-extract-research-data-from-dom-el` in [`tests/export.test.ts`](tests/export.test.ts)

```{.typescript include="tests/export.test.ts" start-line=41 end-line=78}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/export.test.ts -t "should correctly extract research data from DOM elements" --reporter=verbose
```

:::

#### ğŸ§ª "should generate valid markdown from parsed structure"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.18ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = await client.parseResearch#40;#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toBeNull#40;#41;;"]
    A2["Act:<br/>console.log#40;'\n--- PARSED RESULT #40;DEFAULT#41; ---'#41;<br/>console.log#40;JSON.stringify#40;result, null, 2#41;#41;;<br/>console.log#40;'-------------------------------\n'#41;;"]
    S3["Setup:<br/>const markdown = client.exportToMarkdown#40;result!#41;;"]
    A4["Act:<br/>console.log#40;'\n--- GENERATED MARKDOWN #40;DEFAULT#41; ---<br/>console.log#40;markdown#41;;<br/>console.log#40;'------------------------------------\n'#41;;"]
    V5["Verify:<br/>expect#40;markdown#41;.toContain#40;'# Research Title'#41;;<br/>expect#40;markdown#41;.toContain#40;'#62; **Query:** Tell me...<br/>expect#40;markdown#41;.toContain#40;'## Sources Used'#41;;<br/>expect#40;markdown#41;.toContain#40;'#124; 1 #124; #91;quant...<br/>expect#40;markdown#41;.toContain#40;'## Research Process'#41<br/>expect#40;markdown#41;.toContain#40;'# Research Title'#41;;<br/>expect#40;markdown#41;.toContain#40;'Quantum computing uses ..."]
    S0 --> V1
    V1 --> A2
    A2 --> S3
    S3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-generate-valid-markdown-from-parsed-structu` in [`tests/export.test.ts`](tests/export.test.ts)

```{.typescript include="tests/export.test.ts" start-line=80 end-line=111}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/export.test.ts -t "should generate valid markdown from parsed structure" --reporter=verbose
```

:::

#### ğŸ§ª "should correctly extract DIFFERENT research data to prove dynamic parsing"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.80ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const customPage = createResearchMockPage#40;{"]
    A1["Act:<br/>title: 'AI History',<br/>query: 'Who invented neural networks?',<br/>contentHtml: '<br/>#60;h1#62;History of AI#60;/h1#62;<br/>#60;p#62;The concept started with #60;a href='https://ai-his...<br/>#60;div class='research-status'#62;Searching archives...#60;<br/>#60;h2#62;1943 Era#60;/h2#62;<br/>#60;p#62;Foundations were laid.#60;/p#62;<br/>',<br/>contentText: 'History of AI\nThe concept started with McCull...<br/>citations: #91;<br/>{ text: 'McCulloch-Pitts neuron', href: 'https://ai-history....<br/>#93;,<br/>headings: #91;'History of AI', '1943 Era'#93;,<br/>reasoning: #91;'Searching archives...'#93;<br/>}#41;;"]
    S2["Setup:<br/>const customClient = new GeminiClient#40;customPage, { verbo...<br/>const result = await customClient.parseResearch#40;#41;;"]
    V3["Verify:<br/>expect#40;result#41;.not.toBeNull#40;#41;;"]
    A4["Act:<br/>if #40;!result#41; return;<br/>console.log#40;'\n--- PARSED RESULT #40;CUSTOM#41; ---'#41;;<br/>console.log#40;JSON.stringify#40;result, null, 2#41;#41;;<br/>console.log#40;'------------------------------\n'#41;;"]
    S5["Setup:<br/>const markdown = customClient.exportToMarkdown#40;result#41;"]
    A6["Act:<br/>console.log#40;'\n--- GENERATED MARKDOWN #40;CUSTOM#41; ---'<br/>console.log#40;markdown#41;;<br/>console.log#40;'-----------------------------------\n'#41;;"]
    V7["Verify:<br/>expect#40;result.query#41;.toBe#40;'Who invented neural netw<br/>expect#40;result.headings#41;.toContain#40;'History of AI'#4<br/>expect#40;markdown#41;.toContain#40;'# History of AI'#41;;<br/>expect#40;markdown#41;.toContain#40;'#91;McCulloch-Pitts neu..."]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> A4
    A4 --> S5
    S5 --> A6
    A6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-correctly-extract-different-research-data-t` in [`tests/export.test.ts`](tests/export.test.ts)

```{.typescript include="tests/export.test.ts" start-line=113 end-line=159}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/export.test.ts -t "should correctly extract DIFFERENT research data to prove dynamic parsing" --reporter=verbose
```

:::

#### ğŸ§ª "should format full research document correctly"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.72ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockParsedData = {"]
    A1["Act:<br/>title: 'Test Research',<br/>query: 'Test Query',<br/>content: 'Some content',<br/>contentHtml: '#60;p#62;Some content#60;/p#62;',<br/>contentMarkdown: 'Some content',<br/>headings: #91;'Heading 1'#93;,<br/>citations: #91;<br/>{ id: 1, text: 'Source 1', url: 'http://src1.com', domain: '...<br/>#93;,<br/>reasoningSteps: #91;<br/>{ phase: 'Step 1', action: 'Thinking...' }<br/>#93;,<br/>researchFlow: #91;#93;,<br/>createdAt: '2025-01-01'<br/>};"]
    S2["Setup:<br/>const compiledMd = client.exportToMarkdown#40;mockParsedData"]
    V3["Verify:<br/>expect#40;compiledMd#41;.toContain#40;'# Test Research'#41;;<br/>expect#40;compiledMd#41;.toContain#40;'#62; **Query:** Test <br/>expect#40;compiledMd#41;.toContain#40;'#124; 1 #124; #91;Sou...<br/>expect#40;compiledMd#41;.toContain#40;'**Step 1**: Thinking."]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-format-full-research-document-correctly` in [`tests/export.test.ts`](tests/export.test.ts)

```{.typescript include="tests/export.test.ts" start-line=164 end-line=191}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/export.test.ts -t "should format full research document correctly" --reporter=verbose
```

:::

---

### ğŸ“ `gemini-client.unit.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should convert code blocks with language"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2.73ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;pre#62;#60;code class='language-typescript...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;''''typescript'#41;;<br/>expect#40;result#41;.toContain#40;'const x = 1;'#41;;<br/>expect#40;result#41;.toContain#40;'''''#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-code-blocks-with-language` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=89 end-line=98}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert code blocks with language" --reporter=verbose
```

:::

#### ğŸ§ª "should convert code blocks without language"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.23ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;pre#62;#60;code#62;plain code#60;/code#62;<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;''''\n'#41;;<br/>expect#40;result#41;.toContain#40;'plain code'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-code-blocks-without-language` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=100 end-line=109}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert code blocks without language" --reporter=verbose
```

:::

#### ğŸ§ª "should decode HTML entities in code blocks"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.16ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;pre#62;#60;code#62;#38;lt;div#38;gt;#38;am...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'#38;text'#41;;<br/>expect#40;result#41;.toContain#40;'''''#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-decode-html-entities-in-code-blocks` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=111 end-line=122}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should decode HTML entities in code blocks" --reporter=verbose
```

:::

#### ğŸ§ª "should handle inline code"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.26ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'Use #60;code#62;npm install#60;/code#62; to in<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Use 'npm install' to install'#"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-inline-code` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=124 end-line=132}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle inline code" --reporter=verbose
```

:::

#### ğŸ§ª "should convert h1 to markdown"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.13ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h1#62;Main Title#60;/h1#62;';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'# Main Title'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-h1-to-markdown` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=137 end-line=144}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert h1 to markdown" --reporter=verbose
```

:::

#### ğŸ§ª "should convert h2 to markdown"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.10ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h2#62;Section#60;/h2#62;';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'## Section'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-h2-to-markdown` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=146 end-line=154}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert h2 to markdown" --reporter=verbose
```

:::

#### ğŸ§ª "should convert h3 to markdown"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.20ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h3#62;Subsection#60;/h3#62;';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'### Subsection'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-h3-to-markdown` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=156 end-line=164}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert h3 to markdown" --reporter=verbose
```

:::

#### ğŸ§ª "should handle headings with attributes"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.12ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h2 class='title' id='section-1'#62;With At...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'## With Attrs'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-headings-with-attributes` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=166 end-line=174}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle headings with attributes" --reporter=verbose
```

:::

#### ğŸ§ª "should convert strong to bold"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.20ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;strong#62;important#60;/strong#62;<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is **important** text'#41"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-strong-to-bold` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=179 end-line=186}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert strong to bold" --reporter=verbose
```

:::

#### ğŸ§ª "should convert b to bold"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.12ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;b#62;bold#60;/b#62; text';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is **bold** text'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-b-to-bold` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=188 end-line=196}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert b to bold" --reporter=verbose
```

:::

#### ğŸ§ª "should convert em to italic"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.08ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;em#62;emphasized#60;/em#62; text';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is *emphasized* text'#41;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-em-to-italic` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=198 end-line=206}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert em to italic" --reporter=verbose
```

:::

#### ğŸ§ª "should convert i to italic"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.07ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;i#62;italic#60;/i#62; text';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is *italic* text'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-i-to-italic` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=208 end-line=216}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert i to italic" --reporter=verbose
```

:::

#### ğŸ§ª "should convert unordered list items"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.08ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;ul#62;#60;li#62;First#60;/li#62;#60;li#62;<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'- First'#41;;<br/>expect#40;result#41;.toContain#40;'- Second'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-unordered-list-items` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=221 end-line=229}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert unordered list items" --reporter=verbose
```

:::

#### ğŸ§ª "should convert ordered list items"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.07ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;ol#62;#60;li#62;Step 1#60;/li#62;#60;li#62<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'- Step 1'#41;;<br/>expect#40;result#41;.toContain#40;'- Step 2'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-ordered-list-items` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=231 end-line=240}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert ordered list items" --reporter=verbose
```

:::

#### ğŸ§ª "should convert paragraphs"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.08ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;p#62;First paragraph#60;/p#62;#60;p#62;Sec...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'First paragraph'#41;;<br/>expect#40;result#41;.toContain#40;'Second paragraph'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-paragraphs` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=245 end-line=253}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert paragraphs" --reporter=verbose
```

:::

#### ğŸ§ª "should convert br to newline"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.07ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'Line one#60;br#62;Line two<br/>Line three';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'Line one\nLine two\nLine "]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-br-to-newline` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=255 end-line=263}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert br to newline" --reporter=verbose
```

:::

#### ğŸ§ª "should convert links to markdown format"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.06ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'Visit #60;a href='https://example.com'#62;Exam...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Visit #91;Example Site#93;#40;..."]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-links-to-markdown-format` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=268 end-line=275}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert links to markdown format" --reporter=verbose
```

:::

#### ğŸ§ª "should handle links with extra attributes"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.06ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;a href='https://test.com' target='_blank' ...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'#91;Link#93;#40;https://test.c"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-links-with-extra-attributes` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=277 end-line=285}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle links with extra attributes" --reporter=verbose
```

:::

#### ğŸ§ª "should decode common HTML entities"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.07ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#38;lt;tag#38;gt; #38;amp; #38;quot;quoted#38;...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'#60;tag#62; #38; 'quoted' \'ap"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-decode-common-html-entities` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=290 end-line=297}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should decode common HTML entities" --reporter=verbose
```

:::

#### ğŸ§ª "should convert nbsp to space"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.06ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'word#38;nbsp;word';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'word word'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-convert-nbsp-to-space` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=299 end-line=307}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert nbsp to space" --reporter=verbose
```

:::

#### ğŸ§ª "should strip unknown HTML tags"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.07ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;custom#62;content#60;/custom#62;#60;span#6<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'contentmore'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-strip-unknown-html-tags` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=312 end-line=319}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should strip unknown HTML tags" --reporter=verbose
```

:::

#### ğŸ§ª "should handle empty input"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.06ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = htmlToMarkdownSimple#40;''#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;''#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-empty-input` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=321 end-line=328}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle empty input" --reporter=verbose
```

:::

#### ğŸ§ª "should handle plain text"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.05ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = htmlToMarkdownSimple#40;'Just plain text'#41;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Just plain text'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-plain-text` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=330 end-line=337}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle plain text" --reporter=verbose
```

:::

#### ğŸ§ª "should collapse multiple newlines"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.16ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;p#62;Para 1#60;/p#62;\n\n\n\n#60;p#62;Para<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toMatch#40;/\n{3,}/#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-collapse-multiple-newlines` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=339 end-line=348}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should collapse multiple newlines" --reporter=verbose
```

:::

#### ğŸ§ª "should trim whitespace"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.12ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '   #60;p#62;Content#60;/p#62;   ';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toMatch#40;/^\s/#41;;<br/>expect#40;result#41;.not.toMatch#40;/\s$/#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-trim-whitespace` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=350 end-line=359}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should trim whitespace" --reporter=verbose
```

:::

#### ğŸ§ª "should handle nested formatting"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.08ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;p#62;#60;strong#62;Bold with #60;em#62;ita...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'**Bold with *italic***'#4"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-nested-formatting` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=364 end-line=371}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle nested formatting" --reporter=verbose
```

:::

#### ğŸ§ª "should handle full document structure"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.13ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '"]
    A1["Act:<br/>#60;h1#62;Title#60;/h1#62;<br/>#60;p#62;Introduction paragraph with #60;strong#62;bold#60;/<br/>#60;h2#62;Section#60;/h2#62;<br/>#60;ul#62;<br/>#60;li#62;Item one#60;/li#62;<br/>#60;li#62;Item two#60;/li#62;<br/>#60;/ul#62;<br/>#60;pre#62;#60;code class='language-js'#62;console.log#40;'h...<br/>';"]
    S2["Setup:<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V3["Verify:<br/>expect#40;result#41;.toContain#40;'# Title'#41;;<br/>expect#40;result#41;.toContain#40;'**bold**'#41;;<br/>expect#40;result#41;.toContain#40;'## Section'#41;;<br/>expect#40;result#41;.toContain#40;'- Item one'#41;;<br/>expect#40;result#41;.toContain#40;''''js'#41;;<br/>expect#40;result#41;.toContain#40;'console.log#40;'hello'#41"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-full-document-structure` in [`tests/gemini-client.unit.test.ts`](tests/gemini-client.unit.test.ts)

```{.typescript include="tests/gemini-client.unit.test.ts" start-line=373 end-line=395}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle full document structure" --reporter=verbose
```

:::

---

### ğŸ“ `gemini-windmill.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "queryViaWindmill should delegate to WindmillClient when configured"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3.32ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const query = 'Test Query';<br/>const expectedResponse = 'Windmill Response';<br/>mockIsConfigured.mockReturnValue#40;true#41;;<br/>mockTriggerGemini.mockResolvedValue#40;{ jobId: 'job-123' }#<br/>mockWaitForJob.mockResolvedValue#40;{"]
    A1["Act:<br/>success: true,<br/>result: {<br/>success: true,<br/>response: expectedResponse,<br/>session_id: 'new-session-id'<br/>}<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.queryViaWindmill#40;query#41;;"]
    V3["Verify:<br/>expect#40;mockIsConfigured#41;.toHaveBeenCalled#40;#41;;<br/>expect#40;mockTriggerGemini#41;.toHaveBeenCalledWith#40;{"]
    A4["Act:<br/>message: query,<br/>session_id: undefined,<br/>model: 'pro',<br/>waitForResponse: true<br/>}#41;;"]
    V5["Verify:<br/>expect#40;mockWaitForJob#41;.toHaveBeenCalledWith#40;'job-12<br/>expect#40;result#41;.toBe#40;expectedResponse#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:queryviawindmill-should-delegate-to-windmillclient` in [`tests/gemini-windmill.test.ts`](tests/gemini-windmill.test.ts)

```{.typescript include="tests/gemini-windmill.test.ts" start-line=39 end-line=73}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should delegate to WindmillClient when configured" --reporter=verbose
```

:::

#### ğŸ§ª "queryViaWindmill should pass session ID and model"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.77ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockIsConfigured.mockReturnValue#40;true#41;;<br/>mockTriggerGemini.mockResolvedValue#40;{ jobId: 'job-456' }#<br/>mockWaitForJob.mockResolvedValue#40;{"]
    A1["Act:<br/>success: true,<br/>result: { success: true, response: 'ok' }<br/>}#41;;<br/>await client.queryViaWindmill#40;'Hello', 'sess-123', 'think..."]
    V2["Verify:<br/>expect#40;mockTriggerGemini#41;.toHaveBeenCalledWith#40;{"]
    A3["Act:<br/>message: 'Hello',<br/>session_id: 'sess-123',<br/>model: 'thinking',<br/>waitForResponse: true<br/>}#41;;"]
    S0 --> A1
    A1 --> V2
    V2 --> A3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:queryviawindmill-should-pass-session-id-and-model` in [`tests/gemini-windmill.test.ts`](tests/gemini-windmill.test.ts)

```{.typescript include="tests/gemini-windmill.test.ts" start-line=73 end-line=95}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should pass session ID and model" --reporter=verbose
```

:::

#### ğŸ§ª "queryViaWindmill should throw if Windmill is not configured"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.19ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockIsConfigured.mockReturnValue#40;false#41;;"]
    A1["Act:<br/>await expect#40;client.queryViaWindmill#40;'fail'#41;#41;.re..."]
    S0 --> A1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:queryviawindmill-should-throw-if-windmill-is-not-c` in [`tests/gemini-windmill.test.ts`](tests/gemini-windmill.test.ts)

```{.typescript include="tests/gemini-windmill.test.ts" start-line=95 end-line=104}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should throw if Windmill is not configured" --reporter=verbose
```

:::

#### ğŸ§ª "queryViaWindmill should throw if job fails internally"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.63ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockIsConfigured.mockReturnValue#40;true#41;;<br/>mockTriggerGemini.mockResolvedValue#40;{ jobId: 'job-789' }#<br/>mockWaitForJob.mockResolvedValue#40;{"]
    A1["Act:<br/>success: true,<br/>result: { success: false, error: 'Script Error' }<br/>}#41;;<br/>await expect#40;client.queryViaWindmill#40;'fail'#41;#41;.re..."]
    S0 --> A1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:queryviawindmill-should-throw-if-job-fails-interna` in [`tests/gemini-windmill.test.ts`](tests/gemini-windmill.test.ts)

```{.typescript include="tests/gemini-windmill.test.ts" start-line=104 end-line=119}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should throw if job fails internally" --reporter=verbose
```

:::

---

### ğŸ“ `retry.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should succeed on the first attempt"

::: {.callout-tip appearance="simple"}
**âœ… Passed (4.98ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;<br/>#40;fetch as vi.Mock#41;.mockResolvedValueOnce#40;{"]
    A1["Act:<br/>ok: true,<br/>text: async #40;#41; =#62; 'job-123',<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.jobId#41;.toBe#40;'job-123'#41;;<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;1#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-succeed-on-the-first-attempt` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=16 end-line=31}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should succeed on the first attempt" --reporter=verbose
```

:::

#### ğŸ§ª "should retry on transient server errors and eventually succeed"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3017.94ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;"]
    A1["Act:<br/>#40;fetch as vi.Mock#41;"]
    S2["Setup:<br/>.mockResolvedValueOnce#40;{ ok: false, status: 503, statusTe...<br/>.mockResolvedValueOnce#40;{ ok: false, status: 429, statusTe...<br/>.mockResolvedValueOnce#40;{ ok: true, text: async #40;#41; =...<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.jobId#41;.toBe#40;'job-123'#41;;<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;3#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-retry-on-transient-server-errors-and-eventu` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=33 end-line=48}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should retry on transient server errors and eventually succeed" --reporter=verbose
```

:::

#### ğŸ§ª "should fail after max retries on persistent server errors"

::: {.callout-tip appearance="simple"}
**âœ… Passed (7016.28ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;<br/>#40;fetch as vi.Mock#41;.mockResolvedValue#40;{"]
    A1["Act:<br/>ok: false,<br/>status: 500,<br/>statusText: 'Internal Server Error',<br/>text: async #40;#41; =#62; 'server-error',<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;false#41;;<br/>expect#40;result.error#41;.toContain#40;'API error #40;statu...<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;4#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-fail-after-max-retries-on-persistent-server` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=50 end-line=67}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should fail after max retries on persistent server errors" --reporter=verbose
```

:::

#### ğŸ§ª "should fail immediately on non-retriable client errors (e.g., 400)"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.82ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;<br/>#40;fetch as vi.Mock#41;.mockResolvedValueOnce#40;{"]
    A1["Act:<br/>ok: false,<br/>status: 400,<br/>statusText: 'Bad Request',<br/>text: async #40;#41; =#62; 'bad-request',<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;false#41;;<br/>expect#40;result.error#41;.toContain#40;'API error #40;statu...<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;1#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-fail-immediately-on-non-retriable-client-er` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=69 end-line=86}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should fail immediately on non-retriable client errors (e.g., 400)" --reporter=verbose
```

:::

#### ğŸ§ª "should handle request timeouts and retry"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1000.76ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;"]
    A1["Act:<br/>#40;fetch as vi.Mock#41;"]
    S2["Setup:<br/>.mockRejectedValueOnce#40;new DOMException#40;'The user abor...<br/>.mockResolvedValueOnce#40;{ ok: true, text: async #40;#41; =...<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.jobId#41;.toBe#40;'job-123'#41;;<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;2#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-handle-request-timeouts-and-retry` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=88 end-line=102}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should handle request timeouts and retry" --reporter=verbose
```

:::

#### ğŸ§ª "should connect successfully on the first attempt"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.98ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await graphStore.connect#40;#41;;"]
    V1["Verify:<br/>expect#40;mockConnect#41;.toHaveBeenCalledTimes#40;1#41;;<br/>expect#40;#40;graphStore as any#41;.isConnected#41;.toBe#40;"]
    A0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-connect-successfully-on-the-first-attempt` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=139 end-line=147}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should connect successfully on the first attempt" --reporter=verbose
```

:::

#### ğŸ§ª "should retry connection and eventually succeed"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2000.60ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockConnect<br/>.mockRejectedValueOnce#40;new Error#40;'Connection failed'#4<br/>.mockResolvedValueOnce#40;{ selectGraph: #40;#41; =#62; #40;..."]
    A1["Act:<br/>await graphStore.connect#40;'localhost', 6379, 2#41;;"]
    V2["Verify:<br/>expect#40;mockConnect#41;.toHaveBeenCalledTimes#40;2#41;;<br/>expect#40;#40;graphStore as any#41;.isConnected#41;.toBe#40;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-retry-connection-and-eventually-succeed` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=149 end-line=161}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should retry connection and eventually succeed" --reporter=verbose
```

:::

#### ğŸ§ª "should fail to connect after max retries"

::: {.callout-tip appearance="simple"}
**âœ… Passed (2004.87ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockConnect.mockRejectedValue#40;new Error#40;'Persistent co..."]
    A1["Act:<br/>await expect#40;graphStore.connect#40;'localhost', 6379, 2#4..."]
    V2["Verify:<br/>expect#40;mockConnect#41;.toHaveBeenCalledTimes#40;2#41;;<br/>expect#40;#40;graphStore as any#41;.isConnected#41;.toBe#40;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-fail-to-connect-after-max-retries` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=163 end-line=172}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should fail to connect after max retries" --reporter=verbose
```

:::

#### ğŸ§ª "should trip circuit breaker after enough consecutive failures"

::: {.callout-tip appearance="simple"}
**âœ… Passed (3.00ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await graphStore.connect#40;#41;;"]
    S1["Setup:<br/>mockQuery = graphStore.graph.query;<br/>mockQuery.mockRejectedValue#40;new Error#40;'Query failed'#4<br/>for #40;let i = 0; i #60; 5; i++#41; {"]
    A2["Act:<br/>await expect#40;#40;graphStore as any#41;._executeQuery#40;'...<br/>}<br/>await expect#40;#40;graphStore as any#41;._executeQuery#40;'..."]
    A0 --> S1
    S1 --> A2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-trip-circuit-breaker-after-enough-consecuti` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=174 end-line=191}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should trip circuit breaker after enough consecutive failures" --reporter=verbose
```

:::

#### ğŸ§ª "should transition from OPEN to HALF_OPEN and then to CLOSED"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.05ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await graphStore.connect#40;#41;;"]
    S1["Setup:<br/>mockQuery = graphStore.graph.query;<br/>mockQuery.mockClear#40;#41;; // Clear calls from initSchema<br/>mockQuery.mockRejectedValue#40;new Error#40;'Query failed'#4<br/>for #40;let i = 0; i #60; 5; i++#41; {"]
    A2["Act:<br/>await expect#40;#40;graphStore as any#41;._executeQuery#40;'...<br/>}<br/>graphStore.lastFailure = Date.now#40;#41; - 31000;"]
    S3["Setup:<br/>mockQuery.mockResolvedValue#40;{ data: #91;#93; }#41;;"]
    A4["Act:<br/>await #40;graphStore as any#41;._executeQuery#40;'SUCCESS'#4<br/>await #40;graphStore as any#41;._executeQuery#40;'SUCCESS'#4"]
    V5["Verify:<br/>expect#40;mockQuery#41;.toHaveBeenCalledTimes#40;7#41;;"]
    A0 --> S1
    S1 --> A2
    A2 --> S3
    S3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-transition-from-open-to-half-open-and-then-` in [`tests/retry.test.ts`](tests/retry.test.ts)

```{.typescript include="tests/retry.test.ts" start-line=193 end-line=223}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/retry.test.ts -t "should transition from OPEN to HALF_OPEN and then to CLOSED" --reporter=verbose
```

:::

---

### ğŸ“ `stream-thoughts.integration.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should stream thoughts from a reasoning query"

::: {.callout-warning appearance="simple"}
**â­ï¸ skipped**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const query = 'Solve 25 * 44 with detailed thoughts';<br/>const serverUrl = 'http://halvarm:3030';"]
    A1["Act:<br/>console.log#40;'Testing query: '${query}' against ${serverUr..."]
    S2["Setup:<br/>let fullText = '';<br/>let thoughtBlockDetected = false;"]
    A3["Act:<br/>await executeGeminiStream#40;'chat', { message: query }, { s...<br/>if #40;data.type === 'progress' #38;#38; data.text#41; {<br/>fullText = data.text;<br/>if #40;data.text.includes#40;'Thought Process'#41; #124;#124<br/>data.text.includes#40;'MyÅ¡lenkovÃ½ proces'#41; #124;#124;<br/>data.text.includes#40;'Reasoning'#41;#41; {<br/>thoughtBlockDetected = true;<br/>}<br/>}<br/>}#41;;<br/>console.log#40;'Final Text Length:', fullText.length#41;;<br/>console.log#40;'Thought Block Detected:', thoughtBlockDetect..."]
    V4["Verify:<br/>expect#40;fullText.length#41;.toBeGreaterThan#40;0#41;;<br/>expect#40;thoughtBlockDetected#41;.toBe#40;true#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-stream-thoughts-from-a-reasoning-query` in [`tests/stream-thoughts.integration.test.ts`](tests/stream-thoughts.integration.test.ts)

```{.typescript include="tests/stream-thoughts.integration.test.ts" start-line=10 end-line=44}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/stream-thoughts.integration.test.ts -t "should stream thoughts from a reasoning query" --reporter=verbose
```

:::

---

### ğŸ“ `validation.unit.test.ts` <small>(Integration/Orphan)</small>

#### ğŸ§ª "should reject empty messages array"

::: {.callout-tip appearance="simple"}
**âœ… Passed (1.19ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;#93;#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Messages array cannot be empty"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-empty-messages-array` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=46 end-line=52}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject empty messages array" --reporter=verbose
```

:::

#### ğŸ§ª "should reject system-only messages"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.14ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'system', content: 'You are helpful' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBe#40;'At least one user message is r..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-system-only-messages` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=57 end-line=65}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject system-only messages" --reporter=verbose
```

:::

#### ğŸ§ª "should accept messages with user"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.13ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'system', content: 'You are helpful' },<br/>{ role: 'user', content: 'Hello' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-accept-messages-with-user` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=67 end-line=77}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should accept messages with user" --reporter=verbose
```

:::

#### ğŸ§ª "should reject invalid role"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.34ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'hacker', content: 'malicious' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'Invalid role 'hacker''#41"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-invalid-role` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=82 end-line=90}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject invalid role" --reporter=verbose
```

:::

#### ğŸ§ª "should reject missing role"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.14ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: '', content: 'Hello' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'Invalid role'#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-missing-role` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=92 end-line=101}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject missing role" --reporter=verbose
```

:::

#### ğŸ§ª "should accept valid roles"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.09ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'system', content: 'System prompt' },<br/>{ role: 'user', content: 'Hello' },<br/>{ role: 'assistant', content: 'Hi there' },<br/>{ role: 'user', content: 'Follow up' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-accept-valid-roles` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=103 end-line=115}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should accept valid roles" --reporter=verbose
```

:::

#### ğŸ§ª "should reject object content"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.13ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: { text: 'Hello' } }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'must be a string, got obj"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-object-content` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=120 end-line=128}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject object content" --reporter=verbose
```

:::

#### ğŸ§ª "should reject number content"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.13ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: 42 }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'must be a string, got num"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-number-content` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=130 end-line=139}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject number content" --reporter=verbose
```

:::

#### ğŸ§ª "should reject undefined content"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.21ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: undefined }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'must be a string, got und"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-undefined-content` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=141 end-line=150}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject undefined content" --reporter=verbose
```

:::

#### ğŸ§ª "should reject empty user message"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.11ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: '' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'cannot have empty content"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-empty-user-message` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=155 end-line=163}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject empty user message" --reporter=verbose
```

:::

#### ğŸ§ª "should reject whitespace-only user message"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.11ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: '   ' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'cannot have empty content"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-reject-whitespace-only-user-message` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=165 end-line=174}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject whitespace-only user message" --reporter=verbose
```

:::

#### ğŸ§ª "should allow empty assistant content"

::: {.callout-tip appearance="simple"}
**âœ… Passed (0.07ms)**
:::

::: {.panel-tabset}

##### ğŸ§¬ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: 'Hello' },<br/>{ role: 'assistant', content: '' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### ğŸ’» Implementation

> ğŸ“„ **Region:** `// #region test:should-allow-empty-assistant-content` in [`tests/validation.unit.test.ts`](tests/validation.unit.test.ts)

```{.typescript include="tests/validation.unit.test.ts" start-line=176 end-line=186}
```

##### â–¶ï¸ Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should allow empty assistant content" --reporter=verbose
```

:::

---

## ğŸ”„ Refresh Test Results

To update the results shown above:

```bash
# Run tests and generate JSON results
npx vitest run --reporter=json --outputFile=test-results.json

# Regenerate this report
npx ts-node scripts/generate_test_report.ts > TEST_REPORT.qmd

# Render to HTML
quarto render TEST_REPORT.qmd
```
