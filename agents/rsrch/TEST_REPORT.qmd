---
title: "Detailed Test & Implementation Report"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
    theme: cosmo
    page-layout: full
---

Generated on: 2026-01-24T17:07:23.352Z

## üìä Test Results Summary

> **Last Run:** 1/24/2026, 6:06:57 PM

| Status | Count |
|--------|-------|
| ‚úÖ Passed | 93 |
| ‚ùå Failed | 2 |
| ‚è≠Ô∏è Skipped | 17 |
| **Total** | **112** |

## üìà Source Component Coverage
| Component | LOC | Test File | Scenarios | Assertions | Status |
|---|---|---|---|---|---|
| `gemini-client.ts` | 2869 | `gemini-client.test.ts` | 21 | 36 | üü¢ Strong |
| `graph-store.ts` | 1355 | `graph-store.test.ts` | 0 | 17 | üü¢ Strong |
| `commands/gemini.ts` | 1005 | `e2e/gemini.test.ts` | 2 | 6 | üü° Basic |
| `selectors.ts` | 328 | `selectors.test.ts` | 5 | 15 | üü¢ Strong |
| `commands/graph.ts` | 266 | `graph.test.ts` | 1 | 1 | üü° Basic |
| `artifact-registry.ts` | 237 | `artifact-registry.test.ts` | 7 | 24 | üü¢ Strong |
| `types/graph-store.ts` | 97 | `graph-store.test.ts` | 0 | 17 | üü¢ Strong |
| `clients/windmill.ts` | 76 | `windmill.test.ts` | 4 | 11 | üü¢ Strong |

## üß™ Detailed Test Scenarios

### üìÅ `gemini-client.test.ts` <small>(Unit/Mapped)</small>

#### üß™ "should be defined"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.43ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;GeminiClient#41;.toBeDefined#40;#41;;"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:109-111`](tests/gemini-client.test.ts)

```typescript
expect(GeminiClient).toBeDefined();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should be defined" --reporter=verbose
```

:::

#### üß™ "should navigate to the base URL if no session ID is provided"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (14.69ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await client.init#40;#41;;"]
    V1["Verify:<br/>expect#40;mockPage.goto#41;.toHaveBeenCalledWith#40;'https:/..."]
    A0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:114-117`](tests/gemini-client.test.ts)

```typescript
await client.init();
            expect(mockPage.goto).toHaveBeenCalledWith('https://gemini.google.com/app', { waitUntil: 'domcontentloaded' });
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should navigate to the base URL if no session ID is provided" --reporter=verbose
```

:::

#### üß™ "should navigate to the specific session URL if an ID is provided"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.71ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await client.init#40;'test-session-id'#41;;"]
    V1["Verify:<br/>expect#40;mockPage.goto#41;.toHaveBeenCalledWith#40;'https:/..."]
    A0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:119-122`](tests/gemini-client.test.ts)

```typescript
await client.init('test-session-id');
            expect(mockPage.goto).toHaveBeenCalledWith('https://gemini.google.com/app/test-session-id', { waitUntil: 'domcontentloaded' });
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should navigate to the specific session URL if an ID is provided" --reporter=verbose
```

:::

#### üß™ "should handle and click cookie consent button"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.30ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockCookieButton = createMockLocator#40;true#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'Accept all'#41;#41; {"]
    S2["Setup:<br/>return mockCookieButton;"]
    A3["Act:<br/>}<br/>return createMockLocator#40;false#41;; // Hide other buttons<br/>}#41;;<br/>await client.init#40;#41;;"]
    V4["Verify:<br/>expect#40;mockCookieButton.click#41;.toHaveBeenCalled#40;#41"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:124-135`](tests/gemini-client.test.ts)

```typescript
const mockCookieButton = createMockLocator(true);
            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('Accept all')) {
                    return mockCookieButton;
                }
                return createMockLocator(false); // Hide other buttons
            });

            await client.init();
            expect(mockCookieButton.click).toHaveBeenCalled();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should handle and click cookie consent button" --reporter=verbose
```

:::

#### üß™ "should handle and click dismiss buttons for popups"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.14ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockDismissButton = createMockLocator#40;true#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'No thanks'#41;#41; {"]
    S2["Setup:<br/>return mockDismissButton;"]
    A3["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;<br/>await client.init#40;#41;;"]
    V4["Verify:<br/>expect#40;mockDismissButton.click#41;.toHaveBeenCalled#40;#4"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:137-148`](tests/gemini-client.test.ts)

```typescript
const mockDismissButton = createMockLocator(true);
            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('No thanks')) {
                    return mockDismissButton;
                }
                return createMockLocator(false);
            });

            await client.init();
            expect(mockDismissButton.click).toHaveBeenCalled();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should handle and click dismiss buttons for popups" --reporter=verbose
```

:::

#### üß™ "should throw an error if a sign-in button is detected"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.04ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'Sign in'#41;#41; {<br/>return createMockLocator#40;true#41;;<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;<br/>await expect#40;client.init#40;#41;#41;.rejects.toThrow#40;'..."]
    V2["Verify:<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'gemi..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:150-161`](tests/gemini-client.test.ts)

```typescript
mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('Sign in')) {
                    return createMockLocator(true);
                }
                return createMockLocator(false);
            });

            await expect(client.init()).rejects.toThrow('Gemini requires authentication. Please run rsrch auth first.');
            expect(client.dumpState).toHaveBeenCalledWith('gemini_auth_required');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should throw an error if a sign-in button is detected" --reporter=verbose
```

:::

#### üß™ "should wait for the chat interface to be ready"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.53ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await client.init#40;#41;;"]
    V1["Verify:<br/>expect#40;mockPage.waitForSelector#41;.toHaveBeenCalledWith#"]
    A2["Act:<br/>'chat-app, .input-area, textarea, div#91;contenteditable='tr...<br/>{ timeout: 15000 }<br/>#41;;"]
    A0 --> V1
    V1 --> A2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:163-169`](tests/gemini-client.test.ts)

```typescript
await client.init();
            expect(mockPage.waitForSelector).toHaveBeenCalledWith(
                'chat-app, .input-area, textarea, div[contenteditable="true"], rich-textarea, .chat-input, [data-input-container]',
                { timeout: 15000 }
            );
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should wait for the chat interface to be ready" --reporter=verbose
```

:::

#### üß™ "should throw an error if chat interface is not found"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.83ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.waitForSelector.mockRejectedValue#40;new Error#40;'...<br/>mockPage.locator.mockImplementation#40;#40;#41; =#62; create..."]
    A1["Act:<br/>await expect#40;client.init#40;#41;#41;.rejects.toThrow#40;'"]
    V2["Verify:<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'gemi..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:171-178`](tests/gemini-client.test.ts)

```typescript
mockPage.waitForSelector.mockRejectedValue(new Error('Timeout'));
            // also make sidebar invisible
            mockPage.locator.mockImplementation(() => createMockLocator(false));

            await expect(client.init()).rejects.toThrow('Timeout');
            expect(client.dumpState).toHaveBeenCalledWith('gemini_init_fail');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should throw an error if chat interface is not found" --reporter=verbose
```

:::

#### üß™ "should fill the input, press Enter, and wait for a response"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.78ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const message = 'Hello, Gemini!';<br/>const mockInput = createMockLocator#40;true#41;;<br/>const mockResponse = createMockLocator#40;true, 'Response te...<br/>mockResponse.last = vi.fn#40;#41;.mockReturnThis#40;#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'div#91;contenteditable='true'#9"]
    S2["Setup:<br/>return mockInput;"]
    A3["Act:<br/>}<br/>if #40;selector.includes#40;'model-response'#41;#41; {"]
    S4["Setup:<br/>return mockResponse;"]
    A5["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;"]
    S6["Setup:<br/>const response = await client.sendMessage#40;message#41;;"]
    V7["Verify:<br/>expect#40;mockInput.fill#41;.toHaveBeenCalledWith#40;message<br/>expect#40;mockInput.press#41;.toHaveBeenCalledWith#40;'Enter<br/>expect#40;response#41;.toBe#40;'Response text'#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:182-203`](tests/gemini-client.test.ts)

```typescript
const message = 'Hello, Gemini!';
            const mockInput = createMockLocator(true);
            const mockResponse = createMockLocator(true, 'Response text');
            mockResponse.last = vi.fn().mockReturnThis();

            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('div[contenteditable="true"]')) {
                    return mockInput;
                }
                if (selector.includes('model-response')) {
                    return mockResponse;
                }
                return createMockLocator(false);
            });

            const response = await client.sendMessage(message);

            expect(mockInput.fill).toHaveBeenCalledWith(message);
            expect(mockInput.press).toHaveBeenCalledWith('Enter');
            expect(response).toBe('Response text');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should fill the input, press Enter, and wait for a response" --reporter=verbose
```

:::

#### üß™ "should return null if waitForResponse is false"

::: {.callout-important appearance="simple"}
**‚ùå Failed (19.52ms)**

```
AssertionError: expected 'This is a response.' to be null
    at /home/sim/Obsi/Prods/01-pwf/agents/rsrch/tests/gemini-client.test.ts:208:30
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at file:///home/sim/.npm/_npx/69c381f8ad94b576/node_modules/@vitest/runner/dist/
```
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const message = 'Fire and forget';<br/>const response = await client.sendMessage#40;message, false#"]
    V1["Verify:<br/>expect#40;response#41;.toBeNull#40;#41;;<br/>expect#40;mockPage.waitForTimeout#41;.toHaveBeenCalledTimes#"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:205-211`](tests/gemini-client.test.ts)

```typescript
const message = 'Fire and forget';
            const response = await client.sendMessage(message, false);
            expect(response).toBeNull();
            // Ensure we don't wait for response
            expect(mockPage.waitForTimeout).toHaveBeenCalledTimes(1);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should return null if waitForResponse is false" --reporter=verbose
```

:::

#### üß™ "should return null and log an error if sending fails"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (8.35ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const message = 'This will fail';<br/>const mockInput = createMockLocator#40;true#41;;<br/>mockInput.press.mockRejectedValue#40;new Error#40;'Send fail...<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'div#91;contenteditable='true'#9"]
    S2["Setup:<br/>return mockInput;"]
    A3["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;"]
    S4["Setup:<br/>const response = await client.sendMessage#40;message#41;;"]
    V5["Verify:<br/>expect#40;response#41;.toBeNull#40;#41;;<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'send..."]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:213-229`](tests/gemini-client.test.ts)

```typescript
const message = 'This will fail';
            const mockInput = createMockLocator(true);
            mockInput.press.mockRejectedValue(new Error('Send failed')); // Simulate failure

            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('div[contenteditable="true"]')) {
                    return mockInput;
                }
                return createMockLocator(false);
            });

            const response = await client.sendMessage(message);

            expect(response).toBeNull();
            expect(client.dumpState).toHaveBeenCalledWith('send_message_fail');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should return null and log an error if sending fails" --reporter=verbose
```

:::

#### üß™ "should handle response stabilization"

::: {.callout-important appearance="simple"}
**‚ùå Failed (4.38ms)**

```
Error: Gemini requires authentication.
    at GeminiClient.checkAuth (/home/sim/Obsi/Prods/01-pwf/agents/rsrch/src/gemini-client.ts:239:19)
    at processTicksAndRejections (node:internal/process/task_queues:105:5)
    at GeminiClient.sendMessage (/home/sim/Obsi/Prods/01-pwf/agents/rsrch/src/gemini-
```
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockInput = createMockLocator#40;true#41;;<br/>const mockResponse = createMockLocator#40;true, 'Initial res...<br/>mockResponse.last = vi.fn#40;#41;.mockReturnThis#40;#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62<br/>if #40;selector.includes#40;'div#91;contenteditable='true'#9...<br/>if #40;selector.includes#40;'model-response'#41;#41; return ..."]
    A1["Act:<br/>return createMockLocator#40;true#41;;<br/>}#41;;"]
    S2["Setup:<br/>mockResponse.innerText<br/>.mockResolvedValueOnce#40;'Initial response'#41;<br/>.mockResolvedValueOnce#40;'Initial response, more text'#41;<br/>.mockResolvedValueOnce#40;'Initial response, more text'#41; ...<br/>.mockResolvedValueOnce#40;'Initial response, more text'#41;;..."]
    A3["Act:<br/>await client.sendMessage#40;'test'#41;;"]
    V4["Verify:<br/>expect#40;mockPage.waitForTimeout#41;.toHaveBeenCalled#40;#4"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:231-254`](tests/gemini-client.test.ts)

```typescript
const mockInput = createMockLocator(true);
            const mockResponse = createMockLocator(true, 'Initial response');
            mockResponse.last = vi.fn().mockReturnThis();


            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('div[contenteditable="true"]')) return mockInput;
                if (selector.includes('model-response')) return mockResponse;
                return createMockLocator(true);
            });

            // Simulate response text changing and then stabilizing
            mockResponse.innerText
                .mockResolvedValueOnce('Initial response')
                .mockResolvedValueOnce('Initial response, more text')
                .mockResolvedValueOnce('Initial response, more text') // Stable
                .mockResolvedValueOnce('Initial response, more text'); // Stable again

            await client.sendMessage('test');

            // waitForTimeout is called for stabilization checks
            expect(mockPage.waitForTimeout).toHaveBeenCalled();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "should handle response stabilization" --reporter=verbose
```

:::

#### üß™ "getResponses should return an array of all response texts"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.57ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockResponses = {<br/>count: vi.fn#40;#41;.mockResolvedValue#40;3#41;,"]
    A1["Act:<br/>nth: vi.fn#40;#40;i#41; =#62; {<br/>if #40;i === 0#41; return createMockLocator#40;true, 'Respon<br/>if #40;i === 1#41; return createMockLocator#40;true, 'Respon<br/>if #40;i === 2#41; return createMockLocator#40;true, 'Respon<br/>return createMockLocator#40;false#41;;<br/>}#41;,<br/>};"]
    S2["Setup:<br/>mockPage.locator.mockReturnValue#40;mockResponses#41;;<br/>const responses = await client.getResponses#40;#41;;"]
    V3["Verify:<br/>expect#40;responses#41;.toEqual#40;#91;'Response 1', 'Respon...<br/>expect#40;mockResponses.nth#41;.toHaveBeenCalledTimes#40;3#4"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:258-273`](tests/gemini-client.test.ts)

```typescript
const mockResponses = {
                count: vi.fn().mockResolvedValue(3),
                nth: vi.fn((i) => {
                    if (i === 0) return createMockLocator(true, 'Response 1');
                    if (i === 1) return createMockLocator(true, 'Response 2');
                    if (i === 2) return createMockLocator(true, 'Response 3');
                    return createMockLocator(false);
                }),
            };
            mockPage.locator.mockReturnValue(mockResponses);

            const responses = await client.getResponses();
            expect(responses).toEqual(['Response 1', 'Response 2', 'Response 3']);
            expect(mockResponses.nth).toHaveBeenCalledTimes(3);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getResponses should return an array of all response texts" --reporter=verbose
```

:::

#### üß™ "getLatestResponse should return the text of the last response"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.00ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockResponses = {<br/>count: vi.fn#40;#41;.mockResolvedValue#40;2#41;,<br/>nth: vi.fn#40;#41;.mockReturnThis#40;#41;,<br/>innerText: vi.fn#40;#41;.mockResolvedValue#40;'This is the l..."]
    A1["Act:<br/>};"]
    S2["Setup:<br/>mockPage.locator.mockImplementation#40;selector =#62; {"]
    A3["Act:<br/>if #40;selector.includes#40;'model-response'#41;#41; {"]
    S4["Setup:<br/>return mockResponses;"]
    A5["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;"]
    S6["Setup:<br/>const latest = await client.getLatestResponse#40;#41;;"]
    V7["Verify:<br/>expect#40;latest#41;.toBe#40;'This is the last one'#41;;<br/>expect#40;mockResponses.nth#41;.toHaveBeenCalledWith#40;1#41"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:275-292`](tests/gemini-client.test.ts)

```typescript
const mockResponses = {
                count: vi.fn().mockResolvedValue(2),
                nth: vi.fn().mockReturnThis(),
                innerText: vi.fn().mockResolvedValue('This is the last one'),
            };

            mockPage.locator.mockImplementation(selector => {
                if (selector.includes('model-response')) {
                    return mockResponses;
                }
                return createMockLocator(false);
            });

            const latest = await client.getLatestResponse();
            expect(latest).toBe('This is the last one');
            expect(mockResponses.nth).toHaveBeenCalledWith(1);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getLatestResponse should return the text of the last response" --reporter=verbose
```

:::

#### üß™ "getLatestResponse should return null if no responses are found"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.64ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockReturnValue#40;createMockLocator#40;fal<br/>const latest = await client.getLatestResponse#40;#41;;"]
    V1["Verify:<br/>expect#40;latest#41;.toBeNull#40;#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:295-299`](tests/gemini-client.test.ts)

```typescript
mockPage.locator.mockReturnValue(createMockLocator(false));
            const latest = await client.getLatestResponse();
            expect(latest).toBeNull();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getLatestResponse should return null if no responses are found" --reporter=verbose
```

:::

#### üß™ "getResponse should retrieve responses by positive and negative index"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3.56ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockResponses = {<br/>count: vi.fn#40;#41;.mockResolvedValue#40;3#41;,"]
    A1["Act:<br/>nth: vi.fn#40;#40;i#41; =#62; {<br/>if #40;i === 0#41; return createMockLocator#40;true, 'First'<br/>if #40;i === 1#41; return createMockLocator#40;true, 'Second<br/>if #40;i === 2#41; return createMockLocator#40;true, 'Third'<br/>return createMockLocator#40;false#41;;<br/>}#41;,<br/>};"]
    S2["Setup:<br/>mockPage.locator.mockReturnValue#40;mockResponses#41;;"]
    V3["Verify:<br/>expect#40;await client.getResponse#40;1#41;#41;.toBe#40;'Fir<br/>expect#40;await client.getResponse#40;3#41;#41;.toBe#40;'Thi<br/>expect#40;await client.getResponse#40;-1#41;#41;.toBe#40;'Th<br/>expect#40;await client.getResponse#40;-3#41;#41;.toBe#40;'Fi<br/>expect#40;await client.getResponse#40;4#41;#41;.toBeNull#40;<br/>expect#40;await client.getResponse#40;-4#41;#41;.toBeNull#40"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:301-324`](tests/gemini-client.test.ts)

```typescript
const mockResponses = {
                count: vi.fn().mockResolvedValue(3),
                nth: vi.fn((i) => {
                    if (i === 0) return createMockLocator(true, 'First');
                    if (i === 1) return createMockLocator(true, 'Second');
                    if (i === 2) return createMockLocator(true, 'Third');
                    return createMockLocator(false);
                }),
            };
            mockPage.locator.mockReturnValue(mockResponses);

            // Test positive index (1-based)
            expect(await client.getResponse(1)).toBe('First');
            expect(await client.getResponse(3)).toBe('Third');

            // Test negative index
            expect(await client.getResponse(-1)).toBe('Third');
            expect(await client.getResponse(-3)).toBe('First');

            // Test out of bounds
            expect(await client.getResponse(4)).toBeNull();
            expect(await client.getResponse(-4)).toBeNull();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getResponse should retrieve responses by positive and negative index" --reporter=verbose
```

:::

#### üß™ "listSessions should return an empty array on failure"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3.12ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;#41; =#62; {"]
    A1["Act:<br/>throw new Error#40;'Failed to find session list'#41;;<br/>}#41;;"]
    S2["Setup:<br/>const sessions = await client.listSessions#40;#41;;"]
    V3["Verify:<br/>expect#40;sessions#41;.toEqual#40;#91;#93;#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:328-334`](tests/gemini-client.test.ts)

```typescript
mockPage.locator.mockImplementation(() => {
                throw new Error('Failed to find session list');
            });
            const sessions = await client.listSessions();
            expect(sessions).toEqual([]);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "listSessions should return an empty array on failure" --reporter=verbose
```

:::

#### üß™ "getLatestResponse should return null on failure"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.20ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;#41; =#62; {<br/>const locator = createMockLocator#40;true#41;;<br/>locator.innerText.mockRejectedValue#40;new Error#40;'Cannot ..."]
    A1["Act:<br/>return locator;<br/>}#41;;"]
    S2["Setup:<br/>const response = await client.getLatestResponse#40;#41;;"]
    V3["Verify:<br/>expect#40;response#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:336-344`](tests/gemini-client.test.ts)

```typescript
mockPage.locator.mockImplementation(() => {
                const locator = createMockLocator(true);
                locator.innerText.mockRejectedValue(new Error('Cannot read text'));
                return locator;
            });
            const response = await client.getLatestResponse();
            expect(response).toBeNull();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "getLatestResponse should return null on failure" --reporter=verbose
```

:::

#### üß™ "exportToGoogleDocs should return null values on failure"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3.26ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'Export menu'#41; #124;#124; sel...<br/>return createMockLocator#40;false#41;;<br/>}<br/>return createMockLocator#40;true#41;;<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.exportCurrentToGoogleDocs#40;#41"]
    V3["Verify:<br/>expect#40;result#41;.toEqual#40;{ docId: null, docUrl: null,...<br/>expect#40;client.dumpState#41;.toHaveBeenCalledWith#40;'expo..."]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:346-358`](tests/gemini-client.test.ts)

```typescript
mockPage.locator.mockImplementation((selector) => {
                // Make export button not visible/found
                if (selector.includes('Export menu') || selector.includes('Nab√≠dka pro export')) {
                    return createMockLocator(false);
                }
                return createMockLocator(true);
            });

            const result = await client.exportCurrentToGoogleDocs();
            expect(result).toEqual({ docId: null, docUrl: null, docTitle: null });
            expect(client.dumpState).toHaveBeenCalledWith('export_button_not_found');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "exportToGoogleDocs should return null values on failure" --reporter=verbose
```

:::

#### üß™ "listSessions should scroll to load more sessions if initial count is less than target"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3.27ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>let callCount = 0;<br/>const mockSessionLocator = {"]
    A1["Act:<br/>...createMockLocator#40;true, 'Session'#41;,<br/>count: vi.fn#40;#40;#41; =#62; {<br/>callCount++;<br/>return Promise.resolve#40;callCount === 1 ? 10 : 20#41;;<br/>}#41;,"]
    S2["Setup:<br/>last: vi.fn#40;#41;.mockReturnThis#40;#41;,<br/>scrollIntoViewIfNeeded: vi.fn#40;#41;.mockResolvedValue#40;u..."]
    A3["Act:<br/>};"]
    S4["Setup:<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A5["Act:<br/>if #40;selector.includes#40;'div.conversation'#41;#41; {"]
    S6["Setup:<br/>return mockSessionLocator;"]
    A7["Act:<br/>}<br/>if #40;selector.includes#40;'Show more'#41;#41; {<br/>return createMockLocator#40;false#41;;<br/>}<br/>return createMockLocator#40;true#41;;<br/>}#41;;<br/>await client.listSessions#40;20, 0#41;;"]
    V8["Verify:<br/>expect#40;mockSessionLocator.scrollIntoViewIfNeeded#41;.toHa...<br/>expect#40;mockSessionLocator.count#41;.toHaveBeenCalledTimes"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> A7
    A7 --> V8

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:362-388`](tests/gemini-client.test.ts)

```typescript
let callCount = 0;
            const mockSessionLocator = {
                ...createMockLocator(true, 'Session'),
                count: vi.fn(() => {
                    callCount++;
                    return Promise.resolve(callCount === 1 ? 10 : 20);
                }),
                last: vi.fn().mockReturnThis(),
                scrollIntoViewIfNeeded: vi.fn().mockResolvedValue(undefined),
            };

            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('div.conversation')) {
                    return mockSessionLocator;
                }
                if (selector.includes('Show more')) {
                    return createMockLocator(false);
                }
                return createMockLocator(true);
            });

            await client.listSessions(20, 0);

            expect(mockSessionLocator.scrollIntoViewIfNeeded).toHaveBeenCalled();
            expect(mockSessionLocator.count).toHaveBeenCalledTimes(2);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "listSessions should scroll to load more sessions if initial count is less than target" --reporter=verbose
```

:::

#### üß™ "listSessions should click "Show more" button if visible"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (6.23ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockSessionLocator = createMockLocator#40;true, 'Sessi...<br/>mockSessionLocator.count.mockResolvedValue#40;5#41;;<br/>const mockShowMoreButton = createMockLocator#40;true#41;;<br/>mockPage.locator.mockImplementation#40;#40;selector#41; =#62"]
    A1["Act:<br/>if #40;selector.includes#40;'div.conversation'#41;#41; {"]
    S2["Setup:<br/>return mockSessionLocator;"]
    A3["Act:<br/>}<br/>if #40;selector.includes#40;'Show more'#41; #124;#124; selec..."]
    S4["Setup:<br/>return mockShowMoreButton;"]
    A5["Act:<br/>}<br/>return createMockLocator#40;false#41;;<br/>}#41;;<br/>await client.listSessions#40;10, 0#41;;"]
    V6["Verify:<br/>expect#40;mockShowMoreButton.click#41;.toHaveBeenCalled#40;#"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> V6

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.test.ts:390-408`](tests/gemini-client.test.ts)

```typescript
const mockSessionLocator = createMockLocator(true, 'Session');
            mockSessionLocator.count.mockResolvedValue(5);
            const mockShowMoreButton = createMockLocator(true);

            mockPage.locator.mockImplementation((selector) => {
                if (selector.includes('div.conversation')) {
                    return mockSessionLocator;
                }
                if (selector.includes('Show more') || selector.includes('Zobrazit v√≠ce')) {
                    return mockShowMoreButton;
                }
                return createMockLocator(false);
            });

            await client.listSessions(10, 0);

            expect(mockShowMoreButton.click).toHaveBeenCalled();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.test.ts -t "listSessions should click \"Show more\" button if visible" --reporter=verbose
```

:::

---

### üìÅ `e2e/gemini.test.ts` <small>(Unit/Mapped)</small>

#### üß™ "should navigate to Gemini and verify login status"

::: {.callout-warning appearance="simple"}
**‚è≠Ô∏è skipped**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await page.goto#40;'https://gemini.google.com/app', { waitUn...<br/>await page.waitForTimeout#40;2000#41;;"]
    S1["Setup:<br/>const url = page.url#40;#41;;<br/>const isLoginPage = url.includes#40;'accounts.google.com'#41"]
    A2["Act:<br/>await page.screenshot#40;{ path: path.join#40;SNAPSHOT_DIR, ...<br/>if #40;isLoginPage#41; {<br/>console.warn#40;'Browser is not logged in. Skipping function...<br/>}"]
    V3["Verify:<br/>expect#40;isLoginPage, 'Should be logged in to Gemini'#41;.t..."]
    A0 --> S1
    S1 --> A2
    A2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/e2e/gemini.test.ts:45-60`](tests/e2e/gemini.test.ts)

```typescript
await page.goto('https://gemini.google.com/app', { waitUntil: 'domcontentloaded', timeout: 60000 });
        await page.waitForTimeout(2000);

        const url = page.url();
        const isLoginPage = url.includes('accounts.google.com');

        // Take a screenshot for debugging
        await page.screenshot({ path: path.join(SNAPSHOT_DIR, 'login_status.png') });

        if (isLoginPage) {
            console.warn('Browser is not logged in. Skipping functionality tests.');
        }

        expect(isLoginPage, 'Should be logged in to Gemini').toBe(false);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/e2e/gemini.test.ts -t "should navigate to Gemini and verify login status" --reporter=verbose
```

:::

#### üß™ "should parse an existing research session"

::: {.callout-warning appearance="simple"}
**‚è≠Ô∏è skipped**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>if #40;page.url#40;#41;.includes#40;'accounts.google.com'#41"]
    S1["Setup:<br/>const targetSessionId = process.env.TEST_SESSION_ID;"]
    A2["Act:<br/>if #40;targetSessionId#41; {<br/>console.log#40;'Navigating to target session: ${targetSessio..."]
    S3["Setup:<br/>const parsed = await gemini.parseResearch#40;targetSessionId"]
    V4["Verify:<br/>expect#40;parsed#41;.toBeDefined#40;#41;;<br/>expect#40;parsed?.title#41;.toBeTruthy#40;#41;;<br/>expect#40;parsed?.content.length#41;.toBeGreaterThan#40;0#41"]
    A5["Act:<br/>} else {<br/>console.log#40;'Searching for a research session in sidebar...."]
    S6["Setup:<br/>const menuBtn = page.locator#40;'button#91;aria-label*='Hlav..."]
    A7["Act:<br/>if #40;await menuBtn.count#40;#41; #62; 0 #38;#38; await men...<br/>await menuBtn.click#40;#41;;<br/>await page.waitForTimeout#40;1000#41;;<br/>}"]
    S8["Setup:<br/>const chatItems = page.locator#40;'a#91;href*='/app/'#93;, ....<br/>const count = await chatItems.count#40;#41;;<br/>let researchSessionFound = false;<br/>for #40;let i = 0; i #60; Math.min#40;count, 10#41;; i++#41;<br/>const item = chatItems.nth#40;i#41;;<br/>const text = await item.textContent#40;#41;;"]
    A9["Act:<br/>if #40;text #38;#38; #40;text.includes#40;'Deep'#41; #124;#1...<br/>console.log#40;'Found candidate session: ${text}'#41;;<br/>await item.click#40;#41;;<br/>await page.waitForTimeout#40;3000#41;;"]
    S10["Setup:<br/>const parsed = await gemini.parseResearch#40;#41;;"]
    A11["Act:<br/>if #40;parsed#41; {<br/>researchSessionFound = true;"]
    V12["Verify:<br/>expect#40;parsed.title#41;.toBeTruthy#40;#41;;<br/>expect#40;parsed.headings.length#41;.toBeGreaterThanOrEqual#"]
    A13["Act:<br/>break;<br/>}<br/>}<br/>}<br/>if #40;!researchSessionFound#41; {<br/>console.warn#40;'No specific research session found in top 1..."]
    S14["Setup:<br/>const parsed = await gemini.parseResearch#40;#41;;"]
    A15["Act:<br/>}<br/>}"]
    A0 --> S1
    S1 --> A2
    A2 --> S3
    S3 --> V4
    V4 --> A5
    A5 --> S6
    S6 --> A7
    A7 --> S8
    S8 --> A9
    A9 --> S10
    S10 --> A11
    A11 --> V12
    V12 --> A13
    A13 --> S14
    S14 --> A15

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/e2e/gemini.test.ts:62-120`](tests/e2e/gemini.test.ts)

```typescript
// Skip if we failed the login check (assertions in beforeAll logic would be better but keeping simple flow)
        if (page.url().includes('accounts.google.com')) return;

        // Try to navigate to a specific known session if provided, otherwise search for one
        // Using the ID from the script as a fallback example, or we can make this dynamic
        const targetSessionId = process.env.TEST_SESSION_ID;

        if (targetSessionId) {
            console.log(`Navigating to target session: ${targetSessionId}`);
            const parsed = await gemini.parseResearch(targetSessionId);
            expect(parsed).toBeDefined();
            expect(parsed?.title).toBeTruthy();
            expect(parsed?.content.length).toBeGreaterThan(0);
        } else {
            // Find a research session dynamically
            console.log('Searching for a research session in sidebar...');

            // Open menu if needed
            const menuBtn = page.locator('button[aria-label*="Hlavn√≠ nab√≠dka"], button[aria-label*="Main menu"]').first();
            if (await menuBtn.count() > 0 && await menuBtn.isVisible()) {
                await menuBtn.click();
                await page.waitForTimeout(1000);
            }

            const chatItems = page.locator('a[href*="/app/"], .conversation');
            const count = await chatItems.count();

            let researchSessionFound = false;

            for (let i = 0; i < Math.min(count, 10); i++) {
                const item = chatItems.nth(i);
                const text = await item.textContent();

                if (text && (text.includes('Deep') || text.includes('Research') || text.includes('Dive') || text.includes('Analysis'))) {
                    console.log(`Found candidate session: ${text}`);
                    await item.click();
                    await page.waitForTimeout(3000);

                    // Try parsing
                    const parsed = await gemini.parseResearch();
                    if (parsed) {
                        researchSessionFound = true;
                        expect(parsed.title).toBeTruthy();
                        expect(parsed.headings.length).toBeGreaterThanOrEqual(0);
                        break;
                    }
                }
            }

            if (!researchSessionFound) {
                console.warn('No specific research session found in top 10 items. Testing on current page.');
                // Just try parsing whatever is open
                const parsed = await gemini.parseResearch();
                // We might fail gracefully or return null, so checking expectations carefully
                // If it returns null, it means it couldn't find research structure
            }
        }
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/e2e/gemini.test.ts -t "should parse an existing research session" --reporter=verbose
```

:::

---

### üìÅ `selectors.test.ts` <small>(Unit/Mapped)</small>

#### üß™ "should return default selectors when selectors.yaml does not exist"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (5.12ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;false#41;;<br/>const result = reloadSelectors#40;#41;;"]
    V1["Verify:<br/>expect#40;result.home.createNewButton#41;.toBe#40;'.create-n...<br/>expect#40;result.notebook.titleInput#41;.toBe#40;'input.titl...<br/>expect#40;fs.existsSync#41;.toHaveBeenCalled#40;#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/selectors.test.ts:33-45`](tests/selectors.test.ts)

```typescript
vi.mocked(fs.existsSync).mockReturnValue(false);

      // Force reload to verify loading logic
      const result = reloadSelectors();

      // Verify defaults are returned
      expect(result.home.createNewButton).toBe('.create-new-button');
      expect(result.notebook.titleInput).toBe('input.title-input');

      // Verify fs.existsSync was called
      expect(fs.existsSync).toHaveBeenCalled();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should return default selectors when selectors.yaml does not exist" --reporter=verbose
```

:::

#### üß™ "should load and merge selectors from selectors.yaml when it exists"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (11.59ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;true#41;;<br/>const mockYamlContent = '"]
    A1["Act:<br/>home:<br/>createNewButton: '.custom-new-button'<br/>projectButton: 'custom-project-button'<br/>projectButtonTitle: '.custom-title'<br/>projectCard: 'custom-card'<br/>primaryActionButton: '.custom-action'<br/>notebook:<br/>titleInput: '.custom-title-input'<br/>urlPattern: '**/custom/**'<br/>';"]
    S2["Setup:<br/>vi.mocked#40;fs.readFileSync#41;.mockReturnValue#40;mockYaml<br/>const result = reloadSelectors#40;#41;;"]
    V3["Verify:<br/>expect#40;result.home.createNewButton#41;.toBe#40;'.custom-n...<br/>expect#40;result.notebook.titleInput#41;.toBe#40;'.custom-ti...<br/>expect#40;result.sources.tab#41;.toBe#40;'div#91;role='tab'#"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/selectors.test.ts:47-72`](tests/selectors.test.ts)

```typescript
vi.mocked(fs.existsSync).mockReturnValue(true);

      const mockYamlContent = `
home:
  createNewButton: '.custom-new-button'
  projectButton: 'custom-project-button'
  projectButtonTitle: '.custom-title'
  projectCard: 'custom-card'
  primaryActionButton: '.custom-action'
notebook:
  titleInput: '.custom-title-input'
  urlPattern: '**/custom/**'
`;
      vi.mocked(fs.readFileSync).mockReturnValue(mockYamlContent);

      // Force reload to pick up new mocks
      const result = reloadSelectors();

      // Verify custom values are loaded
      expect(result.home.createNewButton).toBe('.custom-new-button');
      expect(result.notebook.titleInput).toBe('.custom-title-input');

      // Verify parts not in YAML still have defaults (shallow merge at top level)
      expect(result.sources.tab).toBe('div[role="tab"]');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should load and merge selectors from selectors.yaml when it exists" --reporter=verbose
```

:::

#### üß™ "should fall back to defaults when loading fails (e.g. read error)"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.40ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;true#41;;<br/>vi.mocked#40;fs.readFileSync#41;.mockImplementation#40;#40;#"]
    A1["Act:<br/>throw new Error#40;'Read failed'#41;;<br/>}#41;;"]
    S2["Setup:<br/>const consoleSpy = vi.spyOn#40;console, 'error'#41;.mockImpl...<br/>const result = reloadSelectors#40;#41;;"]
    V3["Verify:<br/>expect#40;result.home.createNewButton#41;.toBe#40;'.create-n...<br/>expect#40;consoleSpy#41;.toHaveBeenCalled#40;#41;;"]
    S4["Setup:<br/>consoleSpy.mockRestore#40;#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> S4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/selectors.test.ts:74-91`](tests/selectors.test.ts)

```typescript
vi.mocked(fs.existsSync).mockReturnValue(true);

      // Simulate an error during read
      vi.mocked(fs.readFileSync).mockImplementation(() => {
        throw new Error('Read failed');
      });

      // Spy on console.error to suppress output during test
      const consoleSpy = vi.spyOn(console, 'error').mockImplementation(() => {});

      const result = reloadSelectors();

      expect(result.home.createNewButton).toBe('.create-new-button');
      expect(consoleSpy).toHaveBeenCalled();

      consoleSpy.mockRestore();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should fall back to defaults when loading fails (e.g. read error)" --reporter=verbose
```

:::

#### üß™ "should force reload of selectors and invalidate cache"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (6.72ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>vi.mocked#40;fs.existsSync#41;.mockReturnValue#40;true#41;;<br/>let callCount = 0;<br/>vi.mocked#40;fs.readFileSync#41;.mockImplementation#40;#40;#"]
    A1["Act:<br/>callCount++;<br/>return '<br/>home:<br/>createNewButton: '.button-${callCount}'<br/>projectButton: 'b'<br/>projectButtonTitle: 'c'<br/>projectCard: 'd'<br/>primaryActionButton: 'e'<br/>';<br/>}#41;;"]
    S2["Setup:<br/>const first = reloadSelectors#40;#41;;"]
    V3["Verify:<br/>expect#40;first.home.createNewButton#41;.toBe#40;'.button-1'<br/>expect#40;callCount#41;.toBe#40;1#41;;"]
    S4["Setup:<br/>const second = loadSelectors#40;#41;;"]
    V5["Verify:<br/>expect#40;second.home.createNewButton#41;.toBe#40;'.button-1<br/>expect#40;callCount#41;.toBe#40;1#41;;"]
    S6["Setup:<br/>const third = reloadSelectors#40;#41;;"]
    V7["Verify:<br/>expect#40;third.home.createNewButton#41;.toBe#40;'.button-2'<br/>expect#40;callCount#41;.toBe#40;2#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> S4
    S4 --> V5
    V5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/selectors.test.ts:95-126`](tests/selectors.test.ts)

```typescript
vi.mocked(fs.existsSync).mockReturnValue(true);

      // Mock readFileSync to return different values on consecutive calls
      let callCount = 0;
      vi.mocked(fs.readFileSync).mockImplementation(() => {
        callCount++;
        return `
home:
  createNewButton: '.button-${callCount}'
  projectButton: 'b'
  projectButtonTitle: 'c'
  projectCard: 'd'
  primaryActionButton: 'e'
`;
      });

      // First load (via reloadSelectors to ensure clean start)
      const first = reloadSelectors();
      expect(first.home.createNewButton).toBe('.button-1');
      expect(callCount).toBe(1);

      // Second load via loadSelectors should use cache
      const second = loadSelectors();
      expect(second.home.createNewButton).toBe('.button-1');
      expect(callCount).toBe(1);

      // reloadSelectors should force a new read
      const third = reloadSelectors();
      expect(third.home.createNewButton).toBe('.button-2');
      expect(callCount).toBe(2);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should force reload of selectors and invalidate cache" --reporter=verbose
```

:::

#### üß™ "should trigger loadSelectors when accessing a property"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.79ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const homeSelectors = selectors.home;"]
    V1["Verify:<br/>expect#40;homeSelectors.createNewButton#41;.toBe#40;'.create..."]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/selectors.test.ts:130-137`](tests/selectors.test.ts)

```typescript
// Accessing selectors.home should trigger the loading mechanism.
      // Since beforeEach set up defaults, this should work.
      // We are verifying that the proxy correctly accesses the underlying loaded object.

      const homeSelectors = selectors.home;
      expect(homeSelectors.createNewButton).toBe('.create-new-button');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/selectors.test.ts -t "should trigger loadSelectors when accessing a property" --reporter=verbose
```

:::

---

### üìÅ `graph.test.ts` <small>(Unit/Mapped)</small>

#### üß™ "should be tested in graph-store.test.ts"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.83ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;true#41;.toBe#40;true#41;;"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/graph.test.ts:37-41`](tests/graph.test.ts)

```typescript
// Actual GraphStore tests are in graph-store.test.ts
      // This file only contains CLI command tests which require full integration
      expect(true).toBe(true);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/graph.test.ts -t "should be tested in graph-store.test.ts" --reporter=verbose
```

:::

---

### üìÅ `artifact-registry.test.ts` <small>(Unit/Mapped)</small>

#### üß™ "should generate unique 3-character base IDs"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.88ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const ids = new Set#60;string#62;#40;#41;;<br/>for #40;let i = 0; i #60; 100; i++#41; {"]
    A1["Act:<br/>ids.add#40;registry.generateBaseId#40;#41;#41;;<br/>}"]
    V2["Verify:<br/>expect#40;ids.size#41;.toBe#40;100#41;;<br/>expect#40;#91;...ids#93;#91;0#93;.length#41;.toBe#40;3#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:31-38`](tests/artifact-registry.test.ts)

```typescript
const ids = new Set<string>();
        for (let i = 0; i < 100; i++) {
            ids.add(registry.generateBaseId());
        }
        expect(ids.size).toBe(100);
        expect([...ids][0].length).toBe(3);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should generate unique 3-character base IDs" --reporter=verbose
```

:::

#### üß™ "should register and retrieve a session"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.41ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'gemini-sessio..."]
    V1["Verify:<br/>expect#40;sessionId.length#41;.toBe#40;3#41;;"]
    S2["Setup:<br/>const session = registry.get#40;sessionId#41;;"]
    V3["Verify:<br/>expect#40;session#41;.toBeDefined#40;#41;;<br/>expect#40;session?.type#41;.toBe#40;'session'#41;;<br/>expect#40;session?.query#41;.toBe#40;'History of Espresso'#4"]
    S0 --> V1
    V1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:40-48`](tests/artifact-registry.test.ts)

```typescript
const sessionId = registry.registerSession('gemini-session-abc', 'History of Espresso');
        expect(sessionId.length).toBe(3);

        const session = registry.get(sessionId);
        expect(session).toBeDefined();
        expect(session?.type).toBe('session');
        expect(session?.query).toBe('History of Espresso');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should register and retrieve a session" --reporter=verbose
```

:::

#### üß™ "should register and retrieve a document"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.86ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Q1'#41;<br/>const docId = registry.registerDocument#40;sessionId, 'gdoc-..."]
    V1["Verify:<br/>expect#40;docId#41;.toMatch#40;/^#91;A-Z0-9#93;{3}-\d{2}$/#4<br/>expect#40;docId.startsWith#40;sessionId#41;#41;.toBe#40;true"]
    S2["Setup:<br/>const doc = registry.get#40;docId#41;;"]
    V3["Verify:<br/>expect#40;doc#41;.toBeDefined#40;#41;;<br/>expect#40;doc?.type#41;.toBe#40;'document'#41;;<br/>expect#40;doc?.parentId#41;.toBe#40;sessionId#41;;"]
    S0 --> V1
    V1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:50-61`](tests/artifact-registry.test.ts)

```typescript
const sessionId = registry.registerSession('s1', 'Q1');
        const docId = registry.registerDocument(sessionId, 'gdoc-123', 'Deep Research on Coffee');

        expect(docId).toMatch(/^[A-Z0-9]{3}-\d{2}$/);
        expect(docId.startsWith(sessionId)).toBe(true);

        const doc = registry.get(docId);
        expect(doc).toBeDefined();
        expect(doc?.type).toBe('document');
        expect(doc?.parentId).toBe(sessionId);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should register and retrieve a document" --reporter=verbose
```

:::

#### üß™ "should register and retrieve audio with incrementing suffixes"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.88ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Q1'#41;<br/>const docId = registry.registerDocument#40;sessionId, 'd1', ...<br/>const audioId1 = registry.registerAudio#40;docId, 'Notebook'...<br/>const audioId2 = registry.registerAudio#40;docId, 'Notebook'..."]
    V1["Verify:<br/>expect#40;audioId1#41;.toMatch#40;/^#91;A-Z0-9#93;{3}-\d{2}-<br/>expect#40;audioId2#41;.toMatch#40;/^#91;A-Z0-9#93;{3}-\d{2}-"]
    S2["Setup:<br/>const audio = registry.get#40;audioId1#41;;"]
    V3["Verify:<br/>expect#40;audio#41;.toBeDefined#40;#41;;<br/>expect#40;audio?.type#41;.toBe#40;'audio'#41;;"]
    S0 --> V1
    V1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:63-76`](tests/artifact-registry.test.ts)

```typescript
const sessionId = registry.registerSession('s1', 'Q1');
        const docId = registry.registerDocument(sessionId, 'd1', 'title');

        const audioId1 = registry.registerAudio(docId, 'Notebook', 'Overview 1');
        const audioId2 = registry.registerAudio(docId, 'Notebook', 'Overview 2');

        expect(audioId1).toMatch(/^[A-Z0-9]{3}-\d{2}-A$/);
        expect(audioId2).toMatch(/^[A-Z0-9]{3}-\d{2}-B$/);

        const audio = registry.get(audioId1);
        expect(audio).toBeDefined();
        expect(audio?.type).toBe('audio');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should register and retrieve audio with incrementing suffixes" --reporter=verbose
```

:::

#### üß™ "should track lineage correctly"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.92ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Q1'#41;<br/>const docId = registry.registerDocument#40;sessionId, 'd1', ...<br/>const audioId = registry.registerAudio#40;docId, 'N1', 'A1'#<br/>const lineage = registry.getLineage#40;audioId#41;;"]
    V1["Verify:<br/>expect#40;lineage.length#41;.toBe#40;3#41;;<br/>expect#40;lineage#91;0#93;.type#41;.toBe#40;'audio'#41;;<br/>expect#40;lineage#91;1#93;.type#41;.toBe#40;'document'#41;;<br/>expect#40;lineage#91;2#93;.type#41;.toBe#40;'session'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:78-88`](tests/artifact-registry.test.ts)

```typescript
const sessionId = registry.registerSession('s1', 'Q1');
        const docId = registry.registerDocument(sessionId, 'd1', 'D1');
        const audioId = registry.registerAudio(docId, 'N1', 'A1');

        const lineage = registry.getLineage(audioId);
        expect(lineage.length).toBe(3);
        expect(lineage[0].type).toBe('audio');
        expect(lineage[1].type).toBe('document');
        expect(lineage[2].type).toBe('session');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should track lineage correctly" --reporter=verbose
```

:::

#### üß™ "should persist data to disk"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.53ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const sessionId = registry.registerSession#40;'s1', 'Persist...<br/>const registry2 = new ArtifactRegistry#40;TEST_DIR#41;;"]
    A1["Act:<br/>registry2.load#40;#41;;"]
    S2["Setup:<br/>const session = registry2.get#40;sessionId#41;;"]
    V3["Verify:<br/>expect#40;session#41;.toBeDefined#40;#41;;<br/>expect#40;session?.query#41;.toBe#40;'Persist Test'#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:90-99`](tests/artifact-registry.test.ts)

```typescript
const sessionId = registry.registerSession('s1', 'Persist Test');

        const registry2 = new ArtifactRegistry(TEST_DIR);
        registry2.load();

        const session = registry2.get(sessionId);
        expect(session).toBeDefined();
        expect(session?.query).toBe('Persist Test');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should persist data to disk" --reporter=verbose
```

:::

#### üß™ "should list artifacts by type"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.61ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const s1 = registry.registerSession#40;'s1', 'Q1'#41;;"]
    A1["Act:<br/>registry.registerDocument#40;s1, 'd1', 'D1'#41;;<br/>registry.registerAudio#40;'s1-01', 'N1', 'A1'#41;;"]
    V2["Verify:<br/>expect#40;registry.listByType#40;'session'#41;.length#41;.to<br/>expect#40;registry.listByType#40;'document'#41;.length#41;.t<br/>expect#40;registry.listByType#40;'audio'#41;.length#41;.toBe"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/artifact-registry.test.ts:101-109`](tests/artifact-registry.test.ts)

```typescript
const s1 = registry.registerSession('s1', 'Q1');
        registry.registerDocument(s1, 'd1', 'D1');
        registry.registerAudio('s1-01', 'N1', 'A1');

        expect(registry.listByType('session').length).toBe(1);
        expect(registry.listByType('document').length).toBe(1);
        expect(registry.listByType('audio').length).toBe(1);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/artifact-registry.test.ts -t "should list artifacts by type" --reporter=verbose
```

:::

---

### üìÅ `windmill.test.ts` <small>(Unit/Mapped)</small>

#### üß™ "should trigger audio generation and update graph state"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>server.use#40;<br/>http.post#40;'${RSRCH_URL}/graph/execute', async #40;{ reque..."]
    S1["Setup:<br/>const body = await request.json#40;#41;;"]
    A2["Act:<br/>if #40;body.query.includes#40;'CREATE #40;pa:PendingAudio'#4<br/>return HttpResponse.json#40;{ notebookId: 'notebook-123' }#4<br/>}<br/>return HttpResponse.json#40;{}#41;;<br/>}#41;,<br/>http.post#40;'${RSRCH_URL}/notebooklm/generate-audio', #40;#<br/>return HttpResponse.json#40;{ success: true }#41;;<br/>}#41;,<br/>http.post#40;'${NTFY_URL}/${NTFY_TOPIC}', #40;#41; =#62; {<br/>return new HttpResponse#40;null, { status: 200 }#41;;<br/>}#41;<br/>#41;;"]
    S3["Setup:<br/>const result = await clickGenerateAudio#40;{"]
    A4["Act:<br/>notebook_title: 'My Notebook',<br/>source_title: 'My Source',<br/>}#41;;"]
    V5["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.notebook_id#41;.toBe#40;'notebook-123'#41;;<br/>expect#40;result.source_title#41;.toBe#40;'My Source'#41;;<br/>expect#40;result.pending_audio_id#41;.toMatch#40;/^pending_a"]
    A0 --> S1
    S1 --> A2
    A2 --> S3
    S3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/windmill.test.ts:25-52`](tests/windmill.test.ts)

```typescript
// Mock graph execute calls
      server.use(
        http.post(`${RSRCH_URL}/graph/execute`, async ({ request }) => {
          const body = await request.json();
          if (body.query.includes('CREATE (pa:PendingAudio')) {
            return HttpResponse.json({ notebookId: 'notebook-123' });
          }
          return HttpResponse.json({});
        }),
        http.post(`${RSRCH_URL}/notebooklm/generate-audio`, () => {
          return HttpResponse.json({ success: true });
        }),
        http.post(`${NTFY_URL}/${NTFY_TOPIC}`, () => {
          return new HttpResponse(null, { status: 200 });
        })
      );

      const result = await clickGenerateAudio({
        notebook_title: 'My Notebook',
        source_title: 'My Source',
      });

      expect(result.success).toBe(true);
      expect(result.notebook_id).toBe('notebook-123');
      expect(result.source_title).toBe('My Source');
      expect(result.pending_audio_id).toMatch(/^pending_audio_/);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should trigger audio generation and update graph state" --reporter=verbose
```

:::

#### üß™ "should match a completed audio file and update the graph"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const pendingAudio = {"]
    A1["Act:<br/>id: 'pending-123',<br/>notebookId: 'notebook-123',<br/>sourceTitle: 'A very long source title that will be truncate...<br/>startedAt: Date.now#40;#41; - 10000,<br/>};"]
    S2["Setup:<br/>const completedAudio = {"]
    A3["Act:<br/>id: 'audio-456',<br/>title: 'Audio for 'A very long source title...'',<br/>sourceCount: 1,<br/>correlationId: pendingAudio.id,<br/>};<br/>server.use#40;<br/>http.post#40;'${RSRCH_URL}/graph/execute', async #40;{ reque..."]
    S4["Setup:<br/>const body = await request.json#40;#41;;"]
    A5["Act:<br/>if #40;body.query.includes#40;'MATCH #40;pa:PendingAudio'#41<br/>return HttpResponse.json#40;#91;<br/>#91;pendingAudio.id, pendingAudio.notebookId, pendingAudio.s...<br/>#93;#41;;<br/>}<br/>if #40;body.query.includes#40;'DETACH DELETE pa'#41;#41; {<br/>return HttpResponse.json#40;{ success: true }#41;;<br/>}<br/>return HttpResponse.json#40;{}#41;;<br/>}#41;,<br/>http.post#40;'${RSRCH_URL}/notebook/list', #40;#41; =#62; {<br/>return HttpResponse.json#40;{<br/>success: true,<br/>data: #91;{<br/>id: 'notebook-123',<br/>audioOverviews: #91;completedAudio#93;,<br/>}#93;,<br/>}#41;;<br/>}#41;,<br/>http.post#40;'${NTFY_URL}/${NTFY_TOPIC}', #40;#41; =#62; new...<br/>#41;;"]
    S6["Setup:<br/>const result = await watchAudioCompletion#40;#41;;"]
    V7["Verify:<br/>expect#40;result.processed#41;.toBe#40;1#41;;<br/>expect#40;result.completed#41;.toBe#40;1#41;;<br/>expect#40;result.failed#41;.toBe#40;0#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> S4
    S4 --> A5
    A5 --> S6
    S6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/windmill.test.ts:56-105`](tests/windmill.test.ts)

```typescript
const pendingAudio = {
        id: 'pending-123',
        notebookId: 'notebook-123',
        sourceTitle: 'A very long source title that will be truncated',
        startedAt: Date.now() - 10000,
      };

      const completedAudio = {
        id: 'audio-456',
        title: 'Audio for "A very long source title..."',
        sourceCount: 1,
        correlationId: pendingAudio.id,
      };

      // Mock fetching pending nodes
      server.use(
        http.post(`${RSRCH_URL}/graph/execute`, async ({ request }) => {
          const body = await request.json();
          if (body.query.includes('MATCH (pa:PendingAudio')) {
            return HttpResponse.json([
              [pendingAudio.id, pendingAudio.notebookId, pendingAudio.sourceTitle, pendingAudio.startedAt]
            ]);
          }
           // Mock the update query
          if (body.query.includes('DETACH DELETE pa')) {
            return HttpResponse.json({ success: true });
          }
          return HttpResponse.json({});
        }),
        // Mock fetching notebook data
        http.post(`${RSRCH_URL}/notebook/list`, () => {
          return HttpResponse.json({
            success: true,
            data: [{
              id: 'notebook-123',
              audioOverviews: [completedAudio],
            }],
          });
        }),
        // Mock ntfy notification
        http.post(`${NTFY_URL}/${NTFY_TOPIC}`, () => new HttpResponse(null, { status: 200 }))
      );

      const result = await watchAudioCompletion();

      expect(result.processed).toBe(1);
      expect(result.completed).toBe(1);
      expect(result.failed).toBe(0);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should match a completed audio file and update the graph" --reporter=verbose
```

:::

#### üß™ "should query the rsrch server and return sources"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>server.use#40;<br/>http.post#40;'${RSRCH_URL}/notebooklm/sources-without-audio'...<br/>return HttpResponse.json#40;{<br/>sources: #91;'Source A', 'Source B'#93;,<br/>}#41;;<br/>}#41;<br/>#41;;"]
    S1["Setup:<br/>const result = await getSourcesWithoutAudio#40;{ notebook_ti..."]
    V2["Verify:<br/>expect#40;result.total_count#41;.toBe#40;2#41;;<br/>expect#40;result.sources_without_audio#41;.toEqual#40;#91;'S..."]
    A0 --> S1
    S1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/windmill.test.ts:110-123`](tests/windmill.test.ts)

```typescript
server.use(
            http.post(`${RSRCH_URL}/notebooklm/sources-without-audio`, () => {
                return HttpResponse.json({
                    sources: ['Source A', 'Source B'],
                });
            })
        );

        const result = await getSourcesWithoutAudio({ notebook_title: 'Test Book' });

        expect(result.total_count).toBe(2);
        expect(result.sources_without_audio).toEqual(['Source A', 'Source B']);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should query the rsrch server and return sources" --reporter=verbose
```

:::

#### üß™ "should send a success notification to ntfy"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>let requestBody = '';"]
    A1["Act:<br/>server.use#40;<br/>http.post#40;'${NTFY_URL}/${NTFY_TOPIC}', async #40;{ reques...<br/>requestBody = await request.text#40;#41;;<br/>return new HttpResponse#40;null, { status: 200 }#41;;<br/>}#41;<br/>#41;;"]
    S2["Setup:<br/>const result = await notifyAudioComplete#40;{"]
    A3["Act:<br/>source_title: 'My Test Source',<br/>notebook_title: 'My Test Notebook',<br/>start_time: Date.now#40;#41; - 5000,<br/>success: true,<br/>artifact_title: 'Audio for My Test Source',<br/>}#41;;"]
    V4["Verify:<br/>expect#40;result.notification_sent#41;.toBe#40;true#41;;<br/>expect#40;requestBody#41;.toContain#40;'Audio generated in 0"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/windmill.test.ts:127-146`](tests/windmill.test.ts)

```typescript
let requestBody = '';
        server.use(
            http.post(`${NTFY_URL}/${NTFY_TOPIC}`, async ({ request }) => {
                requestBody = await request.text();
                return new HttpResponse(null, { status: 200 });
            })
        );

        const result = await notifyAudioComplete({
            source_title: 'My Test Source',
            notebook_title: 'My Test Notebook',
            start_time: Date.now() - 5000,
            success: true,
            artifact_title: 'Audio for My Test Source',
        });

        expect(result.notification_sent).toBe(true);
        expect(requestBody).toContain('Audio generated in 0m 5s');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/windmill.test.ts -t "should send a success notification to ntfy" --reporter=verbose
```

:::

---

### üìÅ `adversarial.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should handle empty messages array gracefully"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;#93; // Empty array - no messages!<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S3["Setup:<br/>const data = await response.json#40;#41;;"]
    V4["Verify:<br/>expect#40;data.error#41;.toBeDefined#40;#41;;"]
    S0 --> A1
    A1 --> V2
    V2 --> S3
    S3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:129-143`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gemini-rsrch',
                    messages: [] // Empty array - no messages!
                })
            });

            // This should return 400, not crash or send empty prompt
            expect(response.status).toBe(400);
            const data = await response.json();
            expect(data.error).toBeDefined();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle empty messages array gracefully" --reporter=verbose
```

:::

#### üß™ "should reject messages with empty content"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'user', content: '' },<br/>{ role: 'assistant', content: '' },<br/>{ role: 'user', content: 'Hello' }<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:150-166`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gemini-rsrch',
                    messages: [
                        { role: 'user', content: '' },
                        { role: 'assistant', content: '' },
                        { role: 'user', content: 'Hello' }
                    ]
                })
            });

            // Empty messages should be filtered or rejected
            expect(response.status).toBe(400);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject messages with empty content" --reporter=verbose
```

:::

#### üß™ "should handle only system message"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'system', content: 'You are a helpful assistant' }<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:172-186`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gemini-rsrch',
                    messages: [
                        { role: 'system', content: 'You are a helpful assistant' }
                    ]
                })
            });

            // System-only should probably be rejected
            expect(response.status).toBe(400);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle only system message" --reporter=verbose
```

:::

#### üß™ "should handle pollIntervalMs = 0 edge case"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;true#41;.toBe#40;true#41;; // Placeholder - need i"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:223-231`](tests/adversarial.test.ts)

```typescript
// This can't be tested directly from API, but documents the bug
            // In gemini-client.ts line ~1052:
            // const maxIterations = Math.ceil(timeoutMs / pollIntervalMs) + 10;
            // If pollIntervalMs = 0 ‚Üí maxIterations = Infinity

            // The fix should validate pollIntervalMs > 0
            expect(true).toBe(true); // Placeholder - need internal test
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle pollIntervalMs = 0 edge case" --reporter=verbose
```

:::

#### üß™ "should handle timeoutMs = 0 edge case"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    V0["Verify:<br/>expect#40;true#41;.toBe#40;true#41;;"]


classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:236-242`](tests/adversarial.test.ts)

```typescript
// timeoutMs = 0 means:
            // - maxIterations = 10 (just the safety margin)
            // - Date.now() - startTime > 0 is immediately true
            // So it will timeout on first iteration
            expect(true).toBe(true);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle timeoutMs = 0 edge case" --reporter=verbose
```

:::

#### üß™ "should handle OPTIONS preflight correctly"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'OPTIONS',<br/>headers: {<br/>'Origin': 'http://evil.com',<br/>'Access-Control-Request-Method': 'POST',<br/>'Access-Control-Request-Headers': 'Content-Type'<br/>}<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;204#41;; // No Content<br/>expect#40;response.headers.get#40;'Access-Control-Allow-Orig...<br/>expect#40;response.headers.get#40;'Access-Control-Allow-Meth..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:251-264`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'OPTIONS',
                headers: {
                    'Origin': 'http://evil.com',
                    'Access-Control-Request-Method': 'POST',
                    'Access-Control-Request-Headers': 'Content-Type'
                }
            });

            expect(response.status).toBe(204); // No Content
            expect(response.headers.get('Access-Control-Allow-Origin')).toBe('*');
            expect(response.headers.get('Access-Control-Allow-Methods')).toContain('POST');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should handle OPTIONS preflight correctly" --reporter=verbose
```

:::

#### üß™ "should allow Authorization header via CORS"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'OPTIONS',<br/>headers: {<br/>'Origin': 'http://localhost:8080',<br/>'Access-Control-Request-Method': 'POST',<br/>'Access-Control-Request-Headers': 'Content-Type, Authorizati...<br/>}<br/>}#41;;"]
    S2["Setup:<br/>const allowedHeaders = response.headers.get#40;'Access-Contr..."]
    V3["Verify:<br/>expect#40;allowedHeaders#41;.toContain#40;'Authorization'#41"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:269-281`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'OPTIONS',
                headers: {
                    'Origin': 'http://localhost:8080',
                    'Access-Control-Request-Method': 'POST',
                    'Access-Control-Request-Headers': 'Content-Type, Authorization'
                }
            });

            const allowedHeaders = response.headers.get('Access-Control-Allow-Headers');
            expect(allowedHeaders).toContain('Authorization');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should allow Authorization header via CORS" --reporter=verbose
```

:::

#### üß™ "should reject non-string message content"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'user', content: { text: 'Hello' } } // Object inste...<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:289-302`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gemini-rsrch',
                    messages: [
                        { role: 'user', content: { text: 'Hello' } } // Object instead of string
                    ]
                })
            });

            expect(response.status).toBe(400);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject non-string message content" --reporter=verbose
```

:::

#### üß™ "should reject invalid message role"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ role: 'hacker', content: 'DROP TABLE users;' }<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:307-320`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gemini-rsrch',
                    messages: [
                        { role: 'hacker', content: 'DROP TABLE users;' }
                    ]
                })
            });

            expect(response.status).toBe(400);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject invalid message role" --reporter=verbose
```

:::

#### üß™ "should reject messages missing required fields"

::: {.callout-note appearance="simple"}
**‚ùì Unknown**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;<br/>{ content: 'Hello' } // Missing role<br/>#93;<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;400#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/adversarial.test.ts:325-338`](tests/adversarial.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gemini-rsrch',
                    messages: [
                        { content: 'Hello' } // Missing role
                    ]
                })
            });

            expect(response.status).toBe(400);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/adversarial.test.ts -t "should reject messages missing required fields" --reporter=verbose
```

:::

---

### üìÅ `auth-sanity.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should be able to get a response from Gemini (confirms Google Auth)"

::: {.callout-warning appearance="simple"}
**‚è≠Ô∏è skipped**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'gemini-rsrch',<br/>messages: #91;{ role: 'user', content: 'Reply only with 'PON...<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;200#41;;"]
    S3["Setup:<br/>const data = await response.json#40;#41;;"]
    V4["Verify:<br/>expect#40;data.choices#91;0#93;.message.content.toUpperCase#..."]
    S0 --> A1
    A1 --> V2
    V2 --> S3
    S3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/auth-sanity.test.ts:17-30`](tests/auth-sanity.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gemini-rsrch',
                messages: [{ role: 'user', content: 'Reply only with "PONG"' }]
            })
        });

        expect(response.status).toBe(200);
        const data = await response.json();
        expect(data.choices[0].message.content.toUpperCase()).toContain('PONG');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/auth-sanity.test.ts -t "should be able to get a response from Gemini (confirms Google Auth)" --reporter=verbose
```

:::

#### üß™ "should be able to get a response from Perplexity (confirms Perplexity Auth)"

::: {.callout-warning appearance="simple"}
**‚è≠Ô∏è skipped**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const response = await fetch#40;'${BASE_URL}/v1/chat/complet..."]
    A1["Act:<br/>method: 'POST',<br/>headers: { 'Content-Type': 'application/json' },<br/>body: JSON.stringify#40;{<br/>model: 'perplexity',<br/>messages: #91;{ role: 'user', content: 'Reply only with 'PON...<br/>}#41;<br/>}#41;;"]
    V2["Verify:<br/>expect#40;response.status#41;.toBe#40;200#41;;"]
    S3["Setup:<br/>const data = await response.json#40;#41;;"]
    V4["Verify:<br/>expect#40;data.choices#91;0#93;.message.content.toUpperCase#..."]
    S0 --> A1
    A1 --> V2
    V2 --> S3
    S3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/auth-sanity.test.ts:32-45`](tests/auth-sanity.test.ts)

```typescript
const response = await fetch(`${BASE_URL}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'perplexity',
                messages: [{ role: 'user', content: 'Reply only with "PONG"' }]
            })
        });

        expect(response.status).toBe(200);
        const data = await response.json();
        expect(data.choices[0].message.content.toUpperCase()).toContain('PONG');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/auth-sanity.test.ts -t "should be able to get a response from Perplexity (confirms Perplexity Auth)" --reporter=verbose
```

:::

---

### üìÅ `export.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should correctly extract research data from DOM elements"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (7.15ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = await client.parseResearch#40;#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toBeNull#40;#41;;"]
    A2["Act:<br/>if #40;!result#41; return;"]
    V3["Verify:<br/>expect#40;result.query#41;.toBe#40;'Tell me about quantum co...<br/>expect#40;result.headings#41;.toContain#40;'Research Title'#<br/>expect#40;result.headings#41;.toContain#40;'Section 1'#41;;<br/>expect#40;result.contentHtml#41;.toContain#40;'#60;h1#62;Res...<br/>expect#40;result.contentHtml#41;.toContain#40;'href='https:/...<br/>expect#40;result.citations#41;.toHaveLength#40;1#41;;<br/>expect#40;result.citations#91;0#93;#41;.toEqual#40;{"]
    A4["Act:<br/>id: 1,<br/>text: 'quantum mechanics',<br/>url: 'https://example.com/qc',<br/>domain: 'example.com',<br/>usedInSections: #91;#93;<br/>}#41;;"]
    V5["Verify:<br/>expect#40;result.reasoningSteps.length#41;.toBeGreaterThan#4<br/>expect#40;result.reasoningSteps#91;0#93;.action#41;.toContai..."]
    S0 --> V1
    V1 --> A2
    A2 --> V3
    V3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/export.test.ts:40-74`](tests/export.test.ts)

```typescript
// Trigger the parse
            const result = await client.parseResearch();


            expect(result).not.toBeNull();
            if (!result) return;

            // Verify basic metadata extraction
            expect(result.query).toBe('Tell me about quantum computing');

            // Note: The extraction logic for Title falls back to various strategies.
            // Our mock provides 'Research Title' in the content headings.
            expect(result.headings).toContain('Research Title');
            expect(result.headings).toContain('Section 1');

            // Verify Content HTML extraction
            expect(result.contentHtml).toContain('<h1>Research Title</h1>');
            expect(result.contentHtml).toContain('href="https://example.com/qc"');

            // Verify Citation extraction
            expect(result.citations).toHaveLength(1);
            expect(result.citations[0]).toEqual({
                id: 1,
                text: 'quantum mechanics',
                url: 'https://example.com/qc',
                domain: 'example.com',
                usedInSections: []
            });

            // Verify Reasoning Steps
            // based on "Analyzing physics..." status message in mock
            expect(result.reasoningSteps.length).toBeGreaterThan(0);
            expect(result.reasoningSteps[0].action).toContain('Analyzing physics');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/export.test.ts -t "should correctly extract research data from DOM elements" --reporter=verbose
```

:::

#### üß™ "should generate valid markdown from parsed structure"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.18ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = await client.parseResearch#40;#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toBeNull#40;#41;;"]
    A2["Act:<br/>console.log#40;'\n--- PARSED RESULT #40;DEFAULT#41; ---'#41;<br/>console.log#40;JSON.stringify#40;result, null, 2#41;#41;;<br/>console.log#40;'-------------------------------\n'#41;;"]
    S3["Setup:<br/>const markdown = client.exportToMarkdown#40;result!#41;;"]
    A4["Act:<br/>console.log#40;'\n--- GENERATED MARKDOWN #40;DEFAULT#41; ---<br/>console.log#40;markdown#41;;<br/>console.log#40;'------------------------------------\n'#41;;"]
    V5["Verify:<br/>expect#40;markdown#41;.toContain#40;'# Research Title'#41;;<br/>expect#40;markdown#41;.toContain#40;'#62; **Query:** Tell me...<br/>expect#40;markdown#41;.toContain#40;'## Sources Used'#41;;<br/>expect#40;markdown#41;.toContain#40;'#124; 1 #124; #91;quant...<br/>expect#40;markdown#41;.toContain#40;'## Research Process'#41<br/>expect#40;markdown#41;.toContain#40;'# Research Title'#41;;<br/>expect#40;markdown#41;.toContain#40;'Quantum computing uses ..."]
    S0 --> V1
    V1 --> A2
    A2 --> S3
    S3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/export.test.ts:76-103`](tests/export.test.ts)

```typescript
const result = await client.parseResearch();
            expect(result).not.toBeNull();

            // Console output for user verification
            console.log('\n--- PARSED RESULT (DEFAULT) ---');
            console.log(JSON.stringify(result, null, 2));
            console.log('-------------------------------\n');

            const markdown = client.exportToMarkdown(result!);

            // Console output for user verification
            console.log('\n--- GENERATED MARKDOWN (DEFAULT) ---');
            console.log(markdown);
            console.log('------------------------------------\n');

            // Check for key markdown elements
            // The title extraction worked, so we expect the actual title found in the mock HTML
            expect(markdown).toContain('# Research Title');
            expect(markdown).toContain('> **Query:** Tell me about quantum computing');
            expect(markdown).toContain('## Sources Used');
            expect(markdown).toContain('| 1 | [quantum mechanics](https://example.com/qc) | example.com |');
            expect(markdown).toContain('## Research Process');

            // Check content markdown conversion
            expect(markdown).toContain('# Research Title');
            expect(markdown).toContain('Quantum computing uses [quantum mechanics](https://example.com/qc).');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/export.test.ts -t "should generate valid markdown from parsed structure" --reporter=verbose
```

:::

#### üß™ "should correctly extract DIFFERENT research data to prove dynamic parsing"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.80ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const customPage = createResearchMockPage#40;{"]
    A1["Act:<br/>title: 'AI History',<br/>query: 'Who invented neural networks?',<br/>contentHtml: '<br/>#60;h1#62;History of AI#60;/h1#62;<br/>#60;p#62;The concept started with #60;a href='https://ai-his...<br/>#60;div class='research-status'#62;Searching archives...#60;<br/>#60;h2#62;1943 Era#60;/h2#62;<br/>#60;p#62;Foundations were laid.#60;/p#62;<br/>',<br/>contentText: 'History of AI\nThe concept started with McCull...<br/>citations: #91;<br/>{ text: 'McCulloch-Pitts neuron', href: 'https://ai-history....<br/>#93;,<br/>headings: #91;'History of AI', '1943 Era'#93;,<br/>reasoning: #91;'Searching archives...'#93;<br/>}#41;;"]
    S2["Setup:<br/>const customClient = new GeminiClient#40;customPage, { verbo...<br/>const result = await customClient.parseResearch#40;#41;;"]
    V3["Verify:<br/>expect#40;result#41;.not.toBeNull#40;#41;;"]
    A4["Act:<br/>if #40;!result#41; return;<br/>console.log#40;'\n--- PARSED RESULT #40;CUSTOM#41; ---'#41;;<br/>console.log#40;JSON.stringify#40;result, null, 2#41;#41;;<br/>console.log#40;'------------------------------\n'#41;;"]
    S5["Setup:<br/>const markdown = customClient.exportToMarkdown#40;result#41;"]
    A6["Act:<br/>console.log#40;'\n--- GENERATED MARKDOWN #40;CUSTOM#41; ---'<br/>console.log#40;markdown#41;;<br/>console.log#40;'-----------------------------------\n'#41;;"]
    V7["Verify:<br/>expect#40;result.query#41;.toBe#40;'Who invented neural netw<br/>expect#40;result.headings#41;.toContain#40;'History of AI'#4<br/>expect#40;markdown#41;.toContain#40;'# History of AI'#41;;<br/>expect#40;markdown#41;.toContain#40;'#91;McCulloch-Pitts neu..."]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> A4
    A4 --> S5
    S5 --> A6
    A6 --> V7

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/export.test.ts:105-147`](tests/export.test.ts)

```typescript
// Setup custom data
            const customPage = createResearchMockPage({
                title: 'AI History',
                query: 'Who invented neural networks?',
                contentHtml: `
                    <h1>History of AI</h1>
                    <p>The concept started with <a href="https://ai-history.com/mcculloch-pitts">McCulloch-Pitts neuron</a> in 1943.</p>
                    <div class="research-status">Searching archives...</div>
                    <h2>1943 Era</h2>
                    <p>Foundations were laid.</p>
                `,
                contentText: 'History of AI\nThe concept started with McCulloch-Pitts neuron in 1943.\nSearching archives...\n1943 Era\nFoundations were laid.',
                citations: [
                    { text: 'McCulloch-Pitts neuron', href: 'https://ai-history.com/mcculloch-pitts' }
                ],
                headings: ['History of AI', '1943 Era'],
                reasoning: ['Searching archives...']
            });

            const customClient = new GeminiClient(customPage, { verbose: false });
            const result = await customClient.parseResearch();

            expect(result).not.toBeNull();
            if (!result) return;

            // Console output for user verification
            console.log('\n--- PARSED RESULT (CUSTOM) ---');
            console.log(JSON.stringify(result, null, 2));
            console.log('------------------------------\n');

            const markdown = customClient.exportToMarkdown(result);

            // Console output for user verification
            console.log('\n--- GENERATED MARKDOWN (CUSTOM) ---');
            console.log(markdown);
            console.log('-----------------------------------\n');

            expect(result.query).toBe('Who invented neural networks?');
            expect(result.headings).toContain('History of AI');
            expect(markdown).toContain('# History of AI');
            expect(markdown).toContain('[McCulloch-Pitts neuron](https://ai-history.com/mcculloch-pitts)');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/export.test.ts -t "should correctly extract DIFFERENT research data to prove dynamic parsing" --reporter=verbose
```

:::

#### üß™ "should format full research document correctly"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.72ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const mockParsedData = {"]
    A1["Act:<br/>title: 'Test Research',<br/>query: 'Test Query',<br/>content: 'Some content',<br/>contentHtml: '#60;p#62;Some content#60;/p#62;',<br/>contentMarkdown: 'Some content',<br/>headings: #91;'Heading 1'#93;,<br/>citations: #91;<br/>{ id: 1, text: 'Source 1', url: 'http://src1.com', domain: '...<br/>#93;,<br/>reasoningSteps: #91;<br/>{ phase: 'Step 1', action: 'Thinking...' }<br/>#93;,<br/>researchFlow: #91;#93;,<br/>createdAt: '2025-01-01'<br/>};"]
    S2["Setup:<br/>const compiledMd = client.exportToMarkdown#40;mockParsedData"]
    V3["Verify:<br/>expect#40;compiledMd#41;.toContain#40;'# Test Research'#41;;<br/>expect#40;compiledMd#41;.toContain#40;'#62; **Query:** Test <br/>expect#40;compiledMd#41;.toContain#40;'#124; 1 #124; #91;Sou...<br/>expect#40;compiledMd#41;.toContain#40;'**Step 1**: Thinking."]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/export.test.ts:151-175`](tests/export.test.ts)

```typescript
const mockParsedData = {
                title: 'Test Research',
                query: 'Test Query',
                content: 'Some content',
                contentHtml: '<p>Some content</p>',
                contentMarkdown: 'Some content',
                headings: ['Heading 1'],
                citations: [
                    { id: 1, text: 'Source 1', url: 'http://src1.com', domain: 'src1.com', usedInSections: [] }
                ],
                reasoningSteps: [
                    { phase: 'Step 1', action: 'Thinking...' }
                ],
                researchFlow: [],
                createdAt: '2025-01-01'
            };

            const compiledMd = client.exportToMarkdown(mockParsedData);

            expect(compiledMd).toContain('# Test Research');
            expect(compiledMd).toContain('> **Query:** Test Query');
            expect(compiledMd).toContain('| 1 | [Source 1](http://src1.com) | src1.com |');
            expect(compiledMd).toContain('**Step 1**: Thinking...');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/export.test.ts -t "should format full research document correctly" --reporter=verbose
```

:::

---

### üìÅ `gemini-client.unit.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should convert code blocks with language"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2.73ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;pre#62;#60;code class='language-typescript...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;''''typescript'#41;;<br/>expect#40;result#41;.toContain#40;'const x = 1;'#41;;<br/>expect#40;result#41;.toContain#40;'''''#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:88-94`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<pre><code class="language-typescript">const x = 1;</code></pre>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('```typescript');
            expect(result).toContain('const x = 1;');
            expect(result).toContain('```');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert code blocks with language" --reporter=verbose
```

:::

#### üß™ "should convert code blocks without language"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.23ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;pre#62;#60;code#62;plain code#60;/code#62;<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;''''\n'#41;;<br/>expect#40;result#41;.toContain#40;'plain code'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:96-101`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<pre><code>plain code</code></pre>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('```\n');
            expect(result).toContain('plain code');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert code blocks without language" --reporter=verbose
```

:::

#### üß™ "should decode HTML entities in code blocks"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.16ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;pre#62;#60;code#62;#38;lt;div#38;gt;#38;am...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'#38;text'#41;;<br/>expect#40;result#41;.toContain#40;'''''#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:103-110`](tests/gemini-client.unit.test.ts)

```typescript
// Note: Inner HTML tags like <div> are stripped, only entities are decoded
            const html = '<pre><code>&lt;div&gt;&amp;text&lt;/div&gt;</code></pre>';
            const result = htmlToMarkdownSimple(html);
            // The regex decodes &lt; &gt; &amp; but strips any actual HTML tags
            expect(result).toContain('&text');
            expect(result).toContain('```');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should decode HTML entities in code blocks" --reporter=verbose
```

:::

#### üß™ "should handle inline code"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.26ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'Use #60;code#62;npm install#60;/code#62; to in<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Use 'npm install' to install'#"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:112-116`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'Use <code>npm install</code> to install';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('Use `npm install` to install');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle inline code" --reporter=verbose
```

:::

#### üß™ "should convert h1 to markdown"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.13ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h1#62;Main Title#60;/h1#62;';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'# Main Title'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:120-124`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<h1>Main Title</h1>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('# Main Title');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert h1 to markdown" --reporter=verbose
```

:::

#### üß™ "should convert h2 to markdown"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.10ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h2#62;Section#60;/h2#62;';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'## Section'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:126-130`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<h2>Section</h2>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('## Section');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert h2 to markdown" --reporter=verbose
```

:::

#### üß™ "should convert h3 to markdown"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.20ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h3#62;Subsection#60;/h3#62;';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'### Subsection'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:132-136`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<h3>Subsection</h3>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('### Subsection');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert h3 to markdown" --reporter=verbose
```

:::

#### üß™ "should handle headings with attributes"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.12ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;h2 class='title' id='section-1'#62;With At...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'## With Attrs'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:138-142`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<h2 class="title" id="section-1">With Attrs</h2>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('## With Attrs');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle headings with attributes" --reporter=verbose
```

:::

#### üß™ "should convert strong to bold"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.20ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;strong#62;important#60;/strong#62;<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is **important** text'#41"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:146-150`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'This is <strong>important</strong> text';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('This is **important** text');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert strong to bold" --reporter=verbose
```

:::

#### üß™ "should convert b to bold"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.12ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;b#62;bold#60;/b#62; text';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is **bold** text'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:152-156`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'This is <b>bold</b> text';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('This is **bold** text');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert b to bold" --reporter=verbose
```

:::

#### üß™ "should convert em to italic"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.08ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;em#62;emphasized#60;/em#62; text';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is *emphasized* text'#41;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:158-162`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'This is <em>emphasized</em> text';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('This is *emphasized* text');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert em to italic" --reporter=verbose
```

:::

#### üß™ "should convert i to italic"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.07ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'This is #60;i#62;italic#60;/i#62; text';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'This is *italic* text'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:164-168`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'This is <i>italic</i> text';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('This is *italic* text');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert i to italic" --reporter=verbose
```

:::

#### üß™ "should convert unordered list items"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.08ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;ul#62;#60;li#62;First#60;/li#62;#60;li#62;<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'- First'#41;;<br/>expect#40;result#41;.toContain#40;'- Second'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:172-177`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<ul><li>First</li><li>Second</li></ul>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('- First');
            expect(result).toContain('- Second');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert unordered list items" --reporter=verbose
```

:::

#### üß™ "should convert ordered list items"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.07ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;ol#62;#60;li#62;Step 1#60;/li#62;#60;li#62<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'- Step 1'#41;;<br/>expect#40;result#41;.toContain#40;'- Step 2'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:179-184`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<ol><li>Step 1</li><li>Step 2</li></ol>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('- Step 1');
            expect(result).toContain('- Step 2');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert ordered list items" --reporter=verbose
```

:::

#### üß™ "should convert paragraphs"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.08ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;p#62;First paragraph#60;/p#62;#60;p#62;Sec...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'First paragraph'#41;;<br/>expect#40;result#41;.toContain#40;'Second paragraph'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:188-193`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<p>First paragraph</p><p>Second paragraph</p>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('First paragraph');
            expect(result).toContain('Second paragraph');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert paragraphs" --reporter=verbose
```

:::

#### üß™ "should convert br to newline"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.07ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'Line one#60;br#62;Line two<br/>Line three';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'Line one\nLine two\nLine "]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:195-199`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'Line one<br>Line two<br/>Line three';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('Line one\nLine two\nLine three');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert br to newline" --reporter=verbose
```

:::

#### üß™ "should convert links to markdown format"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.06ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'Visit #60;a href='https://example.com'#62;Exam...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Visit #91;Example Site#93;#40;..."]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:203-207`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'Visit <a href="https://example.com">Example Site</a> for more';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('Visit [Example Site](https://example.com) for more');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert links to markdown format" --reporter=verbose
```

:::

#### üß™ "should handle links with extra attributes"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.06ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;a href='https://test.com' target='_blank' ...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'#91;Link#93;#40;https://test.c"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:209-213`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<a href="https://test.com" target="_blank" rel="noopener">Link</a>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('[Link](https://test.com)');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle links with extra attributes" --reporter=verbose
```

:::

#### üß™ "should decode common HTML entities"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.07ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#38;lt;tag#38;gt; #38;amp; #38;quot;quoted#38;...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'#60;tag#62; #38; 'quoted' \'ap"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:217-221`](tests/gemini-client.unit.test.ts)

```typescript
const html = '&lt;tag&gt; &amp; &quot;quoted&quot; &#39;apostrophe&#39;';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('<tag> & "quoted" \'apostrophe\'');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should decode common HTML entities" --reporter=verbose
```

:::

#### üß™ "should convert nbsp to space"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.06ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = 'word#38;nbsp;word';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'word word'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:223-227`](tests/gemini-client.unit.test.ts)

```typescript
const html = 'word&nbsp;word';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('word word');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should convert nbsp to space" --reporter=verbose
```

:::

#### üß™ "should strip unknown HTML tags"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.07ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;custom#62;content#60;/custom#62;#60;span#6<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'contentmore'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:231-235`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<custom>content</custom><span>more</span>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toBe('contentmore');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should strip unknown HTML tags" --reporter=verbose
```

:::

#### üß™ "should handle empty input"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.06ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = htmlToMarkdownSimple#40;''#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;''#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:237-240`](tests/gemini-client.unit.test.ts)

```typescript
const result = htmlToMarkdownSimple('');
            expect(result).toBe('');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle empty input" --reporter=verbose
```

:::

#### üß™ "should handle plain text"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.05ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = htmlToMarkdownSimple#40;'Just plain text'#41;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Just plain text'#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:242-245`](tests/gemini-client.unit.test.ts)

```typescript
const result = htmlToMarkdownSimple('Just plain text');
            expect(result).toBe('Just plain text');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle plain text" --reporter=verbose
```

:::

#### üß™ "should collapse multiple newlines"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.16ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;p#62;Para 1#60;/p#62;\n\n\n\n#60;p#62;Para<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toMatch#40;/\n{3,}/#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:247-252`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<p>Para 1</p>\n\n\n\n<p>Para 2</p>';
            const result = htmlToMarkdownSimple(html);
            // Should not have more than 2 consecutive newlines
            expect(result).not.toMatch(/\n{3,}/);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should collapse multiple newlines" --reporter=verbose
```

:::

#### üß™ "should trim whitespace"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.12ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '   #60;p#62;Content#60;/p#62;   ';<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.not.toMatch#40;/^\s/#41;;<br/>expect#40;result#41;.not.toMatch#40;/\s$/#41;;"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:254-259`](tests/gemini-client.unit.test.ts)

```typescript
const html = '   <p>Content</p>   ';
            const result = htmlToMarkdownSimple(html);
            expect(result).not.toMatch(/^\s/);
            expect(result).not.toMatch(/\s$/);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should trim whitespace" --reporter=verbose
```

:::

#### üß™ "should handle nested formatting"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.08ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '#60;p#62;#60;strong#62;Bold with #60;em#62;ita...<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toContain#40;'**Bold with *italic***'#4"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:263-267`](tests/gemini-client.unit.test.ts)

```typescript
const html = '<p><strong>Bold with <em>italic</em></strong></p>';
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('**Bold with *italic***');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle nested formatting" --reporter=verbose
```

:::

#### üß™ "should handle full document structure"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.13ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const html = '"]
    A1["Act:<br/>#60;h1#62;Title#60;/h1#62;<br/>#60;p#62;Introduction paragraph with #60;strong#62;bold#60;/<br/>#60;h2#62;Section#60;/h2#62;<br/>#60;ul#62;<br/>#60;li#62;Item one#60;/li#62;<br/>#60;li#62;Item two#60;/li#62;<br/>#60;/ul#62;<br/>#60;pre#62;#60;code class='language-js'#62;console.log#40;'h...<br/>';"]
    S2["Setup:<br/>const result = htmlToMarkdownSimple#40;html#41;;"]
    V3["Verify:<br/>expect#40;result#41;.toContain#40;'# Title'#41;;<br/>expect#40;result#41;.toContain#40;'**bold**'#41;;<br/>expect#40;result#41;.toContain#40;'## Section'#41;;<br/>expect#40;result#41;.toContain#40;'- Item one'#41;;<br/>expect#40;result#41;.toContain#40;''''js'#41;;<br/>expect#40;result#41;.toContain#40;'console.log#40;'hello'#41"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-client.unit.test.ts:269-287`](tests/gemini-client.unit.test.ts)

```typescript
const html = `
                <h1>Title</h1>
                <p>Introduction paragraph with <strong>bold</strong>.</p>
                <h2>Section</h2>
                <ul>
                    <li>Item one</li>
                    <li>Item two</li>
                </ul>
                <pre><code class="language-js">console.log("hello");</code></pre>
            `;
            const result = htmlToMarkdownSimple(html);
            expect(result).toContain('# Title');
            expect(result).toContain('**bold**');
            expect(result).toContain('## Section');
            expect(result).toContain('- Item one');
            expect(result).toContain('```js');
            expect(result).toContain('console.log("hello");');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-client.unit.test.ts -t "should handle full document structure" --reporter=verbose
```

:::

---

### üìÅ `gemini-windmill.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "queryViaWindmill should delegate to WindmillClient when configured"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3.32ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const query = 'Test Query';<br/>const expectedResponse = 'Windmill Response';<br/>mockIsConfigured.mockReturnValue#40;true#41;;<br/>mockTriggerGemini.mockResolvedValue#40;{ jobId: 'job-123' }#<br/>mockWaitForJob.mockResolvedValue#40;{"]
    A1["Act:<br/>success: true,<br/>result: {<br/>success: true,<br/>response: expectedResponse,<br/>session_id: 'new-session-id'<br/>}<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.queryViaWindmill#40;query#41;;"]
    V3["Verify:<br/>expect#40;mockIsConfigured#41;.toHaveBeenCalled#40;#41;;<br/>expect#40;mockTriggerGemini#41;.toHaveBeenCalledWith#40;{"]
    A4["Act:<br/>message: query,<br/>session_id: undefined,<br/>model: 'pro',<br/>waitForResponse: true<br/>}#41;;"]
    V5["Verify:<br/>expect#40;mockWaitForJob#41;.toHaveBeenCalledWith#40;'job-12<br/>expect#40;result#41;.toBe#40;expectedResponse#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3
    V3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-windmill.test.ts:41-69`](tests/gemini-windmill.test.ts)

```typescript
const query = 'Test Query';
        const expectedResponse = 'Windmill Response';

        mockIsConfigured.mockReturnValue(true);
        // trigger returns job ID
        mockTriggerGemini.mockResolvedValue({ jobId: 'job-123' });
        // waitForJob returns the result
        mockWaitForJob.mockResolvedValue({
            success: true,
            result: {
                success: true,
                response: expectedResponse,
                session_id: 'new-session-id'
            }
        });

        const result = await client.queryViaWindmill(query);

        expect(mockIsConfigured).toHaveBeenCalled();
        expect(mockTriggerGemini).toHaveBeenCalledWith({
            message: query,
            session_id: undefined,
            model: 'pro',
            waitForResponse: true
        });
        expect(mockWaitForJob).toHaveBeenCalledWith('job-123');
        expect(result).toBe(expectedResponse);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should delegate to WindmillClient when configured" --reporter=verbose
```

:::

#### üß™ "queryViaWindmill should pass session ID and model"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.77ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockIsConfigured.mockReturnValue#40;true#41;;<br/>mockTriggerGemini.mockResolvedValue#40;{ jobId: 'job-456' }#<br/>mockWaitForJob.mockResolvedValue#40;{"]
    A1["Act:<br/>success: true,<br/>result: { success: true, response: 'ok' }<br/>}#41;;<br/>await client.queryViaWindmill#40;'Hello', 'sess-123', 'think..."]
    V2["Verify:<br/>expect#40;mockTriggerGemini#41;.toHaveBeenCalledWith#40;{"]
    A3["Act:<br/>message: 'Hello',<br/>session_id: 'sess-123',<br/>model: 'thinking',<br/>waitForResponse: true<br/>}#41;;"]
    S0 --> A1
    A1 --> V2
    V2 --> A3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-windmill.test.ts:71-87`](tests/gemini-windmill.test.ts)

```typescript
mockIsConfigured.mockReturnValue(true);
        mockTriggerGemini.mockResolvedValue({ jobId: 'job-456' });
        mockWaitForJob.mockResolvedValue({
            success: true,
            result: { success: true, response: 'ok' }
        });

        await client.queryViaWindmill('Hello', 'sess-123', 'thinking');

        expect(mockTriggerGemini).toHaveBeenCalledWith({
            message: 'Hello',
            session_id: 'sess-123',
            model: 'thinking',
            waitForResponse: true
        });
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should pass session ID and model" --reporter=verbose
```

:::

#### üß™ "queryViaWindmill should throw if Windmill is not configured"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.19ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockIsConfigured.mockReturnValue#40;false#41;;"]
    A1["Act:<br/>await expect#40;client.queryViaWindmill#40;'fail'#41;#41;.re..."]
    S0 --> A1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-windmill.test.ts:89-92`](tests/gemini-windmill.test.ts)

```typescript
mockIsConfigured.mockReturnValue(false);
        await expect(client.queryViaWindmill('fail')).rejects.toThrow('Windmill is not configured');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should throw if Windmill is not configured" --reporter=verbose
```

:::

#### üß™ "queryViaWindmill should throw if job fails internally"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.63ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockIsConfigured.mockReturnValue#40;true#41;;<br/>mockTriggerGemini.mockResolvedValue#40;{ jobId: 'job-789' }#<br/>mockWaitForJob.mockResolvedValue#40;{"]
    A1["Act:<br/>success: true,<br/>result: { success: false, error: 'Script Error' }<br/>}#41;;<br/>await expect#40;client.queryViaWindmill#40;'fail'#41;#41;.re..."]
    S0 --> A1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/gemini-windmill.test.ts:94-103`](tests/gemini-windmill.test.ts)

```typescript
mockIsConfigured.mockReturnValue(true);
        mockTriggerGemini.mockResolvedValue({ jobId: 'job-789' });
        mockWaitForJob.mockResolvedValue({
            success: true,
            result: { success: false, error: 'Script Error' }
        });

        await expect(client.queryViaWindmill('fail')).rejects.toThrow('Script Error');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/gemini-windmill.test.ts -t "queryViaWindmill should throw if job fails internally" --reporter=verbose
```

:::

---

### üìÅ `retry.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should succeed on the first attempt"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (4.98ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;<br/>#40;fetch as vi.Mock#41;.mockResolvedValueOnce#40;{"]
    A1["Act:<br/>ok: true,<br/>text: async #40;#41; =#62; 'job-123',<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.jobId#41;.toBe#40;'job-123'#41;;<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;1#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:16-27`](tests/retry.test.ts)

```typescript
const client = new WindmillClient();
        (fetch as vi.Mock).mockResolvedValueOnce({
            ok: true,
            text: async () => 'job-123',
        });

        const result = await client.triggerAudioGeneration({ notebookTitle: 'test', sourceTitle: 'test' });
        expect(result.success).toBe(true);
        expect(result.jobId).toBe('job-123');
        expect(fetch).toHaveBeenCalledTimes(1);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should succeed on the first attempt" --reporter=verbose
```

:::

#### üß™ "should retry on transient server errors and eventually succeed"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3017.94ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;"]
    A1["Act:<br/>#40;fetch as vi.Mock#41;"]
    S2["Setup:<br/>.mockResolvedValueOnce#40;{ ok: false, status: 503, statusTe...<br/>.mockResolvedValueOnce#40;{ ok: false, status: 429, statusTe...<br/>.mockResolvedValueOnce#40;{ ok: true, text: async #40;#41; =...<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.jobId#41;.toBe#40;'job-123'#41;;<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;3#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:29-40`](tests/retry.test.ts)

```typescript
const client = new WindmillClient();
        (fetch as vi.Mock)
            .mockResolvedValueOnce({ ok: false, status: 503, statusText: 'Service Unavailable', text: async () => 'error' })
            .mockResolvedValueOnce({ ok: false, status: 429, statusText: 'Too Many Requests', text: async () => 'error' })
            .mockResolvedValueOnce({ ok: true, text: async () => 'job-123' });

        const result = await client.triggerAudioGeneration({ notebookTitle: 'test', sourceTitle: 'test' });
        expect(result.success).toBe(true);
        expect(result.jobId).toBe('job-123');
        expect(fetch).toHaveBeenCalledTimes(3);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should retry on transient server errors and eventually succeed" --reporter=verbose
```

:::

#### üß™ "should fail after max retries on persistent server errors"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (7016.28ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;<br/>#40;fetch as vi.Mock#41;.mockResolvedValue#40;{"]
    A1["Act:<br/>ok: false,<br/>status: 500,<br/>statusText: 'Internal Server Error',<br/>text: async #40;#41; =#62; 'server-error',<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;false#41;;<br/>expect#40;result.error#41;.toContain#40;'API error #40;statu...<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;4#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:42-55`](tests/retry.test.ts)

```typescript
const client = new WindmillClient();
        (fetch as vi.Mock).mockResolvedValue({
            ok: false,
            status: 500,
            statusText: 'Internal Server Error',
            text: async () => 'server-error',
        });

        const result = await client.triggerAudioGeneration({ notebookTitle: 'test', sourceTitle: 'test' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('API error (status 500): server-error');
        expect(fetch).toHaveBeenCalledTimes(4);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should fail after max retries on persistent server errors" --reporter=verbose
```

:::

#### üß™ "should fail immediately on non-retriable client errors (e.g., 400)"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.82ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;<br/>#40;fetch as vi.Mock#41;.mockResolvedValueOnce#40;{"]
    A1["Act:<br/>ok: false,<br/>status: 400,<br/>statusText: 'Bad Request',<br/>text: async #40;#41; =#62; 'bad-request',<br/>}#41;;"]
    S2["Setup:<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;false#41;;<br/>expect#40;result.error#41;.toContain#40;'API error #40;statu...<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;1#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:57-70`](tests/retry.test.ts)

```typescript
const client = new WindmillClient();
        (fetch as vi.Mock).mockResolvedValueOnce({
            ok: false,
            status: 400,
            statusText: 'Bad Request',
            text: async () => 'bad-request',
        });

        const result = await client.triggerAudioGeneration({ notebookTitle: 'test', sourceTitle: 'test' });
        expect(result.success).toBe(false);
        expect(result.error).toContain('API error (status 400): bad-request');
        expect(fetch).toHaveBeenCalledTimes(1);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should fail immediately on non-retriable client errors (e.g., 400)" --reporter=verbose
```

:::

#### üß™ "should handle request timeouts and retry"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1000.76ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const client = new WindmillClient#40;#41;;"]
    A1["Act:<br/>#40;fetch as vi.Mock#41;"]
    S2["Setup:<br/>.mockRejectedValueOnce#40;new DOMException#40;'The user abor...<br/>.mockResolvedValueOnce#40;{ ok: true, text: async #40;#41; =...<br/>const result = await client.triggerAudioGeneration#40;{ note..."]
    V3["Verify:<br/>expect#40;result.success#41;.toBe#40;true#41;;<br/>expect#40;result.jobId#41;.toBe#40;'job-123'#41;;<br/>expect#40;fetch#41;.toHaveBeenCalledTimes#40;2#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> V3

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:72-82`](tests/retry.test.ts)

```typescript
const client = new WindmillClient();
        (fetch as vi.Mock)
            .mockRejectedValueOnce(new DOMException('The user aborted a request.', 'AbortError')) // Simulate timeout
            .mockResolvedValueOnce({ ok: true, text: async () => 'job-123' });

        const result = await client.triggerAudioGeneration({ notebookTitle: 'test', sourceTitle: 'test' });
        expect(result.success).toBe(true);
        expect(result.jobId).toBe('job-123');
        expect(fetch).toHaveBeenCalledTimes(2);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should handle request timeouts and retry" --reporter=verbose
```

:::

#### üß™ "should connect successfully on the first attempt"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.98ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await graphStore.connect#40;#41;;"]
    V1["Verify:<br/>expect#40;mockConnect#41;.toHaveBeenCalledTimes#40;1#41;;<br/>expect#40;#40;graphStore as any#41;.isConnected#41;.toBe#40;"]
    A0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:119-123`](tests/retry.test.ts)

```typescript
await graphStore.connect();
        expect(mockConnect).toHaveBeenCalledTimes(1);
        expect((graphStore as any).isConnected).toBe(true);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should connect successfully on the first attempt" --reporter=verbose
```

:::

#### üß™ "should retry connection and eventually succeed"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2000.60ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockConnect<br/>.mockRejectedValueOnce#40;new Error#40;'Connection failed'#4<br/>.mockResolvedValueOnce#40;{ selectGraph: #40;#41; =#62; #40;..."]
    A1["Act:<br/>await graphStore.connect#40;'localhost', 6379, 2#41;;"]
    V2["Verify:<br/>expect#40;mockConnect#41;.toHaveBeenCalledTimes#40;2#41;;<br/>expect#40;#40;graphStore as any#41;.isConnected#41;.toBe#40;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:125-133`](tests/retry.test.ts)

```typescript
mockConnect
            .mockRejectedValueOnce(new Error('Connection failed'))
            .mockResolvedValueOnce({ selectGraph: () => ({ query: vi.fn() }), close: vi.fn() });

        await graphStore.connect('localhost', 6379, 2);
        expect(mockConnect).toHaveBeenCalledTimes(2);
        expect((graphStore as any).isConnected).toBe(true);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should retry connection and eventually succeed" --reporter=verbose
```

:::

#### üß™ "should fail to connect after max retries"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (2004.87ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>mockConnect.mockRejectedValue#40;new Error#40;'Persistent co..."]
    A1["Act:<br/>await expect#40;graphStore.connect#40;'localhost', 6379, 2#4..."]
    V2["Verify:<br/>expect#40;mockConnect#41;.toHaveBeenCalledTimes#40;2#41;;<br/>expect#40;#40;graphStore as any#41;.isConnected#41;.toBe#40;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:135-140`](tests/retry.test.ts)

```typescript
mockConnect.mockRejectedValue(new Error('Persistent connection failure'));
        await expect(graphStore.connect('localhost', 6379, 2)).rejects.toThrow(NetworkError);
        expect(mockConnect).toHaveBeenCalledTimes(2);
        expect((graphStore as any).isConnected).toBe(false);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should fail to connect after max retries" --reporter=verbose
```

:::

#### üß™ "should trip circuit breaker after enough consecutive failures"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (3.00ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await graphStore.connect#40;#41;;"]
    S1["Setup:<br/>mockQuery = graphStore.graph.query;<br/>mockQuery.mockRejectedValue#40;new Error#40;'Query failed'#4<br/>for #40;let i = 0; i #60; 5; i++#41; {"]
    A2["Act:<br/>await expect#40;#40;graphStore as any#41;._executeQuery#40;'...<br/>}<br/>await expect#40;#40;graphStore as any#41;._executeQuery#40;'..."]
    A0 --> S1
    S1 --> A2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:142-155`](tests/retry.test.ts)

```typescript
await graphStore.connect();
        // @ts-ignore - Access private method for mocking
        mockQuery = graphStore.graph.query;
        mockQuery.mockRejectedValue(new Error('Query failed'));

        // Trigger failures to trip the circuit
        for (let i = 0; i < 5; i++) {
            await expect((graphStore as any)._executeQuery('FAIL')).rejects.toThrow();
        }

        // Now the circuit should be open
        await expect((graphStore as any)._executeQuery('FAIL')).rejects.toThrow('circuit breaker is open');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should trip circuit breaker after enough consecutive failures" --reporter=verbose
```

:::

#### üß™ "should transition from OPEN to HALF_OPEN and then to CLOSED"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.05ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    A0["Act:<br/>await graphStore.connect#40;#41;;"]
    S1["Setup:<br/>mockQuery = graphStore.graph.query;<br/>mockQuery.mockClear#40;#41;; // Clear calls from initSchema<br/>mockQuery.mockRejectedValue#40;new Error#40;'Query failed'#4<br/>for #40;let i = 0; i #60; 5; i++#41; {"]
    A2["Act:<br/>await expect#40;#40;graphStore as any#41;._executeQuery#40;'...<br/>}<br/>graphStore.lastFailure = Date.now#40;#41; - 31000;"]
    S3["Setup:<br/>mockQuery.mockResolvedValue#40;{ data: #91;#93; }#41;;"]
    A4["Act:<br/>await #40;graphStore as any#41;._executeQuery#40;'SUCCESS'#4<br/>await #40;graphStore as any#41;._executeQuery#40;'SUCCESS'#4"]
    V5["Verify:<br/>expect#40;mockQuery#41;.toHaveBeenCalledTimes#40;7#41;;"]
    A0 --> S1
    S1 --> A2
    A2 --> S3
    S3 --> A4
    A4 --> V5

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/retry.test.ts:157-183`](tests/retry.test.ts)

```typescript
await graphStore.connect();
        // @ts-ignore
        mockQuery = graphStore.graph.query;
        mockQuery.mockClear(); // Clear calls from initSchema

        mockQuery.mockRejectedValue(new Error('Query failed'));

        // Trip the circuit
        for (let i = 0; i < 5; i++) {
            await expect((graphStore as any)._executeQuery('FAIL')).rejects.toThrow();
        }

        // It is now OPEN. Wait for reset timeout.
        // @ts-ignore - access private property
        graphStore.lastFailure = Date.now() - 31000;

        // First call should be in HALF_OPEN. Let it succeed.
        mockQuery.mockResolvedValue({ data: [] });
        await (graphStore as any)._executeQuery('SUCCESS');

        // Now it should be CLOSED. Let it succeed again.
        await (graphStore as any)._executeQuery('SUCCESS');
        // 5 failures + 1 HALF_OPEN success (which transitions to CLOSED) = 6 total calls
        // Note: The second SUCCESS doesn't increment because circuit resets call tracking
        expect(mockQuery).toHaveBeenCalledTimes(7);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/retry.test.ts -t "should transition from OPEN to HALF_OPEN and then to CLOSED" --reporter=verbose
```

:::

---

### üìÅ `stream-thoughts.integration.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should stream thoughts from a reasoning query"

::: {.callout-warning appearance="simple"}
**‚è≠Ô∏è skipped**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const query = 'Solve 25 * 44 with detailed thoughts';<br/>const serverUrl = 'http://halvarm:3030';"]
    A1["Act:<br/>console.log#40;'Testing query: '${query}' against ${serverUr..."]
    S2["Setup:<br/>let fullText = '';<br/>let thoughtBlockDetected = false;"]
    A3["Act:<br/>await executeGeminiStream#40;'chat', { message: query }, { s...<br/>if #40;data.type === 'progress' #38;#38; data.text#41; {<br/>fullText = data.text;<br/>if #40;data.text.includes#40;'Thought Process'#41; #124;#124<br/>data.text.includes#40;'My≈°lenkov√Ω proces'#41; #124;#124;<br/>data.text.includes#40;'Reasoning'#41;#41; {<br/>thoughtBlockDetected = true;<br/>}<br/>}<br/>}#41;;<br/>console.log#40;'Final Text Length:', fullText.length#41;;<br/>console.log#40;'Thought Block Detected:', thoughtBlockDetect..."]
    V4["Verify:<br/>expect#40;fullText.length#41;.toBeGreaterThan#40;0#41;;<br/>expect#40;thoughtBlockDetected#41;.toBe#40;true#41;;"]
    S0 --> A1
    A1 --> S2
    S2 --> A3
    A3 --> V4

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/stream-thoughts.integration.test.ts:10-40`](tests/stream-thoughts.integration.test.ts)

```typescript
const query = "Solve 25 * 44 with detailed thoughts";
        const serverUrl = 'http://halvarm:3030';

        console.log(`Testing query: "${query}" against ${serverUrl}`);

        let fullText = '';
        let thoughtBlockDetected = false;

        await executeGeminiStream('chat', { message: query }, { server: serverUrl }, (data) => {
            if (data.type === 'progress' && data.text) {
                fullText = data.text;
                // Check for common thought indicators
                if (data.text.includes('Thought Process') ||
                    data.text.includes('My≈°lenkov√Ω proces') ||
                    data.text.includes('Reasoning')) {
                    thoughtBlockDetected = true;
                }
            }
        });

        console.log('Final Text Length:', fullText.length);
        console.log('Thought Block Detected:', thoughtBlockDetected);

        expect(fullText.length).toBeGreaterThan(0);
        // We expect some reasoning for a "with detailed thoughts" prompt
        // Note: The model might vary in exact wording, but usually explicit prompts trigger it.
        // We strictly check if the loop logic found "Thought Process" or we just have a long response.
        // The thought block is what we specifically patched.
        expect(thoughtBlockDetected).toBe(true);
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/stream-thoughts.integration.test.ts -t "should stream thoughts from a reasoning query" --reporter=verbose
```

:::

---

### üìÅ `validation.unit.test.ts` <small>(Integration/Orphan)</small>

#### üß™ "should reject empty messages array"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (1.19ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;#93;#41;;"]
    V1["Verify:<br/>expect#40;result#41;.toBe#40;'Messages array cannot be empty"]
    S0 --> V1

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:45-48`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([]);
            expect(result).toBe('Messages array cannot be empty');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject empty messages array" --reporter=verbose
```

:::

#### üß™ "should reject system-only messages"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.14ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'system', content: 'You are helpful' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBe#40;'At least one user message is r..."]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:52-57`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'system', content: 'You are helpful' }
            ]);
            expect(result).toBe('At least one user message is required');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject system-only messages" --reporter=verbose
```

:::

#### üß™ "should accept messages with user"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.13ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'system', content: 'You are helpful' },<br/>{ role: 'user', content: 'Hello' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:59-65`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'system', content: 'You are helpful' },
                { role: 'user', content: 'Hello' }
            ]);
            expect(result).toBeNull();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should accept messages with user" --reporter=verbose
```

:::

#### üß™ "should reject invalid role"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.34ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'hacker', content: 'malicious' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'Invalid role 'hacker''#41"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:69-74`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'hacker', content: 'malicious' }
            ]);
            expect(result).toContain("Invalid role 'hacker'");
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject invalid role" --reporter=verbose
```

:::

#### üß™ "should reject missing role"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.14ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: '', content: 'Hello' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'Invalid role'#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:76-81`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: '', content: 'Hello' }
            ]);
            expect(result).toContain('Invalid role');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject missing role" --reporter=verbose
```

:::

#### üß™ "should accept valid roles"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.09ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'system', content: 'System prompt' },<br/>{ role: 'user', content: 'Hello' },<br/>{ role: 'assistant', content: 'Hi there' },<br/>{ role: 'user', content: 'Follow up' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:83-91`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'system', content: 'System prompt' },
                { role: 'user', content: 'Hello' },
                { role: 'assistant', content: 'Hi there' },
                { role: 'user', content: 'Follow up' }
            ]);
            expect(result).toBeNull();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should accept valid roles" --reporter=verbose
```

:::

#### üß™ "should reject object content"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.13ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: { text: 'Hello' } }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'must be a string, got obj"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:95-100`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'user', content: { text: 'Hello' } }
            ]);
            expect(result).toContain('must be a string, got object');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject object content" --reporter=verbose
```

:::

#### üß™ "should reject number content"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.13ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: 42 }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'must be a string, got num"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:102-107`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'user', content: 42 }
            ]);
            expect(result).toContain('must be a string, got number');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject number content" --reporter=verbose
```

:::

#### üß™ "should reject undefined content"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.21ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: undefined }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'must be a string, got und"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:109-114`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'user', content: undefined }
            ]);
            expect(result).toContain('must be a string, got undefined');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject undefined content" --reporter=verbose
```

:::

#### üß™ "should reject empty user message"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.11ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: '' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'cannot have empty content"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:118-123`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'user', content: '' }
            ]);
            expect(result).toContain('cannot have empty content');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject empty user message" --reporter=verbose
```

:::

#### üß™ "should reject whitespace-only user message"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.11ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: '   ' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toContain#40;'cannot have empty content"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:125-130`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'user', content: '   ' }
            ]);
            expect(result).toContain('cannot have empty content');
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should reject whitespace-only user message" --reporter=verbose
```

:::

#### üß™ "should allow empty assistant content"

::: {.callout-tip appearance="simple"}
**‚úÖ Passed (0.07ms)**
:::

::: {.panel-tabset}

##### üß¨ Flowchart

```{mermaid}
graph TD
    S0["Setup:<br/>const result = validateMessages#40;#91;"]
    A1["Act:<br/>{ role: 'user', content: 'Hello' },<br/>{ role: 'assistant', content: '' }<br/>#93;#41;;"]
    V2["Verify:<br/>expect#40;result#41;.toBeNull#40;#41;;"]
    S0 --> A1
    A1 --> V2

classDef setup fill:#e1f5fe,stroke:#01579b,stroke-width:2px
classDef act fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
classDef assert fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
class S0,S1,S2,S3,S4,S5,S6,S7,S8,S9,S10 setup
class A0,A1,A2,A3,A4,A5,A6,A7,A8,A9,A10 act
class V0,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10 assert
```

##### üíª Implementation

üìÑ **File:** [`tests/validation.unit.test.ts:132-138`](tests/validation.unit.test.ts)

```typescript
const result = validateMessages([
                { role: 'user', content: 'Hello' },
                { role: 'assistant', content: '' }
            ]);
            expect(result).toBeNull();
```

##### ‚ñ∂Ô∏è Run Command

```bash
npx vitest run tests/validation.unit.test.ts -t "should allow empty assistant content" --reporter=verbose
```

:::

---

## üîÑ Refresh Test Results

To update the results shown above:

```bash
# Run tests and generate JSON results
npx vitest run --reporter=json --outputFile=test-results.json

# Regenerate this report
npx ts-node scripts/generate_test_report.ts > TEST_REPORT.qmd

# Render to HTML
quarto render TEST_REPORT.qmd
```
