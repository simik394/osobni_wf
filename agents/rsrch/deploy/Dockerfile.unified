FROM mcr.microsoft.com/playwright:v1.58.0-jammy

# Install VNC and Window Manager
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
RUN apt-get update && apt-get install -y \
    xvfb \
    x11vnc \
    fluxbox \
    socat \
    curl \
    jq \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 1. Copy workspace definitions and package.json files
COPY package.json .
COPY agents/shared/package.json agents/shared/
COPY agents/rsrch/package.json agents/rsrch/

# 2. Install all dependencies
RUN npm install

# 3. Use local build artifacts (synced via deploy.sh)
COPY agents/shared/dist agents/shared/dist
COPY agents/rsrch/dist agents/rsrch/dist

# 4. Fix relative paths for compiled code (nested dist structures)
RUN mkdir -p /app/agents/rsrch/dist/rsrch && \
    cp /app/agents/rsrch/package.json /app/agents/rsrch/dist/rsrch/package.json || \
    echo '{"version":"1.0.35"}' > /app/agents/rsrch/dist/rsrch/package.json && \
    echo '{"version":"1.0.35"}' > /app/agents/rsrch/dist/package.json

# 5. Entrypoint scripts
COPY agents/rsrch/start-vnc.sh /app/start-vnc.sh
RUN chmod +x /app/start-vnc.sh

WORKDIR /app/agents/rsrch
EXPOSE 3055 5900 9223

CMD ["/app/start-vnc.sh"]
