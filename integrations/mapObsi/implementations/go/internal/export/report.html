<!DOCTYPE html>
<html>

<head>
    <title>Codebase Visualization Report</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f9f9f9;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
            border-radius: 4px;
            max-height: 300px;
        }

        .mermaid {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        details {
            margin-top: 10px;
        }

        a {
            color: #0366d6;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .controls {
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        button {
            cursor: pointer;
            color: #0366d6;
            background: none;
            border: none;
            text-decoration: underline;
            padding: 0;
            font: inherit;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, securityLevel: 'loose', theme: 'default' });
        // Enable pan/zoom after mermaid renders
        window.addEventListener('load', function() {
            // Give mermaid a moment to render
            setTimeout(function() {
                var svgs = document.querySelectorAll(".mermaid svg");
                svgs.forEach(function(svg) {
                    // Set IDs to ensure svg-pan-zoom works
                    if (!svg.id) {
                        svg.id = "mermaid-" + Math.random().toString(36).substr(2, 9);
                    }
                    // Initialize pan-zoom
                    svgPanZoom('#' + svg.id, {
                        zoomEnabled: true,
                        controlIconsEnabled: true,
                        fit: true,
                        center: true
                    });
                });
            }, 500);
        });
    </script>
</head>

<body>
    <h1>Codebase Visualization Report</h1>
    <p>Generated at {{ .GeneratedAt }}</p>

    <h2>Module Structure</h2>

    <div class="card">
        <h3>Internal File Structure</h3>
        <p>Defined classes and definitions.</p>
        <div class="mermaid">
            {{ .MermaidStructure }}
        </div>
        <details>
            <summary>Show Source</summary>
            <pre>{{ .MermaidStructureTruncated }}</pre>
        </details>
    </div>

    <div class="card">
        <h3>Class Definitions</h3>
        <div class="mermaid">
            {{ .MermaidClasses }}
        </div>
        <details>
            <summary>Show Source</summary>
            <pre>{{ .MermaidClassesTruncated }}</pre>
        </details>
    </div>

    <h2>Package Dependencies</h2>
    {{ range .MermaidPackages }}
    <div class="card">
        <h3>Package Dependencies: {{ .Name }}</h3>
        <div class="mermaid">
            {{ .Content }}
        </div>
        <details>
            <summary>Show Source</summary>
            <pre>{{ .ContentTruncated }}</pre>
        </details>
    </div>
    {{ end }}

    <div class="card">
        <h3>Clustering Algorithm Logic (Meta)</h3>
        <p>How the PlantUML diagrams below were generated.</p>
        <div class="mermaid">
            {{ .AlgoMermaid }}
        </div>
    </div>

    <h2>Architecture Diagrams (PlantUML)</h2>
    <div class="card">
        <p>Note: Graphviz (dot) layout engine is required for best results. If 'too large', use the local source.</p>
    </div>

    {{ range .PlantUMLDiagrams }}
    <div class="card">
        <h3>{{ .Filename }}</h3>
        <div class="controls">
            <a href="{{ .BrowserLink }}" target="_blank">View in PlantUML Server</a>{{ .URLWarning }} |
            <button
                onclick="navigator.clipboard.writeText(this.nextElementSibling.textContent).then(()=>alert('Copied!'))">Copy
                Source</button>
            <span style="display:none;">{{ .Content }}</span> |
            <a href="{{ .Filename }}" download="{{ .Filename }}">Download</a> |
            <a href="{{ .BrowserLink }}" target="_blank">Raw Source</a>
        </div>

        {{ if .IsTooLarge }}
        <div style="padding:20px; border:1px dashed #ccc; background:#fff3e0; text-align:center;">
            <strong>Diagram too large for public renderer</strong><br>
            Please copy the source below or <a href="http://www.plantuml.com/plantuml/uml" target="_blank">use the
                online editor</a> manually.
        </div>
        {{ else }}
        <img src="{{ .BrowserLink }}" alt="{{ .Filename }}" style="max-width:100%; height:auto;">
        {{ end }}

        <details>
            <summary>Show PlantUML Source</summary>
            <pre>{{ .ContentTruncated }}</pre>
        </details>
    </div>
    {{ end }}

</body>

</html>