job "rsrch-browser" {
  datacenters = ["oci-eu"]
  type        = "service"

  # Browser container with VNC + CDP access for Playwright automation
  # VNC: 5900, CDP: 9223 (forwarded via sidecar)
  # Note: User needs to manually launch Chrome with CDP inside VNC once,
  # or use SSH to exec into container and start Chrome with debugging

  group "browser" {
    count = 1

    network {
      mode = "host"
      
      port "vnc" {
        static = 5900
      }
      
      port "cdp" {
        static = 9223
      }
    }

    constraint {
      attribute = "${node.class}"
      value     = "cloud"
    }

    # Main browser task - Selenium standalone with VNC
    task "chromium" {
      driver = "docker"

      config {
        image        = "seleniarm/standalone-chromium:latest"
        network_mode = "host"
        
        volumes = [
          "/opt/rsrch/profiles/default:/home/seluser/chrome-profile",
          "/opt/rsrch/entrypoint.sh:/entrypoint.sh:ro"
        ]
        
        # Use our custom entrypoint that starts both Selenium and Chrome with CDP
        entrypoint = ["/entrypoint.sh"]
      }

      env {
        SE_NODE_MAX_SESSIONS = "5"
        VNC_NO_PASSWORD      = "1"
        START_XVFB           = "true"
        SE_SCREEN_WIDTH      = "1920"
        SE_SCREEN_HEIGHT     = "1080"
        SE_SCREEN_DEPTH      = "24"
      }

      resources {
        cpu    = 250
        memory = 2048
      }

      service {
        name         = "rsrch-browser-vnc"
        port         = "vnc"
        address_mode = "host"
        tags         = ["browser", "vnc"]
      }
    }

    # Sidecar: socat forwards 0.0.0.0:9223 -> localhost:9222
    # This waits for Chrome CDP to be available before forwarding
    task "cdp-proxy" {
      driver = "docker"
      
      lifecycle {
        hook    = "poststart"
        sidecar = true
      }

      config {
        image        = "alpine:latest"
        network_mode = "host"
        volumes      = ["/opt/rsrch/cdp_proxy.sh:/proxy.sh:ro"]
        entrypoint   = ["/bin/sh", "/proxy.sh"]
      }

      resources {
        cpu    = 50
        memory = 128
      }

      service {
        name         = "rsrch-browser-cdp"
        port         = "cdp"
        address_mode = "host"
        tags         = ["browser", "cdp", "rsrch"]
        
        check {
          name         = "cdp-health"
          type         = "http"
          path         = "/json/version"
          interval     = "30s"
          timeout      = "10s"
        }
      }
    }
  }
}
