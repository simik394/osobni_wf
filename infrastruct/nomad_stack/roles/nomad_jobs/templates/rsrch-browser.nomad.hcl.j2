job "rsrch-browser" {
  datacenters = ["{{ nomad_datacenter | default("dc1") }}"]
  type        = "service"

  # This job can be stopped when not needed
  # Use: nomad job stop rsrch-browser
  # Start: nomad job run rsrch-browser.nomad

  group "browser" {
    count = 1

    network {
      mode = "bridge"
      port "cdp" {
        static = 9223
        to     = 9223
      }
      port "vnc" {
        static = 5900
        to     = 5900
      }
    }

    # Persistent volume for Chrome profile (cookies, sessions)
    volume "chrome-profile" {
      type      = "host"
      source    = "rsrch-chrome-profile"
      read_only = false
    }

    task "chromium" {
      driver = "docker"

      # Run on cloud nodes by default, can be changed to run on NTB
      constraint {
        attribute = "${node.class}"
        value     = "cloud"
      }

      config {
        image = "mcr.microsoft.com/playwright:v1.40.0-focal"
        ports = ["cdp", "vnc"]
        
        # Entrypoint that starts Xvfb, VNC, and Chrome with debugging port
        entrypoint = ["/bin/bash", "-c"]
        args = [<<EOF
set -e
# Start virtual framebuffer
Xvfb :99 -screen 0 1920x1080x24 &
export DISPLAY=:99
sleep 1

# Start VNC server (optional, for debugging)
x11vnc -display :99 -forever -shared -rfbport 5900 -bg -nopw

# Start Chromium with remote debugging
chromium-browser \
  --no-sandbox \
  --disable-setuid-sandbox \
  --disable-dev-shm-usage \
  --disable-gpu \
  --remote-debugging-address=0.0.0.0 \
  --remote-debugging-port=9223 \
  --user-data-dir=/app/user-data \
  --disable-blink-features=AutomationControlled \
  --window-size=1920,1080 \
  about:blank

# Keep container running
wait
EOF
        ]
      }

      volume_mount {
        volume      = "chrome-profile"
        destination = "/app/user-data"
        read_only   = false
      }

      resources {
        cpu    = 1000
        memory = 2048
      }

      service {
        name = "rsrch-browser"
        port = "cdp"
        
        tags = [
          "browser",
          "rsrch"
        ]
        
        check {
          name     = "cdp-health"
          type     = "http"
          path     = "/json/version"
          interval = "10s"
          timeout  = "5s"
        }
      }

      service {
        name = "rsrch-browser-vnc"
        port = "vnc"
        
        tags = [
          "vnc",
          "debug"
        ]
      }
    }
  }
}
