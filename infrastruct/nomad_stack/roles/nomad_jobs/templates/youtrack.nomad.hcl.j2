job "youtrack" {
  datacenters = ["{{ nomad_datacenter | default("dc1") }}"]
  type        = "service"

  group "youtrack" {
    count = 1

    network {
      port "http" {
        to = 8080
      }
    }

    # Volume for persistence.
    # Note: Host volume must be configured in Nomad client config or use docker volume.
    # For simplicity, we use docker volume mount via config or bind mount.
    # Nomad host_volume requires client config update which we didn't do in hashicorp role yet.
    # So we use absolute path bind mount.

    task "youtrack" {
      driver = "docker"

      constraint {
        attribute = "${node.class}"
        value     = "cloud"
      }

      config {
        image = "jetbrains/youtrack:2024.1.25893" # Use a specific version or latest
        ports = ["http"]
        volumes = [
          "/opt/youtrack/data:/opt/youtrack/data",
          "/opt/youtrack/conf:/opt/youtrack/conf",
          "/opt/youtrack/logs:/opt/youtrack/logs",
          "/opt/youtrack/backups:/opt/youtrack/backups"
        ]
      }

      resources {
        cpu    = 1000 # Reduced to 1000 (1 core) to fit
        memory = 4096 # Keep RAM high as we have space
      }

      service {
        name = "youtrack"
        port = "http"
        tags = [
          "traefik.enable=true",
          "traefik.http.routers.youtrack.rule=Host(`youtrack.{{ public_ip | default(ansible_default_ipv4.address) }}.nip.io`) || PathPrefix(`/youtrack`)",
          # Assuming nip.io for easy access if no domain. Or user can override.
          "traefik.http.routers.youtrack.entrypoints=web"
        ]
        check {
          name     = "alive"
          type     = "http"
          path     = "/"
          interval = "10s"
          timeout  = "2s"
        }
      }
    }
  }
}
