---
- name: Install common packages
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - vim
      - git
      - unzip
      - ufw
      - fail2ban
      - jq
    state: present
    update_cache: yes

- name: Install ARM emulation packages (QEMU)
  ansible.builtin.apt:
    name:
      - qemu-user-static
      - binfmt-support
    state: present
  when: ansible_architecture == 'aarch64'

- name: Detect Public IP (if not set)
  ansible.builtin.uri:
    url: https://api.ipify.org
    return_content: yes
  register: ipify_result
  when: public_ip is not defined

- name: Set public_ip fact
  ansible.builtin.set_fact:
    public_ip: "{{ ipify_result.content }}"
  when: public_ip is not defined and ipify_result.status == 200

- name: Display Public IP
  ansible.builtin.debug:
    msg: "Detected Public IP: {{ public_ip }}"

# --- Swap Configuration ---
# Critical for 1GB RAM instances running Java apps (YouTrack)

- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: swap_file

- name: Create swap file (4GB)
  ansible.builtin.command: fallocate -l 4G /swapfile
  when: not swap_file.stat.exists

- name: Set swap file permissions
  ansible.builtin.file:
    path: /swapfile
    owner: root
    group: root
    mode: '0600'

- name: Format swap file
  ansible.builtin.command: mkswap /swapfile
  when: not swap_file.stat.exists

- name: Enable swap
  ansible.builtin.command: swapon /swapfile
  when: not swap_file.stat.exists

- name: Persist swap in fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: '/swapfile none swap sw 0 0'
    state: present

- name: Set swappiness to 10 (prefer RAM, but use swap when needed)
  ansible.posix.sysctl:
    name: vm.swappiness
    value: '10'
    state: present

- name: Set vfs_cache_pressure to 50
  ansible.posix.sysctl:
    name: vm.vfs_cache_pressure
    value: '50'
    state: present

# --- Firewall ---

- name: Setup UFW
  community.general.ufw:
    state: enabled
    policy: deny
    direction: incoming

- name: Allow SSH
  community.general.ufw:
    rule: allow
    name: OpenSSH

- name: Allow HTTP
  community.general.ufw:
    rule: allow
    port: '80'
    proto: tcp

- name: Allow HTTPS
  community.general.ufw:
    rule: allow
    port: '443'
    proto: tcp
