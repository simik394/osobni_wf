---
# CRITICAL: Protect existing Vault/Consul data from being wiped
- name: Check if Consul data directory exists (protection against data loss)
  ansible.builtin.stat:
    path: /opt/consul/data
  register: consul_data_dir

- name: Check if Vault is already initialized
  ansible.builtin.command: vault operator init -status -address=http://127.0.0.1:8200
  register: vault_pre_check
  failed_when: false
  changed_when: false
  when: consul_data_dir.stat.exists
  ignore_errors: true

- name: FAIL-SAFE - Abort if Vault data exists but keys file is missing
  ansible.builtin.fail:
    msg: |
      â›” CRITICAL: Vault is initialized but vault_keys.json is missing!
      This could result in PERMANENT DATA LOSS if we continue.
      Please ensure vault_keys.json exists at: {{ playbook_dir }}/vault_keys.json
      Or manually unseal Vault and backup your secrets before proceeding.
  when:
    - consul_data_dir.stat.exists
    - vault_pre_check.rc is defined
    - vault_pre_check.rc == 0
    - not (lookup('file', playbook_dir + '/vault_keys.json', errors='ignore') | default('', true))

- name: Add HashiCorp GPG key
  ansible.builtin.shell: |
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg

- name: Add HashiCorp repository
  ansible.builtin.shell: |
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
  args:
    creates: /etc/apt/sources.list.d/hashicorp.list

- name: Install Consul, Vault, Nomad
  ansible.builtin.apt:
    name:
      - consul
      - vault
      - nomad
    state: present
    update_cache: yes

- name: Create CNI Plugin Directory
  ansible.builtin.file:
    path: /opt/cni/bin
    state: directory
    mode: "0755"

- name: Install CNI Plugins
  ansible.builtin.unarchive:
    src: "https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}-v1.3.0.tgz"
    dest: /opt/cni/bin
    remote_src: yes
    creates: /opt/cni/bin/bridge

- name: Load br_netfilter module
  community.general.modprobe:
    name: br_netfilter
    state: present

- name: Ensure br_netfilter is loaded on boot
  ansible.builtin.copy:
    content: "br_netfilter"
    dest: /etc/modules-load.d/br_netfilter.conf
    mode: "0644"

- name: Configure Bridge Network Traffic
  ansible.posix.sysctl:
    name: net.bridge.bridge-nf-call-iptables
    value: "1"
    state: present
    sysctl_file: /etc/sysctl.d/bridge.conf
    reload: yes

- name: Create Consul data directory
  ansible.builtin.file:
    path: /opt/consul
    state: directory
    owner: consul
    group: consul
    mode: "0755"

- name: Create Vault data directory
  ansible.builtin.file:
    path: /opt/vault
    state: directory
    owner: vault
    group: vault
    mode: "0755"

- name: Create Nomad data directory
  ansible.builtin.file:
    path: /opt/nomad
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Get Tailscale IP
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip
  changed_when: false
  failed_when: false

- name: Set Bind IP Fact
  ansible.builtin.set_fact:
    bind_ip: "{{ tailscale_ip.stdout | default(ansible_default_ipv4.address) }}"

- name: Configure Consul
  ansible.builtin.copy:
    dest: /etc/consul.d/consul.hcl
    content: |
      datacenter = "{{ nomad_datacenter | default('dc1') }}"
      data_dir = "/opt/consul"
      log_level = "INFO"
      node_name = "{{ inventory_hostname }}"
      server = true

      # Always bootstrap self as we are independent regions
      bootstrap_expect = 1

      bind_addr = "{{ bind_ip }}"
      client_addr = "0.0.0.0"
      advertise_addr = "{{ bind_ip }}"

      # WAN Joining (Federation)
      retry_join_wan = ["{{ wan_peer | default('') }}"]

      ui_config {
        enabled = true
      }
      connect {
        enabled = true
      }
      ports {
        grpc = 8502
      }
  notify: Restart Consul

- name: Configure Vault
  ansible.builtin.copy:
    dest: /etc/vault.d/vault.hcl
    content: |
      ui = true
      storage "consul" {
        address = "127.0.0.1:8500"
        path    = "vault/"
      }
      listener "tcp" {
        address     = "0.0.0.0:8200"
        tls_disable = 1
      }
      api_addr = "http://{{ bind_ip }}:8200"
      cluster_addr = "http://{{ bind_ip }}:8201"
  notify: Restart Vault

- name: Configure Nomad
  ansible.builtin.copy:
    dest: /etc/nomad.d/nomad.hcl
    content: |
      datacenter = "{{ nomad_datacenter | default('dc1') }}"
      region     = "{{ nomad_region | default('global') }}"
      data_dir = "/opt/nomad"
      bind_addr = "0.0.0.0"

      server {
        enabled = true
        bootstrap_expect = 1

        # Federation: Join other servers via WAN (Tailscale)
        server_join {
          retry_join = ["{{ wan_peer | default('') }}"]
        }
      }

      client {
        enabled = true
        network_interface = "{{ ansible_default_ipv4.interface }}"
        node_class = "{{ node_class | default('unknown') }}"
        meta {
          connect.sidecar_image = "envoyproxy/envoy:v1.25.1"
        }
        # Host volumes must be defined here if using host_volume stanza
        # But we are using docker binds in job files, so this is optional unless we switch.
      }

      plugin "docker" {
        config {
          allow_privileged = true
          volumes {
            enabled = true
          }
        }
      }

      consul {
        address = "127.0.0.1:8500"
      }

      vault {
        enabled = true
        address = "http://127.0.0.1:8200"
      }

      advertise {
        http = "{{ bind_ip }}"
        rpc  = "{{ bind_ip }}"
        serf = "{{ bind_ip }}"
      }
  notify: Restart Nomad

- name: Start Consul
  ansible.builtin.systemd:
    name: consul
    enabled: yes
    state: started

- name: Wait for Consul (Timeout 30s)
  ansible.builtin.wait_for:
    port: 8500
    delay: 2
    timeout: 30

- name: Start Vault
  ansible.builtin.systemd:
    name: vault
    enabled: yes
    state: started

- name: Wait for Vault (Timeout 30s)
  ansible.builtin.wait_for:
    port: 8200
    delay: 2
    timeout: 30

- name: Start Nomad
  ansible.builtin.systemd:
    name: nomad
    enabled: yes
    state: started

- name: Wait for Nomad (Timeout 30s)
  ansible.builtin.wait_for:
    port: 4646
    delay: 2
    timeout: 30

# --- Automated Vault Initialization & Unseal ---

- name: Check Vault initialization status
  ansible.builtin.command: vault operator init -status -address=http://127.0.0.1:8200
  register: vault_init_status
  failed_when: vault_init_status.rc not in [0, 2]
  changed_when: false
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"

- name: Initialize Vault (if not initialized)
  block:
    - name: Run Vault Init
      ansible.builtin.command: vault operator init -key-shares=1 -key-threshold=1 -format=json -address=http://127.0.0.1:8200
      register: vault_init_output
      environment:
        VAULT_ADDR: "http://127.0.0.1:8200"

    - name: Save Vault Keys to Local File
      ansible.builtin.copy:
        content: "{{ vault_init_output.stdout }}"
        dest: "./vault_keys.json"
        mode: "0600"
      delegate_to: localhost
      become: false

    - name: Set facts for unsealing (newly initialized)
      ansible.builtin.set_fact:
        vault_unseal_key: "{{ (vault_init_output.stdout | from_json).unseal_keys_b64[0] }}"
        vault_root_token: "{{ (vault_init_output.stdout | from_json).root_token }}"

  when: vault_init_status.rc == 2

- name: Check Vault seal status
  ansible.builtin.command: vault status -format=json -address=http://127.0.0.1:8200
  register: vault_seal_status
  failed_when: false
  changed_when: false
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"

- name: Read Vault keys from local file (if existing)
  block:
    - name: Check if vault_keys.json exists locally
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/vault_keys.json"
      delegate_to: localhost
      become: false
      register: vault_keys_stat

    - name: Read keys file
      ansible.builtin.slurp:
        src: "{{ playbook_dir }}/vault_keys.json"
      delegate_to: localhost
      become: false
      register: vault_keys_file
      when: vault_keys_stat.stat.exists

    - name: Set facts for unsealing (from file)
      ansible.builtin.set_fact:
        vault_unseal_key: "{{ (vault_keys_file.content | b64decode | from_json).unseal_keys_b64[0] }}"
      when: vault_keys_stat.stat.exists

    - name: Warn if vault_keys.json not found
      ansible.builtin.debug:
        msg: "WARNING: vault_keys.json not found at {{ playbook_dir }}/vault_keys.json - Vault cannot be auto-unsealed"
      when: not vault_keys_stat.stat.exists

  when:
    - vault_init_status.rc == 0
    - (vault_seal_status.stdout | from_json).sealed == true
    - vault_unseal_key is not defined

- name: Unseal Vault
  ansible.builtin.command: "vault operator unseal -address=http://127.0.0.1:8200 {{ vault_unseal_key }}"
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  when:
    - (vault_seal_status.stdout | from_json).sealed == true
    - vault_unseal_key is defined
  register: unseal_result

- name: Display Root Token (Only if newly initialized)
  ansible.builtin.debug:
    msg: "Vault Root Token: {{ vault_root_token }}"
  when: vault_root_token is defined
