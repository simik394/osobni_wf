---
- name: Add HashiCorp GPG key
  ansible.builtin.shell: |
    wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
  args:
    creates: /usr/share/keyrings/hashicorp-archive-keyring.gpg

- name: Add HashiCorp repository
  ansible.builtin.shell: |
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
  args:
    creates: /etc/apt/sources.list.d/hashicorp.list

- name: Install Consul, Vault, Nomad
  ansible.builtin.apt:
    name:
      - consul
      - vault
      - nomad
    state: present
    update_cache: yes

- name: Create data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/consul
    - /opt/vault
    - /opt/nomad

- name: Get Tailscale IP
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip
  changed_when: false
  failed_when: false

- name: Set Bind IP Fact
  ansible.builtin.set_fact:
    bind_ip: "{{ tailscale_ip.stdout | default(ansible_default_ipv4.address) }}"

- name: Configure Consul
  ansible.builtin.copy:
    dest: /etc/consul.d/consul.hcl
    content: |
      datacenter = "dc1"
      data_dir = "/opt/consul"
      log_level = "INFO"
      node_name = "{{ inventory_hostname }}"
      server = true

      # Bootstrap only on the cloud server
      {% if nomad_role == 'server' %}
      bootstrap_expect = 1
      {% else %}
      retry_join = ["halvarm"]
      {% endif %}

      bind_addr = "{{ bind_ip }}"
      client_addr = "0.0.0.0"
      advertise_addr = "{{ bind_ip }}"

      ui_config {
        enabled = true
      }
      connect {
        enabled = true
      }
      ports {
        grpc = 8502
      }
  notify: Restart Consul

- name: Configure Vault
  ansible.builtin.copy:
    dest: /etc/vault.d/vault.hcl
    content: |
      ui = true
      storage "consul" {
        address = "127.0.0.1:8500"
        path    = "vault/"
      }
      listener "tcp" {
        address     = "0.0.0.0:8200"
        tls_disable = 1
      }
      api_addr = "http://{{ bind_ip }}:8200"
      cluster_addr = "http://{{ bind_ip }}:8201"
  notify: Restart Vault

- name: Configure Nomad
  ansible.builtin.copy:
    dest: /etc/nomad.d/nomad.hcl
    content: |
      datacenter = "dc1"
      data_dir = "/opt/nomad"
      bind_addr = "0.0.0.0"

      server {
        enabled = true

        {% if nomad_role == 'server' %}
        bootstrap_expect = 1
        {% endif %}

        {% if nomad_role == 'non_voting_server' %}
        non_voting_server = true
        server_join {
          retry_join = ["halvarm"]
        }
        {% endif %}
      }

      client {
        enabled = true
        network_interface = "{{ ansible_default_ipv4.interface }}" # Use physical interface for bridge networking
        node_class = "{{ node_class }}"
        meta {
          connect.sidecar_image = "envoyproxy/envoy:v1.25.1"
        }
      }

      plugin "docker" {
        config {
          allow_privileged = true
        }
      }

      consul {
        address = "127.0.0.1:8500"
      }

      vault {
        enabled = true
        address = "http://127.0.0.1:8200"
      }

      advertise {
        http = "{{ bind_ip }}"
        rpc  = "{{ bind_ip }}"
        serf = "{{ bind_ip }}"
      }
  notify: Restart Nomad

- name: Enable and start services
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - consul
    - vault
    - nomad

- name: Wait for Consul to start
  ansible.builtin.wait_for:
    port: 8500
    delay: 5

- name: Wait for Vault to start
  ansible.builtin.wait_for:
    port: 8200
    delay: 5

- name: Wait for Nomad to start
  ansible.builtin.wait_for:
    port: 4646
    delay: 5

# --- Automated Vault Initialization & Unseal ---

- name: Check Vault initialization status
  ansible.builtin.command: vault operator init -status -address=http://127.0.0.1:8200
  register: vault_init_status
  failed_when: vault_init_status.rc not in [0, 2]
  changed_when: false
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"

- name: Initialize Vault (if not initialized)
  block:
    - name: Run Vault Init
      ansible.builtin.command: vault operator init -key-shares=1 -key-threshold=1 -format=json -address=http://127.0.0.1:8200
      register: vault_init_output
      environment:
        VAULT_ADDR: "http://127.0.0.1:8200"

    - name: Save Vault Keys to Local File
      ansible.builtin.copy:
        content: "{{ vault_init_output.stdout }}"
        dest: "./vault_keys.json"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Set facts for unsealing (newly initialized)
      ansible.builtin.set_fact:
        vault_unseal_key: "{{ (vault_init_output.stdout | from_json).unseal_keys_b64[0] }}"
        vault_root_token: "{{ (vault_init_output.stdout | from_json).root_token }}"

  when: vault_init_status.rc == 2

- name: Check Vault seal status
  ansible.builtin.command: vault status -format=json -address=http://127.0.0.1:8200
  register: vault_seal_status
  failed_when: false
  changed_when: false
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"

- name: Read Vault keys from local file (if existing)
  block:
    - name: Read keys file
      ansible.builtin.command: cat ./vault_keys.json
      delegate_to: localhost
      become: false
      register: vault_keys_file
      changed_when: false

    - name: Set facts for unsealing (from file)
      ansible.builtin.set_fact:
        vault_unseal_key: "{{ (vault_keys_file.stdout | from_json).unseal_keys_b64[0] }}"

  when:
    - vault_init_status.rc == 0
    - (vault_seal_status.stdout | from_json).sealed == true
    - vault_unseal_key is not defined

- name: Unseal Vault
  ansible.builtin.command: "vault operator unseal -address=http://127.0.0.1:8200 {{ vault_unseal_key }}"
  environment:
    VAULT_ADDR: "http://127.0.0.1:8200"
  when:
    - (vault_seal_status.stdout | from_json).sealed == true
    - vault_unseal_key is defined
  register: unseal_result

- name: Display Root Token (Only if newly initialized)
  ansible.builtin.debug:
    msg: "Vault Root Token: {{ vault_root_token }}"
  when: vault_root_token is defined
