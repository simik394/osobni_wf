---
- name: Create local install directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ ansible_env.HOME }}/.local/bin"
    - "{{ ansible_env.HOME }}/.local/opt"
    - "{{ ansible_env.HOME }}/.config/ghostty"

- name: Check current Zig version
  command: "{{ ansible_env.HOME }}/.local/opt/zig/zig version"
  register: current_zig_version
  ignore_errors: yes
  changed_when: false

- name: Download Zig
  unarchive:
    src: "https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz"
    dest: "{{ ansible_env.HOME }}/.local/opt"
    remote_src: yes
    creates: "{{ ansible_env.HOME }}/.local/opt/zig-linux-x86_64-0.13.0"
  when: "current_zig_version.rc != 0 or '0.13.0' not in current_zig_version.stdout"

- name: Symlink Zig folder
  file:
    src: "{{ ansible_env.HOME }}/.local/opt/zig-linux-x86_64-0.13.0"
    dest: "{{ ansible_env.HOME }}/.local/opt/zig"
    state: link

- name: Clone Ghostty repository
  git:
    repo: "https://github.com/ghostty-org/ghostty"
    dest: "{{ ansible_env.HOME }}/.local/opt/ghostty-src"
    version: "v1.1.3"
    depth: 1
    force: yes

- name: Build and Install Ghostty (Native)
  shell: |
    {{ ansible_env.HOME }}/.local/opt/zig/zig build \
      -p {{ ansible_env.HOME }}/.local \
      -Doptimize=ReleaseFast
  args:
    chdir: "{{ ansible_env.HOME }}/.local/opt/ghostty-src"
  changed_when: true

- name: Rename Ghostty binary to ghostty.bin (for Wrapper)
  command: mv {{ ansible_env.HOME }}/.local/bin/ghostty {{ ansible_env.HOME }}/.local/bin/ghostty.bin
  args:
    creates: "{{ ansible_env.HOME }}/.local/bin/ghostty.bin"
  # Only run if ghostty exists and ghostty.bin does not

- name: Create Ghostty Wrapper Script (Nvidia Fix)
  copy:
    dest: "{{ ansible_env.HOME }}/.local/bin/ghostty"
    mode: "0755"
    content: |
      #!/bin/bash
      exec env GSK_RENDERER=gl __GL_SYNC_TO_VBLANK=0 {{ ansible_env.HOME }}/.local/bin/ghostty.bin "$@"

- name: Configure Ghostty
  template:
    src: config.j2
    dest: "{{ ansible_env.HOME }}/.config/ghostty/config"
    mode: "0644"

- name: Patch Ghostty Desktop Entry (Nvidia Fixes)
  lineinfile:
    path: "{{ ansible_env.HOME }}/.local/share/applications/com.mitchellh.ghostty.desktop"
    regexp: "^Exec=.*"
    line: "Exec=env GSK_RENDERER=gl __GL_SYNC_TO_VBLANK=0 {{ ansible_env.HOME }}/.local/bin/ghostty"

- name: Update desktop database
  command: update-desktop-database {{ ansible_env.HOME }}/.local/share/applications
