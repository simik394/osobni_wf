---
- name: Add OBS Studio PPA
  apt_repository:
    repo: ppa:obsproject/obs-studio
    state: present
  become: true

- name: Install OBS Studio
  apt:
    name: obs-studio
    state: present
    update_cache: yes
  become: true

- name: Ensure user plugins directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/obs-studio/plugins"
    state: directory
    mode: "0755"

- name: Check if Source Record plugin is already installed
  stat:
    path: "{{ ansible_env.HOME }}/.config/obs-studio/plugins/source-record/bin/64bit/source-record.so"
  register: plugin_so

- name: Install Source Record plugin
  block:
    - name: Create temporary directory for plugin
      tempfile:
        state: directory
        suffix: obs_plugin
      register: plugin_temp_dir

    - name: Download Source Record plugin zip
      get_url:
        url: "https://github.com/Exeldro/obs-source-record/releases/download/0.4.6/obs-source-record-0.4.6-linux-x86_64.zip"
        dest: "{{ plugin_temp_dir.path }}/source-record.zip"

    - name: Unarchive zip (contains tar.gz inside)
      unarchive:
        src: "{{ plugin_temp_dir.path }}/source-record.zip"
        dest: "{{ plugin_temp_dir.path }}"
        remote_src: yes

    - name: Find the tar.gz file inside the extracted zip
      find:
        paths: "{{ plugin_temp_dir.path }}"
        patterns: "*.tar.gz"
      register: found_tarball

    - name: Extract the tar.gz archive
      unarchive:
        src: "{{ found_tarball.files[0].path }}"
        dest: "{{ plugin_temp_dir.path }}"
        remote_src: yes
      when: found_tarball.files | length > 0

    - name: Create plugin directory structure
      file:
        path: "{{ ansible_env.HOME }}/.config/obs-studio/plugins/source-record"
        state: directory
        mode: "0755"

    - name: Copy plugin bin directory
      copy:
        src: "{{ plugin_temp_dir.path }}/bin/"
        dest: "{{ ansible_env.HOME }}/.config/obs-studio/plugins/source-record/bin/"
        mode: "0755"
        remote_src: yes

    - name: Copy plugin data directory
      copy:
        src: "{{ plugin_temp_dir.path }}/data/"
        dest: "{{ ansible_env.HOME }}/.config/obs-studio/plugins/source-record/data/"
        mode: "0644"
        remote_src: yes

    - name: Clean up temporary directory
      file:
        path: "{{ plugin_temp_dir.path }}"
        state: absent
  when: not plugin_so.stat.exists

# ============================================
# DATETIME LUA SCRIPT FOR DIGITAL CLOCK OVERLAY
# ============================================

- name: Ensure user scripts directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/obs-studio/scripts"
    state: directory
    mode: "0755"

- name: Download datetime Lua script for digital clock overlay
  get_url:
    url: "https://raw.githubusercontent.com/Kershoc/obs-script-datetime/refs/heads/master/DateTimeMultiple.lua"
    dest: "{{ ansible_env.HOME }}/.config/obs-studio/scripts/DateTimeMultiple.lua"
    mode: "0644"

# ============================================
# ONE-CLICK RECORDING AUTOMATION
# ============================================

- name: Create start_recording.sh script
  copy:
    dest: "{{ ansible_env.HOME }}/bin/start_recording.sh"
    mode: "0755"
    content: |
      #!/bin/bash
      # OBS Studio One-Click Recording Launcher
      # Starts OBS with recording active and minimized to tray
      
      # Kill any existing OBS instance (optional - uncomment if needed)
      # pkill -x obs || true
      
      # Start OBS with recording and minimize to tray
      obs --startrecording --minimize-to-tray &
      
      echo "OBS recording started. Check system tray."

- name: Ensure ~/bin is in PATH (add to .bashrc if not present)
  lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$HOME/bin:$PATH"'
    state: present
    create: yes

- name: Create desktop shortcut for OBS Recording
  copy:
    dest: "{{ ansible_env.HOME }}/.local/share/applications/obs-recording.desktop"
    mode: "0644"
    content: |
      [Desktop Entry]
      Version=1.0
      Type=Application
      Name=OBS Recording
      Comment=Start OBS with recording active
      Exec={{ ansible_env.HOME }}/bin/start_recording.sh
      Icon=com.obsproject.Studio
      Terminal=false
      Categories=AudioVideo;Recorder;
      StartupNotify=false
