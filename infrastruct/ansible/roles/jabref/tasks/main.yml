---
- name: Create local install directory
  file:
    path: "{{ ansible_env.HOME }}/.local/opt/jabref-v6"
    state: directory
    mode: "0755"

- name: Download JabRef v6 Portable
  unarchive:
    src: "https://builds.jabref.org/main/JabRef-portable_linux.tar.gz"
    dest: "{{ ansible_env.HOME }}/.local/opt/jabref-v6"
    remote_src: yes
    extra_opts: [--strip-components=1]
    creates: "{{ ansible_env.HOME }}/.local/opt/jabref-v6/bin/JabRef"

- name: Create symlink in ~/.local/bin
  file:
    src: "{{ ansible_env.HOME }}/.local/opt/jabref-v6/bin/JabRef"
    dest: "{{ ansible_env.HOME }}/.local/bin/jabref"
    state: link
    mode: "0755"
    force: yes

- name: Install Desktop entry
  copy:
    dest: "{{ ansible_env.HOME }}/.local/share/applications/jabref.desktop"
    mode: "0644"
    content: |
      [Desktop Entry]
      Name=JabRef
      GenericName=BibTeX Editor
      Comment=A portable JabRef v6 installation
      Exec={{ ansible_env.HOME }}/.local/bin/jabref
      Icon={{ ansible_env.HOME }}/.local/opt/jabref-v6/lib/JabRef.png
      Terminal=false
      Type=Application
      Categories=Office;Bibliography;
      StartupNotify=true
      MimeType=text/x-bibtex;

- name: Update desktop database
  command: update-desktop-database {{ ansible_env.HOME }}/.local/share/applications

- name: Ensure JabRef is closed (to write prefs)
  shell: "ps aux | grep '[o]rg.jabref' | awk '{print $2}' | xargs -r kill || true"
  changed_when: false

- name: Ensure shared prefs directory exists
  file:
    path: "{{ ansible_env.HOME }}/.java/.userPrefs/org/jabref-shared/default"
    state: directory
    mode: "0700"

- name: Deploy Shared Database Preferences
  template:
    src: jabref_shared_prefs.xml.j2
    dest: "{{ ansible_env.HOME }}/.java/.userPrefs/org/jabref-shared/default/prefs.xml"
    mode: "0600"
