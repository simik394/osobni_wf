---
# x11vnc installation role
# Sets up VNC server for remote desktop access

- name: Install x11vnc and dependencies
  apt:
    name:
      - x11vnc
      - net-tools
    state: present
  become: true

- name: Create VNC password directory
  file:
    path: "{{ ansible_env.HOME }}/.vnc"
    state: directory
    mode: "0700"

- name: Check if VNC password exists
  stat:
    path: "{{ ansible_env.HOME }}/.vnc/passwd"
  register: vnc_passwd_file

- name: Generate VNC password file
  shell: |
    x11vnc -storepasswd "{{ vnc_password }}" "{{ ansible_env.HOME }}/.vnc/passwd"
  when: not vnc_passwd_file.stat.exists
  no_log: true

- name: Allow VNC through firewall (UFW)
  ufw:
    rule: allow
    port: "{{ vnc_port }}"
    proto: tcp
    comment: "Allow x11vnc"
  become: true
  ignore_errors: true

- name: Allow VNC specifically from Tailscale interface
  shell: |
    ufw allow in on tailscale0 to any port {{ vnc_port }} || true
  become: true
  ignore_errors: true

- name: Create user-level x11vnc systemd service directory
  file:
    path: "{{ ansible_env.HOME }}/.config/systemd/user"
    state: directory
    mode: "0755"

- name: Create user-level x11vnc service (runs as logged-in user)
  copy:
    dest: "{{ ansible_env.HOME }}/.config/systemd/user/x11vnc.service"
    mode: "0644"
    content: |
      [Unit]
      Description=x11vnc VNC Server (User Session)
      After=graphical-session.target

      [Service]
      Type=simple
      Environment=DISPLAY=:0
      Environment=XAUTHORITY=/run/user/{{ ansible_user_uid }}/gdm/Xauthority
      ExecStart=/usr/bin/x11vnc -display :0 -auth /run/user/{{ ansible_user_uid }}/gdm/Xauthority -forever -noxdamage -repeat -rfbauth {{ ansible_env.HOME }}/.vnc/passwd -rfbport {{ vnc_port }} -shared
      ExecStop=/usr/bin/killall x11vnc
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=default.target

- name: Stop system-level x11vnc if exists
  systemd:
    name: x11vnc
    state: stopped
    enabled: false
  become: true
  ignore_errors: true

- name: Remove old system-level service
  file:
    path: /etc/systemd/system/x11vnc.service
    state: absent
  become: true

- name: Enable user service linger (to start at boot)
  command: loginctl enable-linger {{ ansible_user_id }}
  become: true
  changed_when: false

- name: Reload user systemd daemon
  systemd:
    daemon_reload: true
    scope: user

- name: Enable and start user-level x11vnc service
  systemd:
    name: x11vnc
    enabled: true
    state: started
    scope: user

- name: Display connection info
  debug:
    msg: |
      VNC server configured as USER SERVICE!

      Connect via Tailscale (Secure):
      Address: 100.92.153.10:{{ vnc_port }}

      Connect via Local Network:
      Address: {{ ansible_default_ipv4.address | default('YOUR_IP') }}:{{ vnc_port }}

      Password: (the one you configured)
