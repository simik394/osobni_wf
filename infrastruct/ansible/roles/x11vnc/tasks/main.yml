---
# x11vnc installation role
# Sets up VNC server for remote desktop access

- name: Install x11vnc and dependencies
  apt:
    name:
      - x11vnc
      - net-tools
    state: present
  become: true

- name: Create VNC password directory
  file:
    path: "{{ ansible_env.HOME }}/.vnc"
    state: directory
    mode: "0700"

- name: Check if VNC password exists
  stat:
    path: "{{ ansible_env.HOME }}/.vnc/passwd"
  register: vnc_passwd_file

- name: Generate VNC password file
  shell: |
    x11vnc -storepasswd "{{ vnc_password }}" "{{ ansible_env.HOME }}/.vnc/passwd"
  when: not vnc_passwd_file.stat.exists
  no_log: true

- name: Get User UID
  command: id -u "{{ ansible_user_id }}"
  register: user_uid
  changed_when: false

- name: Create x11vnc systemd service
  copy:
    dest: /etc/systemd/system/x11vnc.service
    mode: "0644"
    content: |
      [Unit]
      Description=x11vnc VNC Server
      After=display-manager.service network.target

      [Service]
      Type=simple
      # Explicitly pointing to GDM Xauthority for the user
      ExecStart=/usr/bin/x11vnc -display :0 -auth /run/user/{{ user_uid.stdout }}/gdm/Xauthority -forever -loop -noxdamage -repeat -rfbauth {{ ansible_env.HOME }}/.vnc/passwd -rfbport {{ vnc_port }} -shared
      ExecStop=/usr/bin/killall x11vnc
      Restart=on-failure
      RestartSec=3

      [Install]
      WantedBy=multi-user.target
  become: true
  notify: restart x11vnc

- name: Enable and start x11vnc service
  systemd:
    name: x11vnc
    enabled: true
    state: started
    daemon_reload: true
  become: true

- name: Display connection info
  debug:
    msg: |
      VNC server configured!
      Connect from Android using any VNC client (e.g., bVNC, RealVNC Viewer)
      Address: {{ ansible_default_ipv4.address | default('YOUR_IP') }}:{{ vnc_port }}
      Password: (the one you configured)

      NOTE: Ensure you are logged in to the graphical session for VNC to work.
