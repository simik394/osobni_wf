---
# x11vnc installation role
# Sets up VNC server for remote desktop access

- name: Install x11vnc and dependencies
  apt:
    name:
      - x11vnc
      - net-tools
    state: present
  become: true

- name: Create VNC password directory
  file:
    path: "{{ ansible_env.HOME }}/.vnc"
    state: directory
    mode: "0700"

- name: Check if VNC password exists
  stat:
    path: "{{ ansible_env.HOME }}/.vnc/passwd"
  register: vnc_passwd_file

- name: Generate VNC password file
  shell: |
    x11vnc -storepasswd "{{ vnc_password }}" "{{ ansible_env.HOME }}/.vnc/passwd"
  when: not vnc_passwd_file.stat.exists
  no_log: true

- name: Allow VNC through firewall (UFW)
  ufw:
    rule: allow
    port: "{{ vnc_port }}"
    proto: tcp
    comment: "Allow x11vnc"
  become: true

- name: Allow VNC specifically from Tailscale interface
  shell: |
    ufw allow in on tailscale0 to any port {{ vnc_port }}
  become: true
  ignore_errors: true

- name: Create x11vnc systemd service
  copy:
    dest: /etc/systemd/system/x11vnc.service
    mode: "0644"
    content: |
      [Unit]
      Description=x11vnc VNC Server
      After=display-manager.service network.target

      [Service]
      Type=simple
      # -findauth is smarter than hardcoded paths or simple "guess"
      # -display :0 is usually correct for the main session
      ExecStart=/usr/bin/x11vnc -display :0 -findauth -forever -loop -noxdamage -repeat -rfbauth {{ ansible_env.HOME }}/.vnc/passwd -rfbport {{ vnc_port }} -shared
      ExecStop=/usr/bin/killall x11vnc
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target
  become: true
  notify: restart x11vnc

- name: Enable and start x11vnc service
  systemd:
    name: x11vnc
    enabled: true
    state: started
    daemon_reload: true
  become: true

- name: Display connection info
  debug:
    msg: |
      VNC server configured using -findauth!

      Connect via Tailscale (Secure):
      Address: 100.92.153.10:{{ vnc_port }}
      Password: (the one you configured)

      Connect via Local Network:
      Address: {{ ansible_default_ipv4.address }}:{{ vnc_port }}
